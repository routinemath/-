<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ì‹œí—˜ ëŒ€ë¹„ ì˜¤ë‹µ í’€ì´ ìƒì„±ê¸°</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#667eea">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: 'Malgun Gothic', sans-serif; background: #f0f0f0; }
        .control-panel { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .control-panel h2 { margin-top: 0; color: #333; }
        
        .student-section { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .student-section select, .student-section input { padding: 8px; font-size: 14px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; }
        
        .dashboard { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .dashboard h3 { margin: 0 0 15px 0; }
        .level-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 15px 0; }
        .level-card { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; text-align: center; }
        .level-card .label { font-size: 14px; opacity: 0.9; margin-bottom: 5px; }
        .level-card .count { font-size: 32px; font-weight: bold; }
        
        .control-group { margin-bottom: 15px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .control-group input[type="text"], .control-group input[type="number"] { padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .btn { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-danger { background: #f44336; }
        .btn-export { background: #607D8B; }
        
        .status { margin-top: 10px; padding: 10px; background: #e8f5e9; border-left: 4px solid #4CAF50; display: none; }
        
        @/* í˜ì´ì§€ ì„¤ì • */
@page { 
    size: A4 portrait; 
    margin: 6mm; 
}

#quizSheet { 
    background: white; 
    max-width: 210mm; 
    margin: 20px auto; 
    box-shadow: 0 0 10px rgba(0,0,0,0.1); 
}

/* ì²« í˜ì´ì§€ */
/* Ã¬Â²Â« Ã­Å½ËœÃ¬Â´Ã¬Â§â‚¬ */
.first-page {
    min-height: 297mm;
    padding: 3mm;
    page-break-after: always;
}

.exam-header {
    text-align: center;
    margin-bottom: 3mm;
    padding: 2mm 0;
}

.exam-title {
    font-size: 18pt;
    font-weight: bold;
    margin: 0;
}

/* Ã¬Â¼Ã«Â°Ëœ Ã­Å½ËœÃ¬Â´Ã¬Â§â‚¬ */
.exam-page {
    min-height: 297mm;
    padding: 3mm;
    page-break-after: always;
    position: relative;
}

.exam-page:last-child {
    page-break-after: auto;
}

/* 2x2 ÃªÂ·Â¸Ã«Â¦Â¬Ã«"Å“ Ã­â€¦Å’Ã¬Â´Ã«Â¸" */
.problem-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    grid-template-rows: repeat(2, 1fr);
    gap: 3mm;
    height: 280mm;
    width: 100%;
}

.first-page .problem-grid {
    height: 260mm;
}

/* ğŸ†• 2ë¬¸ì œ ì¢Œìš° 2ë‹¨ ë ˆì´ì•„ì›ƒ (ìˆ˜ëŠ¥ ìˆ˜í•™ ì‹œí—˜ì§€ ìŠ¤íƒ€ì¼) */
.problem-grid.two-column {
    grid-template-columns: 1fr 1fr;
    grid-template-rows: 1fr;
    gap: 5mm;
    height: 280mm;
}

.first-page .problem-grid.two-column {
    height: 260mm;
}

/* 2ë‹¨ ë ˆì´ì•„ì›ƒìš© ë¬¸ì œ ì…€ */
.problem-grid.two-column .problem-cell {
    border: none;
}

.problem-grid.two-column .problem-cell:first-child {
    border-right: none;
}

.problem-grid.two-column .problem-cell:last-child {
    border-left: none;
}
.problem-grid.two-column .problem-cell:last-child {
    border-left: 1px solid #333;
}

/* 2ë‹¨ ë ˆì´ì•„ì›ƒì—ì„œ ì´ë¯¸ì§€ í¬ê²Œ */
.problem-grid.two-column .image-container {
    max-height: none;
    flex: 1;
    padding: 3mm;
}

.problem-grid.two-column .problem-image {
    max-height: none;
    height: auto;
    max-width: 100%;
}

/* 2ë‹¨ ë ˆì´ì•„ì›ƒì—ì„œ í’€ì´ ë¼ë²¨ ìˆ¨ê¹€ */
.problem-grid.two-column .solution-label {
    display: none;
}

/* ğŸ†• ë™ì  ë ˆì´ì•„ì›ƒ ì¶”ê°€ */
.problem-cell.tall-cell {
    grid-row: span 2; /* ì„¸ë¡œ 2ì¹¸ ì°¨ì§€ */
}

.tall-cell .image-container {
    max-height: none !important;
    flex: 1;
}

.tall-cell .problem-image {
    max-height: none !important;
    height: auto;
}

.problem-cell.empty-cell {
    border: none !important;
}

/* Ã«Â¬Â¸Ã¬ Å“ Ã¬â€¦â‚¬ */
.problem-cell {
    border: 1px solid #333;
    border-left: none;
    border-right: none;
    display: flex;
    flex-direction: column;
    position: relative;
    background: white;
    overflow: hidden;
}
/* Ã«Â¬Â¸Ã¬ Å“ Ã­â€”Â¤Ã«" (Ã«Â²Ë†Ã­ËœÂ¸ + Ã­Å’Å’Ã¬Â¼Ã«Âªâ€¦) */
.problem-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2mm;
    border-bottom: 1px solid #ddd;
    background: #f9f9f9;
    min-height: 8mm;
}

.problem-header .number {
    font-weight: bold;
    font-size: 11pt;
}

.problem-header .filename {
    font-size: 8pt;
    color: #666;
    max-width: 60%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

/* Ã¬Â´Ã«Â¯Â¸Ã¬Â§â‚¬ Ã¬ËœÃ¬â€”Â­ */
.image-container {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 2mm;
    max-height: 50mm;
    overflow: hidden;
}

.problem-image {
    max-width: 100%;
    max-height: 48mm;
    object-fit: contain;
}

/* Ã­'â‚¬Ã¬Â´ ÃªÂ³ÂµÃªÂ°â€ */
.solution-area {
    flex: 1;
    padding: 2mm;
    display: flex;
    flex-direction: column;
}

.solution-label {
    font-size: 9pt;
    color: #999;
    margin-bottom: 2mm;
    font-weight: bold;
}

/* Ã¬ â€¢Ã«â€¹ÂµÃ¬Â²Â´Ã­Â¬ Ã«Â²â€Ã­Å Â¼ */
.answer-check {
    position: absolute;
    top: 2mm;
    right: 2mm;
    display: flex;
    gap: 2px;
    z-index: 21;
}

.check-btn {
    padding: 2px 6px;
    font-size: 9px;
    border: 1px solid #ccc;
    border-radius: 3px;
    cursor: pointer;
    background: white;
}

/* Ã¬Â¸Ã¬â€¡â€ Ã¬â€¹Å“ */
@media print {
    #quizSheet { 
        margin: 0; 
        box-shadow: none; 
    }
    .answer-check { 
        display: none !important; 
    }
    .exam-page, .first-page {
        min-height: auto;
        padding: 3mm;
    }
    .exam-header {
        padding: 2mm 0;
        margin-bottom: 3mm;
    }
    .exam-title {
        font-size: 16pt;
    }
    .problem-grid {
        gap: 2mm;
    }
}

/* QR ì½”ë“œ ì˜ì—­ */
.qr-section {
    text-align: center;
    padding: 4mm 2mm;
    border-top: 1px dashed #999;
    margin-top: 3mm;
}
.qr-section p {
    font-size: 8pt;
    color: #555;
    margin: 2mm 0 0 0;
}
.qr-code-container {
    display: inline-block;
}
.qr-code-container canvas,
.qr-code-container img {
    width: 22mm !important;
    height: 22mm !important;
}
@media print {
    .qr-section { display: block !important; }
}

/* ë ˆë²¨ ë±ƒì§€ - ë¬¸ì œë²ˆí˜¸ ì˜†ì— ì‘ê²Œ */
.level-badge {
    display: inline-block;
    margin-left: 5px;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 9pt;
    font-weight: normal;
}

/* ì •ë‹µì²´í¬ ë²„íŠ¼ - ë¬¸ì œ ìš°ì¸¡ ìƒë‹¨ */
.answer-check {
    position: absolute;
    top: 6px;
    right: 6px;
    display: flex;
    gap: 3px;
    z-index: 21;
}

.check-btn {
    padding: 3px 8px;
    font-size: 10px;
    border: 1px solid #ccc;
    border-radius: 3px;
    cursor: pointer;
    background: white;
}

.check-btn:hover { opacity: 0.8; }
.check-btn.correct { background: #4CAF50; color: white; border-color: #4CAF50; }
.check-btn.wrong { background: #f44336; color: white; border-color: #f44336; }

.problem-item { 
    display: flex; 
    align-items: center; 
    padding: 8px; 
    border-bottom: 1px solid #ddd; 
}
.problem-item:hover { background: #f5f5f5; }
.problem-item .name { flex: 1; }

/* ì¸ì‡„ ì‹œ í†µí•© ì„¤ì • */
@media print {
    /* í™”ë©´ ìš”ì†Œ ëª¨ë‘ ìˆ¨ê¸°ê¸° */
    .control-panel, .dashboard, .student-section, .answer-check, .level-badge, 
    #status, #problemList, #folderExplorer, #selectedFolders, 
    #gradingListPanel, #gradingPanel, #analysisPanel {
        display: none !important; 
    }
    
    /* ì‹œí—˜ì§€ë§Œ í‘œì‹œ */
    #quizSheet { 
        margin: 0; 
        box-shadow: none;
        max-width: 100%;
    }
    
    .exam-page, .first-page {
        min-height: auto;
        padding: 4mm;
        page-break-after: always;
    }
    
    .exam-page:last-child {
        page-break-after: auto;
    }
    
    .exam-header {
        padding: 2mm 0;
        margin-bottom: 4mm;
    }
    
    .exam-title {
        font-size: 18pt;
    }
    
    .problem-grid {
        gap: 2mm;
    }
}
    </style>
</head>
<body>
    <div class="control-panel">
        <h2>ğŸ¯ ì‹œí—˜ ëŒ€ë¹„ ì˜¤ë‹µ í’€ì´ ìƒì„±ê¸°</h2>
        
        <div class="student-section">
            <strong>ğŸ‘¤ í•™ìƒ:</strong>
            <select id="studentSelect" onchange="switchStudent()">
                <option value="">í•™ìƒ ì„ íƒ</option>
            </select>
            <input type="text" id="newStudentName" placeholder="ìƒˆ í•™ìƒ ì´ë¦„" style="width: 150px;">
            <button class="btn" onclick="addStudent()">â• ì¶”ê°€</button>
            <button class="btn btn-danger" onclick="deleteStudent()">ğŸ—‘ï¸ ì‚­ì œ</button>
        </div>
        
        <div class="dashboard" id="dashboard" style="display:none;">
            <h3>ğŸ“Š <span id="currentStudentName"></span>ë‹˜ì˜ í•™ìŠµ í˜„í™©</h3>
            <div class="level-stats">
                <div class="level-card">
                    <div class="label">âŒ ì·¨ì•½ë¬¸ì œ</div>
                    <div class="count" id="weakCount">0</div>
                </div>
                <div class="level-card">
                    <div class="label">ğŸ”¶ ë³µìŠµí•„ìš”</div>
                    <div class="count" id="reviewCount">0</div>
                </div>
                <div class="level-card">
                    <div class="label">âœ… ì™„ì „ì •ë³µ</div>
                    <div class="count" id="masterCount">0</div>
                </div>
            </div>
        </div>
        
        <div class="control-group">
    <label>ğŸ“ ì´ë¯¸ì§€ í´ë” ì„ íƒ (PNG íŒŒì¼):</label>
    <input type="file" id="folderInput" webkitdirectory directory multiple accept="image/png" style="display:none;">
    <button class="btn" onclick="document.getElementById('folderInput').click()">ğŸ“‚ í´ë” ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn btn-danger" onclick="clearAllFolders()" style="margin-left:5px;">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
    
    <!-- í´ë” êµ¬ì¡° íƒìƒ‰ê¸° -->
    <div id="folderExplorer" style="margin-top:15px; display:none;">
        <div style="background:#f5f5f5; padding:10px; border-radius:5px; margin-bottom:10px;">
            <strong>ğŸ“‚ í´ë” êµ¬ì¡°</strong>
            <span style="float:right; color:#666; font-size:12px;">â–¶ í´ë¦­: í¼ì¹˜ê¸° | í´ë”ëª… í´ë¦­: ì„ íƒ</span>
        </div>
        <div id="folderTree" style="max-height:300px; overflow-y:auto; border:1px solid #ddd; padding:10px; background:white; border-radius:5px;"></div>
    </div>
    <!-- â­ ì—¬ê¸°ì— ìƒˆë¡œìš´ ì½”ë“œ ì¶”ê°€! â­ -->
<div class="control-group" style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px;">
    <label>ğŸ“Š ì •ë‹µ CSV íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°:</label>
    <input type="file" id="csvInput" multiple accept=".csv" style="display:none;" onchange="loadCSVFiles(event)">
    <button class="btn" onclick="document.getElementById('csvInput').click()">ğŸ“„ CSV íŒŒì¼ ì„ íƒ</button>
    <button class="btn btn-danger" onclick="clearCSVData()" style="margin-left:5px;">ğŸ—‘ï¸ CSV ì´ˆê¸°í™”</button>
    
    <div id="csvStatus" style="margin-top:10px; display:none;">
        <strong>âœ… ë¶ˆëŸ¬ì˜¨ ì •ë‹µ íŒŒì¼:</strong>
        <div id="csvList" style="margin-top:5px; font-size:12px; color:#666;"></div>
    </div>
</div>


    <!-- ì„ íƒëœ í´ë” ëª©ë¡ -->
    <div id="selectedFolders" style="margin-top:10px; display:none;">
        <strong>âœ… ì ìš©ëœ í´ë”:</strong>
        <div id="selectedFolderList" style="margin-top:5px;"></div>
    </div>
</div>
        
        <div class="control-group">
            <label>ğŸ” íŒŒì¼ëª… í•„í„° (ì„ íƒì‚¬í•­):</label>
            <input type="text" id="filterInput" placeholder="ì˜ˆ: ì¤‘2, ì¼ì°¨ë°©ì •ì‹" style="width: 300px;">
        </div>
        
<div class="control-group" style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
    <h3 style="margin-top: 0;">ğŸ“¸ ë¬¸ì œ ì´¬ì˜í•˜ê¸°</h3>
    <div>
        <button class="btn" onclick="startCamera()">ğŸ“· ì¹´ë©”ë¼ ì—´ê¸°</button>
        <button class="btn btn-export" onclick="document.getElementById('photoInput').click()">ğŸ–¼ï¸ ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ</button>
        <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="handlePhotoSelect(event)">
    </div>
    
    <div id="cameraContainer" style="display:none; margin-top:15px;">
        <video id="cameraVideo" autoplay playsinline style="width:100%; max-width:500px; border:2px solid #333; border-radius:8px;"></video>
        <div style="margin-top:10px;">
            <button class="btn" onclick="capturePhoto()">ğŸ“¸ ì´¬ì˜</button>
            <button class="btn btn-danger" onclick="stopCamera()">âŒ ì·¨ì†Œ</button>
        </div>
    </div>
    
    <canvas id="photoCanvas" style="display:none;"></canvas>
    
    <div id="capturedPhotoContainer" style="display:none; margin-top:15px;">
        <img id="capturedPhoto" style="max-width:100%; border:2px solid #4CAF50; border-radius:8px;">
        <div style="margin-top:10px;">
            <input type="text" id="photoFilename" placeholder="íŒŒì¼ëª… ì…ë ¥ (ì˜ˆ: ì¤‘2_ì¼ì°¨ë°©ì •ì‹_01)" style="width:300px; padding:8px; margin-right:10px;">
            <button class="btn" onclick="savePhoto()">ğŸ’¾ ì €ì¥</button>
            <button class="btn btn-danger" onclick="cancelPhoto()">âŒ ì·¨ì†Œ</button>
        </div>
    </div>
</div>



        <div class="control-group">
            <label>ğŸ² ì¶œì œ ë°©ì‹:</label>
            <label><input type="radio" name="sortMode" value="random" checked> ëœë¤ ì¶œì œ</label>
            <label><input type="radio" name="sortMode" value="sorted"> íŒŒì¼ëª… ìˆœì„œëŒ€ë¡œ</label>
        </div>
        <div class="control-group">
    <label><input type="checkbox" id="showFilename"> ğŸ“ ì´ë¯¸ì§€ íŒŒì¼ëª… í‘œì‹œ</label>
</div>

        <div class="control-group">
            <label><input type="checkbox" id="weakOnly"> âŒ ì·¨ì•½ë¬¸ì œë§Œ ì¶œì œ</label>
            <label><input type="checkbox" id="includeReview" checked> ğŸ”¶ ë³µìŠµí•„ìš” í¬í•¨</label>
            <label><input type="checkbox" id="includeMaster"> âœ… ì™„ì „ì •ë³µ í¬í•¨ (ì‹¤ë ¥ ìœ ì§€ìš©)</label>
        </div>
        <div class="control-group" style="background:#e8eaf6; padding:12px 15px; border-radius:8px;">
            <label>
                <input type="checkbox" id="excludeRecent" checked>
                ğŸ“… ìµœê·¼ ì¶œì œ ë¬¸ì œ ì œì™¸
            </label>
            <span style="margin-left:10px; font-size:13px; color:#555;">ìµœê·¼
                <select id="excludeDays" style="padding:4px 6px; border:1px solid #ddd; border-radius:4px; font-size:13px;">
                    <option value="3">3ì¼</option>
                    <option value="7" selected>7ì¼</option>
                    <option value="14">14ì¼</option>
                    <option value="30">30ì¼</option>
                </select>
                ì´ë‚´ ì¶œì œëœ ë¬¸ì œ ìë™ ì œì™¸
            </span>
            <span id="excludeRecentStatus" style="margin-left:10px; font-size:12px; color:#888;"></span>
        </div>
        
        <div class="control-group" style="background: #fff3cd; padding: 15px; border-radius: 8px;">
    	<label style="display: block; margin-bottom: 10px;">
      		<input type="checkbox" id="useDifficultyFilter"> 
        ğŸ¯ ë‚œì´ë„ë³„ ë¬¸ì œ ìˆ˜ ì§€ì •
	</label>
    
    <!-- ë‚œì´ë„ ë¶„ì„ ê²°ê³¼ í‘œì‹œ -->
    <div id="difficultyAnalysis" style="display: none; margin: 10px 0; padding: 10px; background: #e7f3ff; border-radius: 5px; border-left: 4px solid #2196F3;">
        <strong>ğŸ“Š ì„ íƒëœ í´ë”ì˜ ë‚œì´ë„ ë¶„ì„:</strong>
        <div id="difficultyCount" style="margin-top: 8px; font-size: 13px; line-height: 1.8;"></div>
    </div>
    
    	<div id="difficultySettings" style="display: none; margin-left: 20px;">
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
            <label>ëŒ€í‘œë¬¸ì œ: <input type="number" id="diff_ëŒ€í‘œë¬¸ì œ" value="0" min="0" style="width:50px;"></label>
            <label>í•˜: <input type="number" id="diff_í•˜" value="0" min="0" style="width:50px;"></label>
            <label>ì¤‘í•˜: <input type="number" id="diff_ì¤‘í•˜" value="0" min="0" style="width:50px;"></label>
            <label>ì¤‘: <input type="number" id="diff_ì¤‘" value="0" min="0" style="width:50px;"></label>
            <label>ì¤‘ìƒ: <input type="number" id="diff_ì¤‘ìƒ" value="0" min="0" style="width:50px;"></label>
            <label>ìƒ: <input type="number" id="diff_ìƒ" value="0" min="0" style="width:50px;"></label>
            <label>Cë‹¨ê³„: <input type="number" id="diff_Cë‹¨ê³„" value="0" min="0" style="width:50px;"></label>
            <label>3ì : <input type="number" id="diff_3ì " value="0" min="0" style="width:50px;"></label>
            <label>4ì : <input type="number" id="diff_4ì " value="0" min="0" style="width:50px;"></label>
            <label>ë¯¸ë¶„ë¥˜: <input type="number" id="diff_ë¯¸ë¶„ë¥˜" value="0" min="0" style="width:50px;"></label>
        </div>
    </div>
</div>
<script>
// ì²´í¬ë°•ìŠ¤ í† ê¸€ ì´ë²¤íŠ¸
document.getElementById('useDifficultyFilter').addEventListener('change', function() {
    document.getElementById('difficultySettings').style.display = this.checked ? 'block' : 'none';
});
</script>


        <div class="control-group">
    <label>ğŸ“ ì‹œí—˜ì§€ ì œëª©: <input type="text" id="examTitle" value="ì˜¤ë‹µ í•™ìŠµ ë¬¸ì œì§€" placeholder="ì˜ˆ: ì² ìˆ˜ ì¼ì°¨ë°©ì •ì‹ ìˆ™ì œ 0121" style="width:400px;"></label>
    <label>ğŸ“‚ ìœ í˜•: 
        <select id="testType" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
            <option value="ìˆ™ì œ">ìˆ™ì œ</option>
            <option value="ì‹œí—˜">ì‹œí—˜</option>
            <option value="í€´ì¦ˆ">í€´ì¦ˆ</option>
            <option value="ê³¼ì œ">ê³¼ì œ</option>
            <option value="ë³µìŠµ">ë³µìŠµ</option>
        </select>
    </label>
</div>
<div class="control-group">
    <label>ğŸ“„ í˜ì´ì§€ë‹¹ ë¬¸ì œ ìˆ˜: <input type="number" id="quizPerPage" value="6" min="1" max="12" style="width:60px;"></label>
    <label>ğŸ“š ì´ í˜ì´ì§€ ìˆ˜: <input type="number" id="totalPages" value="6" min="1" max="20" style="width:60px;"></label>
</div>
        <!-- GitHub Pages ì—°ë™ ì„¤ì • -->
<div class="control-group" style="background:#e8f5e9; padding:15px; border-radius:8px; margin:10px 0;">
    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <strong>ğŸ”— GitHub Pages ì—°ë™ (QR ìê°€ì±„ì ìš©)</strong>
        <button onclick="toggleGithubSettings()" id="githubToggleBtn" style="padding:4px 10px; font-size:12px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">âš™ï¸ ì„¤ì •</button>
        <span id="githubStatus" style="font-size:12px; color:#888;">ë¯¸ì„¤ì •</span>
    </div>
    <div id="githubSettingsPanel" style="display:none;">
        <div style="display:grid; gap:8px;">
            <label style="font-size:13px;">
                GitHub ì‚¬ìš©ìëª…:
                <input type="text" id="githubUsername" placeholder="ì˜ˆ: myname" style="margin-left:8px; padding:6px; width:200px; border:1px solid #ddd; border-radius:4px;">
            </label>
            <label style="font-size:13px;">
                ì €ì¥ì†Œ(Repo) ì´ë¦„:
                <input type="text" id="githubRepo" placeholder="ì˜ˆ: quiz-answers" style="margin-left:8px; padding:6px; width:200px; border:1px solid #ddd; border-radius:4px;">
            </label>
            <label style="font-size:13px;">
                Personal Access Token:
                <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxx" style="margin-left:8px; padding:6px; width:250px; border:1px solid #ddd; border-radius:4px;">
            </label>
            <div style="display:flex; gap:8px; margin-top:4px;">
                <button onclick="saveGithubSettings()" class="btn" style="padding:7px 16px; font-size:13px;">ğŸ’¾ ì €ì¥</button>
                <button onclick="testGithubConnection()" class="btn btn-export" style="padding:7px 16px; font-size:13px;">ğŸ”Œ ì—°ê²° í…ŒìŠ¤íŠ¸</button>
            </div>
            <div style="margin-top:6px; padding:10px; background:#fff8e1; border-radius:6px; font-size:12px; color:#666; line-height:1.8;">
                ğŸ’¡ <strong>ì„¤ì • ë°©ë²•:</strong><br>
                1. <a href="https://github.com" target="_blank">github.com</a> ë¡œê·¸ì¸ â†’ ìš°ì¸¡ ìƒë‹¨ í”„ë¡œí•„ â†’ Settings<br>
                2. ì¢Œì¸¡ í•˜ë‹¨ Developer settings â†’ Personal access tokens â†’ Tokens (classic)<br>
                3. Generate new token â†’ repo ê¶Œí•œ ì²´í¬ â†’ ìƒì„± í›„ í† í° ë³µì‚¬<br>
                4. <a href="https://github.com/new" target="_blank">ìƒˆ ì €ì¥ì†Œ</a> ìƒì„± (Public, ì´ë¦„ ê¸°ì–µ) â†’ Settings â†’ Pages â†’ Branch: main ì €ì¥
            </div>
        </div>
    </div>
</div>
<div class="control-group">
    <label><input type="checkbox" id="showAnswerSheet" checked> ğŸ“‹ ì •ë‹µí‘œ í¬í•¨</label>
    <label style="margin-left:15px;"><input type="checkbox" id="includeQR" checked> ğŸ“± QR ì½”ë“œ í¬í•¨ (í•™ìƒ ìê°€ì±„ì ìš©)</label>
</div>



<div>
    <button class="btn" onclick="generateQuiz()">ğŸ² ì‹œí—˜ì§€ ìƒì„±</button>
    <!-- ğŸ†• NíšŒë¶„ ì„¸íŠ¸ ìƒì„± UI -->
    <span style="display:inline-flex; align-items:center; margin:5px; background:#e8f5e9; border:1px solid #4CAF50; border-radius:6px; padding:4px 10px; gap:8px;">
        <label style="font-weight:bold; font-size:13px; color:#2e7d32; margin:0;">ğŸ“¦ ì„¸íŠ¸ ìƒì„±</label>
        <input type="number" id="setCount" value="3" min="1" max="20" style="width:48px; padding:5px; border:1px solid #aaa; border-radius:4px; font-size:14px; text-align:center;">
        <span style="font-size:13px; color:#555;">íšŒë¶„</span>
        <button class="btn" onclick="generateSetQuiz()" style="background:#2e7d32; margin:0; padding:7px 14px; font-size:13px;">ğŸ—‚ï¸ ì„¸íŠ¸ ìƒì„±</button>
    </span>
    <button class="btn" onclick="showGradingList()" style="background:#FF9800;">ğŸ“ ì±„ì  ëŒ€ê¸° ëª©ë¡</button>
    <button class="btn" onclick="openAnalysisWindow()" style="background:#9C27B0; color:white;">ğŸ“Š í•™ìŠµ ë¶„ì„</button>
    <button class="btn" onclick="openQRModal()" style="background:#00BCD4; color:white;">ğŸ“± QR ì±„ì í•˜ê¸°</button>
    <button class="btn" onclick="openResultsViewer()" style="background:#795548; color:white;">ğŸ“Š ì±„ì  ê²°ê³¼ í™•ì¸</button>
<div style="margin-top:15px; padding:15px; background:#fff3e0; border-radius:8px;">
    <strong>ğŸ’¾ í•™ìŠµ ë°ì´í„° ë‹¤ìš´ë¡œë“œ:</strong>
    <select id="downloadPeriod" style="padding:8px; margin:0 10px; border:1px solid #ddd; border-radius:4px;">
        <option value="7">ìµœê·¼ 1ì£¼</option>
        <option value="14">ìµœê·¼ 2ì£¼</option>
        <option value="30" selected>ìµœê·¼ 1ê°œì›”</option>
        <option value="90">ìµœê·¼ 3ê°œì›”</option>
        <option value="180">ìµœê·¼ 6ê°œì›”</option>
        <option value="365">ìµœê·¼ 1ë…„</option>
        <option value="all">ì „ì²´ ê¸°ê°„</option>
    </select>
    <button class="btn" onclick="downloadStudentData()" style="background:#FF9800; color:white;">ğŸ“¥ ë‹¤ìš´ë¡œë“œ</button>
</div>
<button class="btn" onclick="downloadStudentData()" style="background:#FF9800; color:white;">ğŸ’¾ í•™ìŠµ ë°ì´í„° ë‹¤ìš´ë¡œë“œ</button>
    <button class="btn" onclick="window.print()">ğŸ–¨ï¸ ì¸ì‡„ / PDF ì €ì¥</button>
    <button class="btn btn-export" onclick="exportData()">ğŸ“¤ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
    <button class="btn btn-export" onclick="document.getElementById('importFile').click()">ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
    <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
    <button class="btn btn-danger" onclick="resetAllData()">ğŸ—‘ï¸ ì „ì²´ ì´ˆê¸°í™”</button>
</div>
        
        <div id="status" class="status"></div>
<div id="problemList" style="display:none !important;"></div>
<!-- ì±„ì  ëŒ€ê¸° ëª©ë¡ í™”ë©´ -->
<div id="gradingListPanel" style="background:white; padding:20px; border-radius:8px; margin-top:20px; display:none;">
<!-- ì±„ì  ì…ë ¥ í™”ë©´ -->
<div id="gradingPanel" style="background:white; padding:20px; border-radius:8px; margin-top:20px; display:none;">
<!-- í•™ìŠµ ë¶„ì„ í™”ë©´ -->
<div id="analysisPanel" style="background:white; padding:20px; border-radius:8px; margin-top:20px; display:none;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">ğŸ“Š í•™ìŠµ ë¶„ì„</h2>
        <button class="btn btn-danger" onclick="closeAnalysis()">âŒ ë‹«ê¸°</button>
    </div>
    
    <!-- í•™ìƒ ì„ íƒ ë° ê¸°ê°„ ì„¤ì • -->
    <div style="background:#f0f7ff; padding:15px; border-radius:8px; margin-bottom:20px; display:flex; gap:15px; align-items:center;">
        <div>
            <label style="font-weight:bold; margin-right:8px;">í•™ìƒ:</label>
            <select id="analysisStudent" onchange="loadAnalysisData()" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
                <option value="">í•™ìƒ ì„ íƒ</option>
            </select>
        </div>
        <div>
            <label style="font-weight:bold; margin-right:8px;">ë¶„ì„ ê¸°ê°„:</label>
            <select id="analysisPeriod" onchange="loadAnalysisData()" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
                <option value="7">ìµœê·¼ 1ì£¼</option>
                <option value="14">ìµœê·¼ 2ì£¼</option>
                <option value="30" selected>ìµœê·¼ 1ê°œì›”</option>
                <option value="90">ìµœê·¼ 3ê°œì›”</option>
                <option value="all">ì „ì²´</option>
            </select>
        </div>
        <button class="btn" onclick="loadAnalysisData()" style="margin-left:auto;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </div>
    
    <!-- ë¶„ì„ ë‚´ìš© -->
    <div id="analysisContent">
        <p style="text-align:center; color:#999; padding:40px;">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.</p>
    </div>
</div>    
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <div>
            <h2 style="margin:0;" id="gradingTitle">ì±„ì  ì¤‘...</h2>
            <p style="margin:5px 0 0 0; color:#666;" id="gradingSubtitle"></p>
        </div>
        <button class="btn btn-danger" onclick="exitGrading()">âŒ ì±„ì  ì¢…ë£Œ</button>
    </div>
    
    <!-- ì§„í–‰ë¥  ë°” -->
    <div style="background:#f0f0f0; border-radius:10px; height:30px; margin-bottom:20px; position:relative; overflow:hidden;">
        <div id="gradingProgress" style="background:linear-gradient(90deg, #4CAF50, #8BC34A); height:100%; width:0%; transition:width 0.3s;"></div>
        <span id="gradingProgressText" style="position:absolute; left:50%; top:50%; transform:translate(-50%, -50%); font-weight:bold; color:#333;">0/0</span>
    </div>
    
    <!-- ì±„ì  ì¹´ë“œ -->
    <div style="background:#f9f9f9; border-radius:12px; padding:25px; margin-bottom:20px;">
        <div style="display:flex; gap:20px;">
            <!-- ì™¼ìª½: ë¬¸ì œ ì •ë³´ -->
            <div style="flex:1;">
                <div style="background:white; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h3 style="margin:0 0 10px 0; color:#333;">ë¬¸ì œ <span id="currentProblemNum"></span>ë²ˆ</h3>
                    <div style="font-size:13px; color:#666; line-height:1.8;">
                        <p style="margin:3px 0;"><strong>íŒŒì¼:</strong> <span id="currentFilename"></span></p>
                        <p style="margin:3px 0;"><strong>êµì¬:</strong> <span id="currentBookName"></span></p>
                        <p style="margin:3px 0;"><strong>ë‚œì´ë„:</strong> <span id="currentDifficulty"></span></p>
                        <p style="margin:3px 0; font-size:16px;"><strong>ì •ë‹µ:</strong> <span id="currentCorrectAnswer" style="color:#4CAF50; font-size:18px; font-weight:bold;"></span></p>
                    </div>
                </div>
                
                <!-- í•™ìƒ ë‹µì•ˆ ì…ë ¥ -->
                <div style="background:white; padding:15px; border-radius:8px;">
                    <label style="display:block; margin-bottom:8px; font-weight:bold; color:#555;">í•™ìƒ ë‹µì•ˆ:</label>
                    <input type="text" id="studentAnswer" placeholder="ë‹µ ì…ë ¥ (Enterë¡œ ë‹¤ìŒ)" style="width:100%; padding:12px; font-size:16px; border:2px solid #ddd; border-radius:6px;" onkeypress="if(event.key==='Enter') submitAnswer()">
                </div>
            </div>
            
            <!-- ì˜¤ë¥¸ìª½: ì±„ì  ì˜µì…˜ -->
            <div style="flex:1;">
                <div style="background:white; padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 15px 0; color:#333;">ê²°ê³¼ ì„ íƒ</h4>
                    
                    <!-- ì •ë‹µ/ì˜¤ë‹µ ì„ íƒ -->
                    <div style="margin-bottom:15px;">
                        <label style="display:block; padding:10px; border:2px solid #ddd; border-radius:6px; cursor:pointer; margin-bottom:8px; transition:all 0.2s;" onmouseover="this.style.background='#e8f5e9'" onmouseout="this.style.background='white'">
                            <input type="radio" name="resultType" value="ì •ë‹µ" onchange="updateResultOptions()" style="margin-right:8px;">
                            <strong style="color:#4CAF50;">âœ… ì •ë‹µ</strong>
                        </label>
                        <label style="display:block; padding:10px; border:2px solid #ddd; border-radius:6px; cursor:pointer; transition:all 0.2s;" onmouseover="this.style.background='#ffebee'" onmouseout="this.style.background='white'">
                            <input type="radio" name="resultType" value="ì˜¤ë‹µ" onchange="updateResultOptions()" style="margin-right:8px;">
                            <strong style="color:#f44336;">âŒ ì˜¤ë‹µ</strong>
                        </label>
                    </div>
                    
                    <!-- ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ -->
                    <div id="detailCategorySection" style="display:none;">
                        <h5 style="margin:0 0 10px 0; color:#666;">ì„¸ë¶€ ë¶„ë¥˜:</h5>
                        <div id="correctCategories" style="display:none;">
                            <label style="display:block; padding:8px; margin-bottom:5px; cursor:pointer;">
                                <input type="radio" name="detailCategory" value="ì •í™•í•œí’€ì´" style="margin-right:8px;">
                                ì •í™•í•œ í’€ì´
                            </label>
                            <label style="display:block; padding:8px; margin-bottom:5px; cursor:pointer;">
                                <input type="radio" name="detailCategory" value="ì°ì–´ì„œë§ì¶¤" style="margin-right:8px;">
                                ğŸ² ì°ì–´ì„œ ë§ì¶¤
                            </label>
                        </div>
                        <div id="wrongCategories" style="display:none;">
                            <label style="display:block; padding:8px; margin-bottom:5px; cursor:pointer;">
                                <input type="radio" name="detailCategory" value="ê³„ì‚°ì‹¤ìˆ˜" style="margin-right:8px;">
                                ğŸ§® ê³„ì‚° ì‹¤ìˆ˜
                            </label>
                            <label style="display:block; padding:8px; margin-bottom:5px; cursor:pointer;">
                                <input type="radio" name="detailCategory" value="ì¡°ê±´í™œìš©ëª»í•¨" style="margin-right:8px;">
                                âš™ï¸ ì¡°ê±´ í™œìš© ëª»í•¨
                            </label>
                            <label style="display:block; padding:8px; margin-bottom:5px; cursor:pointer;">
                                <input type="radio" name="detailCategory" value="ì‹ì„¸ìš°ê¸°ì–´ë ¤ì›€" style="margin-right:8px;">
                                ğŸ§© ì‹ ì„¸ìš°ê¸° ì–´ë ¤ì›€
                            </label>
                            <label style="display:block; padding:8px; margin-bottom:5px; cursor:pointer;">
                                <input type="radio" name="detailCategory" value="ê°œë…ì—°ê²°ëª»í•¨" style="margin-right:8px;">
                                ğŸ“– ê°œë… ì—°ê²° ëª»í•¨
                            </label>
                            <label style="display:block; padding:8px; margin-bottom:5px; cursor:pointer;">
                                <input type="radio" name="detailCategory" value="ì§‘ì¤‘ë ¥ë¶€ì¡±" style="margin-right:8px;">
                                ğŸ˜µ ì§‘ì¤‘ë ¥ ë¶€ì¡±
                            </label>
                            <label style="display:block; padding:8px; margin-bottom:5px; cursor:pointer;">
                                <input type="radio" name="detailCategory" value="ê¸°íƒ€" style="margin-right:8px;">
                                â“ ê¸°íƒ€
                            </label>
                        </div>
                    </div>
                </div>
                
                <!-- ë©”ëª¨ -->
                <div style="background:white; padding:15px; border-radius:8px;">
                    <label style="display:block; margin-bottom:8px; font-weight:bold; color:#555;">ë©”ëª¨ (ì„ íƒ):</label>
                    <textarea id="gradingMemo" placeholder="ì˜ˆ: 7Ã—3ì„ 20ìœ¼ë¡œ ê³„ì‚°" style="width:100%; min-height:80px; padding:10px; border:1px solid #ddd; border-radius:6px; resize:vertical;"></textarea>
                </div>
            </div>
        </div>
    </div>
    
    <!-- í•˜ë‹¨ ë²„íŠ¼ -->
    <div style="display:flex; justify-content:space-between; gap:10px;">
        <button class="btn btn-export" onclick="previousProblem()" id="prevBtn" disabled>â¬…ï¸ ì´ì „</button>
        <div style="display:flex; gap:10px;">
            <button class="btn" onclick="saveTempGrading()">ğŸ’¾ ì„ì‹œì €ì¥</button>
            <button class="btn" onclick="submitAnswer()" style="background:#4CAF50; font-size:16px; padding:12px 30px;">ë‹¤ìŒ â¡ï¸</button>
        </div>
    </div>
    
    <!-- í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì•ˆë‚´ -->
    <div style="margin-top:15px; padding:10px; background:#f0f7ff; border-radius:6px; font-size:12px; color:#666;">
        ğŸ’¡ <strong>ë‹¨ì¶•í‚¤:</strong> Enter = ë‹¤ìŒ | Ctrl+S = ì„ì‹œì €ì¥ | ESC = ì¢…ë£Œ
    </div>
</div>
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 style="margin:0;">ğŸ“ ì±„ì  ëŒ€ê¸° ëª©ë¡</h2>
        <button class="btn btn-danger" onclick="closeGradingList()">âŒ ë‹«ê¸°</button>
    </div>
    
    <div style="margin-bottom:15px; display:flex; gap:10px;">
        <select id="filterStudent" onchange="filterGradingList()" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
            <option value="">ì „ì²´ í•™ìƒ</option>
        </select>
        <select id="filterStatus" onchange="filterGradingList()" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
            <option value="">ì „ì²´ ìƒíƒœ</option>
            <option value="ë¯¸ì±„ì ">ë¯¸ì±„ì ë§Œ</option>
            <option value="ì±„ì ì™„ë£Œ">ì±„ì ì™„ë£Œë§Œ</option>
        </select>
        <select id="filterType" onchange="filterGradingList()" style="padding:8px; border:1px solid #ddd; border-radius:4px;">
            <option value="">ì „ì²´ ìœ í˜•</option>
            <option value="ìˆ™ì œ">ìˆ™ì œ</option>
            <option value="ì‹œí—˜">ì‹œí—˜</option>
            <option value="í€´ì¦ˆ">í€´ì¦ˆ</option>
        </select>
    </div>
    
    <div id="gradingListContent" style="max-height:600px; overflow-y:auto;">
        <!-- ì—¬ê¸°ì— ì‹œí—˜ì§€ ëª©ë¡ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>
</div>    
<h3>ğŸ“‹ ë¬¸ì œ ëª©ë¡</h3>
    <div id="listContent"></div>
</div>
    </div>
    
    <div id="quizSheet"></div>
    
    <script>
        let allImages = [];
        let currentStudent = '';
        let currentQuizImages = [];
        // â­ ì—¬ê¸°ì— ìƒˆë¡œìš´ ì½”ë“œ ì¶”ê°€! â­
let csvDataMap = {}; // CSV ë°ì´í„° ì €ì¥ (íŒŒì¼ëª…: {ë²ˆí˜¸: ì •ë‹µ})
// â­ ì—¬ê¸°ì— ì¶”ê°€! â­
let testPapers = {}; // ìƒì„±ëœ ì‹œí—˜ì§€ ì €ì¥
let currentTestData = null; // í˜„ì¬ ìƒì„±ëœ ì‹œí—˜ì§€ ì„ì‹œ ì €ì¥
// â­ ì—¬ê¸°ì— ì¶”ê°€! â­
let currentGradingTest = null; // í˜„ì¬ ì±„ì  ì¤‘ì¸ ì‹œí—˜ì§€
let currentProblemIndex = 0; // í˜„ì¬ ì±„ì  ì¤‘ì¸ ë¬¸ì œ ì¸ë±ìŠ¤
let gradingResults = []; // ì±„ì  ê²°ê³¼ ì„ì‹œ ì €ì¥
let gradingResultsDB = {}; // ì „ì²´ ì±„ì  ê²°ê³¼ DB


async function init() {
    await initDB(); // IndexedDB ì´ˆê¸°í™”
    loadStudents();
    loadTestPapers();
    loadGradingResults(); // â­ ì´ ì¤„ ì¶”ê°€!
    const saved = localStorage.getItem('currentStudent');
    if (saved) {
        currentStudent = saved;
        document.getElementById('studentSelect').value = saved;
        switchStudent();
        loadPhotosFromDB(); // ì´¬ì˜í•œ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸°
    }
}
        
        // í•™ìƒ ëª©ë¡ ë¡œë“œ
        function loadStudents() {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">í•™ìƒ ì„ íƒ</option>';
            students.forEach(name => {
                const opt = document.createElement('option');
                opt.value = name;
                opt.textContent = name;
                select.appendChild(opt);
            });
        }
        
        // í•™ìƒ ì¶”ê°€
        function addStudent() {
            const name = document.getElementById('newStudentName').value.trim();
            if (!name) {
                showStatus('í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', false);
                return;
            }
            
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            if (students.includes(name)) {
                showStatus('ì´ë¯¸ ë“±ë¡ëœ í•™ìƒì…ë‹ˆë‹¤.', false);
                return;
            }
            
            students.push(name);
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem(`student_${name}`, JSON.stringify({}));
            
            loadStudents();
            document.getElementById('studentSelect').value = name;
            document.getElementById('newStudentName').value = '';
            currentStudent = name;
            localStorage.setItem('currentStudent', name);
            switchStudent();
            showStatus(`${name} í•™ìƒì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`, true);
        }
        
        // í•™ìƒ ì‚­ì œ
        function deleteStudent() {
            if (!currentStudent) {
                showStatus('ì‚­ì œí•  í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            if (!confirm(`${currentStudent} í•™ìƒì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const newStudents = students.filter(s => s !== currentStudent);
            localStorage.setItem('students', JSON.stringify(newStudents));
            localStorage.removeItem(`student_${currentStudent}`);
            
            currentStudent = '';
            localStorage.removeItem('currentStudent');
            loadStudents();
            document.getElementById('dashboard').style.display = 'none';
            showStatus('í•™ìƒì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', true);
        }
        
       function switchStudent() {
            currentStudent = document.getElementById('studentSelect').value;
            if (currentStudent) {
                localStorage.setItem('currentStudent', currentStudent);
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('currentStudentName').textContent = currentStudent;
                updateDashboard();
                loadPhotosFromDB(); // ì—¬ê¸° ì¶”ê°€!
            } else {
                document.getElementById('dashboard').style.display = 'none';
            }
        }
        
        // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        function updateDashboard() {
            if (!currentStudent) return;
            
            const data = JSON.parse(localStorage.getItem(`student_${currentStudent}`) || '{}');
            let weak = 0, review = 0, master = 0;
            
            Object.values(data).forEach(problem => {
                if (problem.level === 'ì·¨ì•½ë¬¸ì œ') weak++;
                else if (problem.level === 'ë³µìŠµí•„ìš”') review++;
                else if (problem.level === 'ì™„ì „ì •ë³µ') master++;
            });
            
            document.getElementById('weakCount').textContent = weak;
            document.getElementById('reviewCount').textContent = review;
            document.getElementById('masterCount').textContent = master;
        }
        
        // ì´ë¯¸ì§€ ë¡œë“œ
       
// í´ë” êµ¬ì¡° ì €ì¥ ë³€ìˆ˜
let folderStructure = {};
let selectedFolderPaths = new Set();

// ì´ë¯¸ì§€ ë¡œë“œ - í´ë” êµ¬ì¡° ë¶„ì„
document.getElementById('folderInput').addEventListener('change', function(e) {
    const files = Array.from(e.target.files);
    if (files.length === 0) return;
    
    // í´ë” êµ¬ì¡° ë¶„ì„
    folderStructure = {};
    files.forEach(file => {
        const path = file.webkitRelativePath || file.name;
        const parts = path.split('/');
        
        let current = folderStructure;
        for (let i = 0; i < parts.length - 1; i++) {
            const folderName = parts[i];
            if (!current[folderName]) {
                current[folderName] = { files: [], subfolders: {} };
            }
            if (i < parts.length - 2) {
                current = current[folderName].subfolders;
            }
        }
        
        // ë§ˆì§€ë§‰ í´ë”ì— íŒŒì¼ ì¶”ê°€
        if (parts.length >= 2) {
            const lastFolderName = parts[parts.length - 2];
            let folder = folderStructure;
            for (let i = 0; i < parts.length - 2; i++) {
                folder = folder[parts[i]].subfolders;
            }
            if (folder[lastFolderName] && file.name.toLowerCase().endsWith('.png')) {
                folder[lastFolderName].files.push(file);
            }
        }
    });
    
    // íƒìƒ‰ê¸° í‘œì‹œ
    displayFolderTree(folderStructure);
    document.getElementById('folderExplorer').style.display = 'block';
    showStatus(`ğŸ“‚ í´ë” êµ¬ì¡°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ì›í•˜ëŠ” í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.`, true);
});

// í´ë” íŠ¸ë¦¬ í‘œì‹œ (í¼ì¹¨/ì ‘í˜ ê¸°ëŠ¥)
function displayFolderTree(structure, parentPath = '', level = 0) {
    const container = level === 0 ? document.getElementById('folderTree') : null;
    if (container) container.innerHTML = '';
    
    let html = '';
    
    for (let folderName in structure) {
        const folder = structure[folderName];
        const fullPath = parentPath ? `${parentPath}/${folderName}` : folderName;
        const hasFiles = folder.files && folder.files.length > 0;
        const hasSubfolders = Object.keys(folder.subfolders || {}).length > 0;
        const isSelected = selectedFolderPaths.has(fullPath);
        const subfolderDivId = `subfolder_${fullPath.replace(/[^a-zA-Z0-9]/g, '_')}`;
        
        const indent = '&nbsp;&nbsp;&nbsp;&nbsp;'.repeat(level);
        
        // í¼ì¹¨/ì ‘í˜ ì•„ì´ì½˜
        let expandIcon = '';
        if (hasSubfolders) {
            expandIcon = `<span id="icon_${fullPath.replace(/[^a-zA-Z0-9]/g, '_')}" style="display:inline-block; width:15px;">â–¶</span>`;
        } else {
            expandIcon = `<span style="display:inline-block; width:15px;"></span>`;
        }
        
        const folderIcon = hasSubfolders ? 'ğŸ“' : 'ğŸ“„';
        const selectedStyle = isSelected ? 'background:#d4edda; font-weight:bold;' : '';
        
        html += `
            <div style="margin:2px 0;">
                <div style="padding:5px; cursor:pointer; border-radius:3px; ${selectedStyle}" 
                     onmouseover="this.style.background='${isSelected ? '#c3e6cb' : '#f0f0f0'}'" 
                     onmouseout="this.style.background='${isSelected ? '#d4edda' : 'white'}'">
                    ${indent}
                    ${hasSubfolders ? `<span onclick="expandFolder('${fullPath.replace(/'/g, "\\'")}'); event.stopPropagation();" style="cursor:pointer; user-select:none;">${expandIcon}</span>` : expandIcon}
                    <span onclick="selectFolder('${fullPath.replace(/'/g, "\\'")}'); event.stopPropagation();">
                        ${folderIcon} ${folderName}
                        ${hasFiles ? `<span style="color:#666; font-size:11px;">(${folder.files.length}ê°œ)</span>` : ''}
                        ${isSelected ? ' âœ…' : ''}
                    </span>
                </div>
                ${hasSubfolders ? `<div id="${subfolderDivId}" style="display:none;"></div>` : ''}
            </div>
        `;
    }
    
    if (container) {
        container.innerHTML = html;
    }
    
    return html;
}

// í´ë” í¼ì¹˜ê¸°/ì ‘ê¸°
function expandFolder(path) {
    const subfolderDivId = `subfolder_${path.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const iconId = `icon_${path.replace(/[^a-zA-Z0-9]/g, '_')}`;
    const subfolderDiv = document.getElementById(subfolderDivId);
    const icon = document.getElementById(iconId);
    
    if (!subfolderDiv) return;
    
    if (subfolderDiv.style.display === 'none') {
        // í¼ì¹˜ê¸°
        const subfolders = getSubfoldersFromPath(folderStructure, path);
        if (subfolders) {
            const parts = path.split('/');
            const level = parts.length;
            subfolderDiv.innerHTML = displayFolderTree(subfolders, path, level);
            subfolderDiv.style.display = 'block';
            if (icon) icon.textContent = 'â–¼';
        }
    } else {
        // ì ‘ê¸°
        subfolderDiv.style.display = 'none';
        if (icon) icon.textContent = 'â–¶';
    }
}

// í´ë” ì„ íƒ/í•´ì œ
function selectFolder(path) {
    if (selectedFolderPaths.has(path)) {
        selectedFolderPaths.delete(path);
    } else {
        selectedFolderPaths.add(path);
    }
    
    // í•´ë‹¹ í´ë”ì˜ ì´ë¯¸ì§€ ì ìš©
    applySelectedFolders();
    
    // UI ì—…ë°ì´íŠ¸ (í˜„ì¬ í¼ì³ì§„ ìƒíƒœ ìœ ì§€)
    updateFolderTreeSelection();
    updateSelectedFolderDisplay();
}

// í´ë” íŠ¸ë¦¬ì˜ ì„ íƒ ìƒíƒœë§Œ ì—…ë°ì´íŠ¸
function updateFolderTreeSelection() {
    // ëª¨ë“  í´ë”ì˜ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
    document.querySelectorAll('#folderTree div[style*="padding"]').forEach(el => {
        if (!el.querySelector('span[onclick*="selectFolder"]')) return;
        el.style.background = 'white';
        el.style.fontWeight = 'normal';
        const span = el.querySelector('span[onclick*="selectFolder"]');
        if (span) {
            span.innerHTML = span.innerHTML.replace(' âœ…', '');
        }
    });
    
    // ì„ íƒëœ í´ë”ë§Œ ìŠ¤íƒ€ì¼ ì ìš©
    selectedFolderPaths.forEach(path => {
        const elements = document.querySelectorAll(`span[onclick*="selectFolder('${path.replace(/'/g, "\\'")}')"]`);
        elements.forEach(el => {
            const parent = el.closest('div[style*="padding"]');
            if (parent) {
                parent.style.background = '#d4edda';
                parent.style.fontWeight = 'bold';
                if (!el.innerHTML.includes('âœ…')) {
                    el.innerHTML = el.innerHTML + ' âœ…';
                }
            }
        });
    });
}

// ê²½ë¡œì—ì„œ í•˜ìœ„ í´ë” êµ¬ì¡° ê°€ì ¸ì˜¤ê¸°
function getSubfoldersFromPath(structure, path) {
    const parts = path.split('/');
    let current = structure;
    
    for (let part of parts) {
        if (current[part]) {
            current = current[part];
        } else if (current.subfolders && current.subfolders[part]) {
            current = current.subfolders[part];
        } else {
            return null;
        }
    }
    
    return current.subfolders || {};
}

// ì„ íƒëœ í´ë”ì˜ ì´ë¯¸ì§€ ì ìš©
function applySelectedFolders() {
    // ê¸°ì¡´ ì´ë¯¸ì§€ ì´ˆê¸°í™”
    allImages = [];
    
    // ì„ íƒëœ í´ë”ì˜ íŒŒì¼ë“¤ ì¶”ê°€
    selectedFolderPaths.forEach(path => {
        const files = getFilesFromPath(folderStructure, path);
        files.forEach(file => {
            if (!allImages.find(img => img.name === file.name)) {
                allImages.push(file);
            }
        });
    });
    
    showStatus(`âœ… ${allImages.length}ê°œì˜ ì´ë¯¸ì§€ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`, true);
    showProblemList();
    
    // ë‚œì´ë„ ë¶„ì„ ì‹¤í–‰
    if (allImages.length > 0) {
        analyzeDifficulty();
    } else {
        document.getElementById('difficultyAnalysis').style.display = 'none';
    }
}

// ë‚œì´ë„ ë¶„ì„ ë³€ìˆ˜
let difficultyAnalysisResult = {};

// ì„ íƒëœ í´ë”ì˜ ë‚œì´ë„ ë¶„ì„
function analyzeDifficulty() {
    const difficulties = {
        'ëŒ€í‘œë¬¸ì œ': 0,
        'í•˜': 0,
        'ì¤‘í•˜': 0,
        'ì¤‘': 0,
        'ì¤‘ìƒ': 0,
        'ìƒ': 0,
        'Cë‹¨ê³„': 0,
        '3ì ': 0,
        '4ì ': 0,
        'ë¯¸ë¶„ë¥˜': 0
    };
    
    allImages.forEach(img => {
        const fileName = img.name.toLowerCase();
        let found = false;
        
        if (fileName.includes('_ëŒ€í‘œë¬¸ì œ.png') || fileName.includes('-ëŒ€í‘œë¬¸ì œ.png')) {
            difficulties['ëŒ€í‘œë¬¸ì œ']++; found = true;
        } else if (fileName.includes('_ì¤‘í•˜.png') || fileName.includes('-ì¤‘í•˜.png')) {
            difficulties['ì¤‘í•˜']++; found = true;
        } else if (fileName.includes('_ì¤‘ìƒ.png') || fileName.includes('-ì¤‘ìƒ.png')) {
            difficulties['ì¤‘ìƒ']++; found = true;
        } else if (fileName.includes('_í•˜.png') || fileName.includes('-í•˜.png')) {
            difficulties['í•˜']++; found = true;
        } else if (fileName.includes('_ì¤‘.png') || fileName.includes('-ì¤‘.png')) {
            difficulties['ì¤‘']++; found = true;
        } else if (fileName.includes('_ìƒ.png') || fileName.includes('-ìƒ.png')) {
            difficulties['ìƒ']++; found = true;
        } else if (fileName.includes('_cë‹¨ê³„.png') || fileName.includes('-cë‹¨ê³„.png') ||
                   fileName.includes('_c.png')    || fileName.includes('-c.png')) {
            difficulties['Cë‹¨ê³„']++; found = true;
        } else if (fileName.includes('_3ì .png') || fileName.includes('-3ì .png') ||
                   fileName.includes('_3ì ') ) {
            difficulties['3ì ']++; found = true;
        } else if (fileName.includes('_4ì .png') || fileName.includes('-4ì .png') ||
                   fileName.includes('_4ì ') ) {
            difficulties['4ì ']++; found = true;
        }
        
        if (!found) difficulties['ë¯¸ë¶„ë¥˜']++;
    });
    
    difficultyAnalysisResult = difficulties;
    displayDifficultyAnalysis(difficulties);
}

// ë‚œì´ë„ ë¶„ì„ ê²°ê³¼ í‘œì‹œ
function displayDifficultyAnalysis(difficulties) {
    const total = Object.values(difficulties).reduce((a, b) => a + b, 0);
    
    if (total === 0) {
        document.getElementById('difficultyAnalysis').style.display = 'none';
        return;
    }
    
    let html = `<div style="color:#555;">`;
    
    Object.keys(difficulties).forEach(level => {
        const count = difficulties[level];
        if (count > 0) {
            const percent = ((count / total) * 100).toFixed(1);
            const barWidth = percent;
            html += `
                <div style="margin: 5px 0;">
                    <span style="display: inline-block; width: 60px; font-weight: bold;">${level}:</span>
                    <span style="display: inline-block; width: 40px; text-align: right;">${count}ê°œ</span>
                    <span style="color: #999; font-size: 11px;"> (${percent}%)</span>
                    <div style="display: inline-block; width: 100px; height: 8px; background: #e0e0e0; border-radius: 4px; margin-left: 10px; vertical-align: middle;">
                        <div style="width: ${barWidth}%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); border-radius: 4px;"></div>
                    </div>
                </div>
            `;
        }
    });
    
    html += `</div>`;
    html += `<div style="margin-top: 10px; padding-top: 8px; border-top: 1px solid #ccc; font-weight: bold; color: #333;">ì´ ${total}ê°œ ë¬¸ì œ</div>`;
    
    document.getElementById('difficultyCount').innerHTML = html;
    document.getElementById('difficultyAnalysis').style.display = 'block';
}

// ë¶„ì„ ê²°ê³¼ë¥¼ ì…ë ¥ í•„ë“œì— ìë™ ì…ë ¥
function applyAnalyzedCounts() {
    Object.keys(difficultyAnalysisResult).forEach(level => {
        const input = document.getElementById(`diff_${level}`);
        if (input) {
            input.value = difficultyAnalysisResult[level];
        }
    });
    showStatus('âœ… ë¶„ì„ ê²°ê³¼ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
}



// ê²½ë¡œì—ì„œ íŒŒì¼ ê°€ì ¸ì˜¤ê¸°
function getFilesFromPath(structure, path) {
    const parts = path.split('/');
    let current = structure;
    
    for (let part of parts) {
        if (current[part]) {
            current = current[part];
        } else if (current.subfolders && current.subfolders[part]) {
            current = current.subfolders[part];
        } else {
            return [];
        }
    }
    
    return current.files || [];
}

// ì„ íƒëœ í´ë” í‘œì‹œ
function updateSelectedFolderDisplay() {
    const container = document.getElementById('selectedFolders');
    const list = document.getElementById('selectedFolderList');
    
    if (selectedFolderPaths.size === 0) {
        container.style.display = 'none';
        return;
    }
    
    container.style.display = 'block';
    let html = '';
    
    selectedFolderPaths.forEach(path => {
        const fileCount = getFilesFromPath(folderStructure, path).length;
        html += `
            <div style="display:inline-block; margin:3px; padding:5px 10px; background:#d4edda; border-radius:15px; font-size:12px;">
                ğŸ“ ${path} (${fileCount}ê°œ)
                <span onclick="selectFolder('${path.replace(/'/g, "\\'")}'); event.stopPropagation();" 
                      style="cursor:pointer; margin-left:5px; color:#dc3545; font-weight:bold;">âœ•</span>
            </div>
        `;
    });
    
    list.innerHTML = html;
}

// ì „ì²´ ì´ˆê¸°í™”
function clearAllFolders() {
    if (confirm('ë¶ˆëŸ¬ì˜¨ ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        allImages = [];
        folderStructure = {};
        selectedFolderPaths.clear();
        csvDataMap = {}; // â­ ì´ ì¤„ ì¶”ê°€! â­
        document.getElementById('folderTree').innerHTML = '';
        document.getElementById('folderExplorer').style.display = 'none';
        document.getElementById('selectedFolders').style.display = 'none';
        document.getElementById('quizSheet').innerHTML = '';
        document.getElementById('problemList').style.display = 'none';
        document.getElementById('difficultyAnalysis').style.display = 'none';
        difficultyAnalysisResult = {};
        updateCSVStatus(); // â­ ì´ ì¤„ ì¶”ê°€! â­
        showStatus('ì´ë¯¸ì§€ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
    }
}

        function showProblemList() {
            return;
            if (!currentStudent || allImages.length === 0) return;
            
            const data = JSON.parse(localStorage.getItem(`student_${currentStudent}`) || '{}');
            let html = '';
            
            allImages.forEach(img => {
                const level = data[img.name]?.level || 'ì·¨ì•½ë¬¸ì œ';
                html += `
                    <div class="problem-item">
                        <span class="name">${img.name}</span>
                        <span style="margin:0 10px; color:#999;">${level}</span>
                        <button class="btn" style="padding:5px 10px; margin:2px;" onclick="markAnswer('${img.name.replace(/'/g, "\\'")}', true)">âœ…</button>
                        <button class="btn btn-danger" style="padding:5px 10px; margin:2px;" onclick="markAnswer('${img.name.replace(/'/g, "\\'")}', false)">âŒ</button>
                    </div>
                `;
            });
            
            document.getElementById('listContent').innerHTML = html;
            document.getElementById('problemList').style.display = 'block';
        }
        
        // ì •ë‹µ/ì˜¤ë‹µ ë§ˆí‚¹
        function markAnswer(filename, isCorrect) {
            if (!currentStudent) {
                showStatus('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            const key = `student_${currentStudent}`;
            let data = JSON.parse(localStorage.getItem(key) || '{}');
            
            if (!data[filename]) {
                data[filename] = {
                    level: 'ì·¨ì•½ë¬¸ì œ',
                    correctStreak: 0,
                    totalCorrect: 0,
                    totalWrong: 0,
                    history: []
                };
            }
            
            if (isCorrect) {
                data[filename].correctStreak++;
                data[filename].totalCorrect++;
                
                if (data[filename].correctStreak >= 3) {
                    data[filename].level = 'ì™„ì „ì •ë³µ';
                } else if (data[filename].correctStreak >= 1) {
                    data[filename].level = 'ë³µìŠµí•„ìš”';
                }
            } else {
                data[filename].correctStreak = 0;
                data[filename].totalWrong++;
                data[filename].level = 'ì·¨ì•½ë¬¸ì œ';
            }
            
            data[filename].history.push({
                date: new Date().toLocaleDateString('ko-KR'),
                result: isCorrect ? 'correct' : 'wrong'
            });
            
            localStorage.setItem(key, JSON.stringify(data));
            updateAnswerButtons();
            updateDashboard();
            showProblemList();
        }
        
        // ë‹µì•ˆ ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateAnswerButtons() {
            if (!currentStudent) return;
            
            const data = JSON.parse(localStorage.getItem(`student_${currentStudent}`) || '{}');
            document.querySelectorAll('.quiz-box').forEach((box, idx) => {
                if (!currentQuizImages[idx]) return;
                
                const filename = currentQuizImages[idx].name;
                const problem = data[filename];
                const badge = box.querySelector('.level-badge');
                
                if (problem && badge) {
                    badge.textContent = problem.level;
                    badge.className = 'level-badge ' + 
                        (problem.level === 'ì·¨ì•½ë¬¸ì œ' ? 'weak' : 
                         problem.level === 'ë³µìŠµí•„ìš”' ? 'review' : 'master');
                }
            });
        }
        
        // --- í•µì‹¬: ì‹œí—˜ì§€ ìƒì„± (ë¬¸ì œ ë²ˆí˜¸ ë¶™ì´ê³ , í•´ì„¤ í˜ì´ì§€ë¥¼ ë’¤ì— ë¶™ì„) ---
    
function getSolutionHeight(img) {
    const ratio = img.naturalHeight / img.naturalWidth;

    if (ratio > 1.3) return '60mm';     // ì„œìˆ í˜•
    if (ratio > 0.9) return '40mm';     // ì¼ë°˜ í’€ì´
    return '25mm';                      // ê°ê´€ì‹
}

function findExplanationForByIndex(index, allImages, problemImgName) {
    const base = problemImgName.replace(/\.png$/i, '');
    return allImages.find(f =>
        f.name.includes('í•´ì„¤') && f.name.includes(base)
    ) || null;
}

// ğŸ†• ì´ë¯¸ì§€ ë¹„ìœ¨ ë¶„ì„ í•¨ìˆ˜
async function analyzeImageRatio(imgFile) {
    return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
            const ratio = img.naturalHeight / img.naturalWidth;
            resolve(ratio > 1.8 ? 'tall' : 'normal');
        };
        img.src = URL.createObjectURL(imgFile);
    });
}

// ===== ğŸ†• NíšŒë¶„ ì„¸íŠ¸ ìƒì„± =====
async function generateSetQuiz() {
    const setCount = parseInt(document.getElementById('setCount').value) || 3;
    if (setCount < 1 || setCount > 20) {
        showStatus('íšŒì°¨ ìˆ˜ëŠ” 1~20 ì‚¬ì´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', false);
        return;
    }
    if (!currentStudent) {
        showStatus('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
        return;
    }
    if (allImages.length === 0) {
        showStatus('ë¨¼ì € ì´ë¯¸ì§€ í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.', false);
        return;
    }

    // â”€â”€ ì¡°ê±´ì— ë§ëŠ” í’€ í•„í„°ë§ (generateQuizì™€ ë™ì¼ ë¡œì§) â”€â”€
    const filter = document.getElementById('filterInput').value.trim();
    const sortMode = document.querySelector('input[name="sortMode"]:checked').value;
    const weakOnly = document.getElementById('weakOnly').checked;
    const includeReview = document.getElementById('includeReview').checked;
    const includeMaster = document.getElementById('includeMaster').checked;
    const quizPerPage = parseInt(document.getElementById('quizPerPage').value);
    const totalPages = parseInt(document.getElementById('totalPages').value);
    const quizPerSet = quizPerPage * totalPages; // íšŒì°¨ë‹¹ ë¬¸ì œ ìˆ˜

    let pool = allImages.slice();

    if (filter) {
        const keywords = filter.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
        pool = pool.filter(img => {
            const fileName = img.name.toLowerCase();
            return keywords.some(keyword => fileName.includes(keyword));
        });
        if (pool.length === 0) {
            showStatus(`í•„í„° "${filter}"ì— í•´ë‹¹í•˜ëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.`, false);
            return;
        }
    }

    const data = JSON.parse(localStorage.getItem(`student_${currentStudent}`) || '{}');
    if (weakOnly || includeReview || includeMaster) {
        let allowed = [];
        if (weakOnly) allowed = ['ì·¨ì•½ë¬¸ì œ'];
        else {
            if (!includeReview && !includeMaster) allowed = ['ì·¨ì•½ë¬¸ì œ'];
            if (includeReview) allowed.push('ë³µìŠµí•„ìš”');
            if (includeMaster) allowed.push('ì™„ì „ì •ë³µ');
            if (!allowed.includes('ì·¨ì•½ë¬¸ì œ')) allowed.push('ì·¨ì•½ë¬¸ì œ');
        }
        pool = pool.filter(img => {
            const level = data[img.name]?.level || 'ì·¨ì•½ë¬¸ì œ';
            return allowed.includes(level);
        });
    }

    pool = pool.filter(img => !img.name.toLowerCase().includes('í•´ì„¤'));

    if (pool.length === 0) {
        showStatus('ì¡°ê±´ì— ë§ëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', false);
        return;
    }

    const excludeRecent = document.getElementById('excludeRecent').checked;
    if (excludeRecent && currentStudent) {
        const days = parseInt(document.getElementById('excludeDays').value) || 7;
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);
        loadTestPapers();
        const recentFilenames = new Set();
        Object.values(testPapers).forEach(test => {
            if (test.studentName !== currentStudent) return;
            if (new Date(test.createdAt) < cutoff) return;
            (test.problems || []).forEach(p => recentFilenames.add(p.filename));
        });
        if (recentFilenames.size > 0) {
            pool = pool.filter(img => !recentFilenames.has(img.name));
        }
    }

    // ë‚œì´ë„ í•„í„° ì ìš©ëœ í’€ êµ¬ì„±
    const useDifficultyFilter = document.getElementById('useDifficultyFilter').checked;
    let filteredPool = [];

    if (useDifficultyFilter) {
        const difficulties = ['ëŒ€í‘œë¬¸ì œ', 'í•˜', 'ì¤‘í•˜', 'ì¤‘', 'ì¤‘ìƒ', 'ìƒ', 'Cë‹¨ê³„', '3ì ', '4ì ', 'ë¯¸ë¶„ë¥˜'];
        // ë‚œì´ë„ë³„ í•„ìš” ìˆ˜ëŸ‰ ê³„ì‚°
        const diffCounts = {};
        difficulties.forEach(diff => {
            const count = parseInt(document.getElementById(`diff_${diff}`)?.value) || 0;
            if (count > 0) diffCounts[diff] = count;
        });

        if (Object.keys(diffCounts).length === 0) {
            showStatus('âš ï¸ ë‚œì´ë„ ë¬¸ì œ ìˆ˜ë¥¼ 1ê°œ ì´ìƒ ì§€ì •í•´ì£¼ì„¸ìš”.', false);
            return;
        }

        // ë‚œì´ë„ë³„ë¡œ ì„¸íŠ¸ ìˆ˜ Ã— ë¬¸ì œ ìˆ˜ë§Œí¼ í’€ êµ¬ì„± í›„ ì…”í”Œ
        difficulties.forEach(diff => {
            const countPerSet = diffCounts[diff] || 0;
            if (countPerSet === 0) return;
            const needed = countPerSet * setCount;

            const diffImages = pool.filter(img => {
                const fileName = img.name.toLowerCase();
                if (diff === 'Cë‹¨ê³„') {
                    return fileName.includes('_cë‹¨ê³„.png') || fileName.includes('-cë‹¨ê³„.png') ||
                           fileName.includes('_c.png') || fileName.includes('-c.png');
                }
                const d = diff.toLowerCase();
                if (diff === '3ì ' || diff === '4ì ') {
                    return fileName.includes(`_${d}.png`) || fileName.includes(`-${d}.png`) || fileName.includes(`_${d}`);
                }
                return fileName.includes(`_${d}.png`) || fileName.includes(`-${d}.png`);
            });

            // ì…”í”Œ í›„ ì¤‘ë³µ í—ˆìš© ë°©ì‹ìœ¼ë¡œ neededê°œ í™•ë³´
            let picked = [];
            const shuffled = diffImages.sort(() => Math.random() - 0.5);
            if (shuffled.length === 0) return;
            while (picked.length < needed) {
                picked.push(...shuffled.slice(0, Math.min(needed - picked.length, shuffled.length)));
            }
            filteredPool.push(...picked.slice(0, needed));
        });

        if (filteredPool.length === 0) {
            showStatus('âš ï¸ ì§€ì •í•œ ë‚œì´ë„ì˜ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.', false);
            return;
        }
    } else {
        // ì¼ë°˜ ëª¨ë“œ: ì „ì²´ í’€ ì…”í”Œ í›„ ì„¸íŠ¸ ìˆ˜ Ã— íšŒì°¨ë‹¹ ë¬¸ì œ ìˆ˜ë§Œí¼ í™•ë³´ (ì¤‘ë³µ í—ˆìš©)
        const needed = quizPerSet * setCount;
        const shuffled = pool.sort(() => Math.random() - 0.5);
        if (shuffled.length === 0) {
            showStatus('ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.', false);
            return;
        }
        while (filteredPool.length < needed) {
            filteredPool.push(...shuffled.slice(0, Math.min(needed - filteredPool.length, shuffled.length)));
        }
        filteredPool = filteredPool.slice(0, needed);
    }

    // â”€â”€ íšŒì°¨ë³„ë¡œ ë¬¸ì œ ë¶„ë°° â”€â”€
    const sets = [];
    for (let s = 0; s < setCount; s++) {
        const start = s * quizPerSet;
        sets.push(filteredPool.slice(start, start + quizPerSet));
    }

    const examTitle = document.getElementById('examTitle').value || 'ì˜¤ë‹µ í•™ìŠµ ë¬¸ì œì§€';
    const showFilename = document.getElementById('showFilename').checked;
    const includeQR = document.getElementById('includeQR') ? document.getElementById('includeQR').checked : true;
    const showAnswerSheet = document.getElementById('showAnswerSheet').checked;

    showStatus(`â³ ${setCount}íšŒë¶„ ì„¸íŠ¸ ìƒì„± ì¤‘...`, true);

    let fullHTML = '';
    const allSetData = []; // QRìš© ê° íšŒì°¨ ë°ì´í„° ì €ì¥

    for (let s = 0; s < setCount; s++) {
        const setImages = sets[s];
        const setLabel = `${s + 1}íšŒì°¨`;
        const setTitle = `${examTitle} [${setLabel}]`;

        // ì´ë¯¸ì§€ ë¹„ìœ¨ ë¶„ì„
        const imageRatios = await Promise.all(setImages.map(img => analyzeImageRatio(img)));

        function findExplanationFor(originalName) {
            const base = originalName.replace(/\.png$/i, '').toLowerCase();
            let cand = allImages.find(f => f.name.toLowerCase().includes('í•´ì„¤') && f.name.toLowerCase().includes(base));
            if (cand) return cand;
            const parts = base.split(/[_\- ]+/).filter(Boolean);
            for (let p of parts) {
                cand = allImages.find(f => f.name.toLowerCase().includes('í•´ì„¤') && f.name.toLowerCase().includes(p));
                if (cand) return cand;
            }
            return null;
        }

        const qrContainerId = `qrCodeContainer_set${s}`;
        let html = '';
        let problemNumber = 1;
        const setTotalPages = Math.ceil(setImages.length / quizPerPage);

        for (let page = 0; page < setTotalPages; page++) {
            const start = page * quizPerPage;
            const pageImages = setImages.slice(start, start + quizPerPage);
            if (pageImages.length === 0) break;

            if (quizPerPage === 2) {
                if (page === 0) {
                    html += `<div class="first-page">
                        <div class="exam-header" style="display:flex; align-items:center; justify-content:center; position:relative;">
                            <div class="exam-title" style="flex:1; text-align:center;">${setTitle}</div>
                            ${includeQR ? `<div id="${qrContainerId}" style="position:absolute; right:0; top:50%; transform:translateY(-50%); width:22mm; height:22mm;"></div>` : ''}
                        </div>
                        <div class="problem-grid two-column">`;
                } else {
                    html += `<div class="exam-page"><div class="problem-grid two-column">`;
                }

                for (let i = 0; i < pageImages.length; i++) {
                    const imgFile = pageImages[i];
                    const imgURL = URL.createObjectURL(imgFile);
                    const filename = imgFile.name.replace(/\.png$/i, '');
                    html += `<div class="problem-cell">
                        <div class="answer-check">
                            <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', true)">âœ…</button>
                            <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', false)">âŒ</button>
                        </div>
                        <div class="problem-header">
                            <span class="number">ë¬¸ì œ ${problemNumber}</span>
                            ${showFilename ? `<span class="filename">${filename}</span>` : ''}
                        </div>
                        <div class="image-container"><img src="${imgURL}" class="problem-image" alt="ë¬¸ì œ ${problemNumber}"></div>
                        <div class="solution-area"><div class="solution-label">&lt;í’€ì´&gt;</div></div>
                    </div>`;
                    problemNumber++;
                }
                html += `</div></div>`;

            } else {
                // 4ë¬¸ì œ ê·¸ë¦¬ë“œ
                const pageRatios = imageRatios.slice(start, start + quizPerPage);
                if (page === 0) {
                    html += `<div class="first-page">
                        <div class="exam-header" style="display:flex; align-items:center; justify-content:center; position:relative;">
                            <div class="exam-title" style="flex:1; text-align:center;">${setTitle}</div>
                            ${includeQR ? `<div id="${qrContainerId}" style="position:absolute; right:0; top:50%; transform:translateY(-50%); width:22mm; height:22mm;"></div>` : ''}
                        </div>
                        <div class="problem-grid">`;
                } else {
                    html += `<div class="exam-page"><div class="problem-grid">`;
                }

                let i = 0, gridPosition = 0;
                while (i < pageImages.length && gridPosition < 4) {
                    const imgFile = pageImages[i];
                    const ratio = pageRatios[i];
                    const imgURL = URL.createObjectURL(imgFile);
                    const filename = imgFile.name.replace(/\.png$/i, '');

                    if (ratio === 'tall' && gridPosition % 2 === 0) {
                        html += `<div class="problem-cell tall-cell">
                            <div class="answer-check">
                                <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', true)">âœ…</button>
                                <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', false)">âŒ</button>
                            </div>
                            <div class="problem-header">
                                <span class="number">ë¬¸ì œ ${problemNumber}</span>
                                ${showFilename ? `<span class="filename">${filename}</span>` : ''}
                            </div>
                            <div class="image-container"><img src="${imgURL}" class="problem-image" alt="ë¬¸ì œ ${problemNumber}"></div>
                            <div class="solution-area"><div class="solution-label">&lt;í’€ì´&gt;</div></div>
                        </div>`;
                        problemNumber++; i++; gridPosition += 2;
                    } else {
                        html += `<div class="problem-cell">
                            <div class="answer-check">
                                <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', true)">âœ…</button>
                                <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', false)">âŒ</button>
                            </div>
                            <div class="problem-header">
                                <span class="number">ë¬¸ì œ ${problemNumber}</span>
                                ${showFilename ? `<span class="filename">${filename}</span>` : ''}
                            </div>
                            <div class="image-container"><img src="${imgURL}" class="problem-image" alt="ë¬¸ì œ ${problemNumber}"></div>
                            <div class="solution-area"><div class="solution-label">&lt;í’€ì´&gt;</div></div>
                        </div>`;
                        problemNumber++; i++; gridPosition++;
                    }
                }
                while (gridPosition < 4) {
                    html += `<div class="problem-cell empty-cell"></div>`;
                    gridPosition++;
                }
                html += `</div></div>`;
            }
        }

        // í•´ì„¤ í˜ì´ì§€
        const explanations = setImages.map((imgFile, idx) => ({
            problemNumber: idx + 1,
            explanationFile: findExplanationFor(imgFile.name)
        })).filter(item => item.explanationFile);

        if (explanations.length > 0) {
            const explPages = Math.ceil(explanations.length / 4);
            for (let p = 0; p < explPages; p++) {
                const pageExpl = explanations.slice(p * 4, p * 4 + 4);
                html += `<div class="exam-page"><div class="problem-grid">`;
                for (let i = 0; i < 4; i++) {
                    if (i < pageExpl.length) {
                        const item = pageExpl[i];
                        const u = URL.createObjectURL(item.explanationFile);
                        html += `<div class="problem-cell">
                            <div class="problem-header"><span class="number">í•´ì„¤ ${item.problemNumber}</span></div>
                            <div class="image-container" style="max-height:none; flex:1;"><img src="${u}" class="problem-image" style="max-height:none;"></div>
                        </div>`;
                    } else {
                        html += `<div class="problem-cell" style="border:none;"></div>`;
                    }
                }
                html += `</div></div>`;
            }
        }

        // ì •ë‹µí‘œ
        if (showAnswerSheet && setImages.length > 0) {
            const answers = setImages.map((img, idx) => ({ num: idx + 1, answer: findAnswer(img) }));
            const quarterCount = Math.ceil(answers.length / 4);
            const col1 = answers.slice(0, quarterCount);
            const col2 = answers.slice(quarterCount, quarterCount * 2);
            const col3 = answers.slice(quarterCount * 2, quarterCount * 3);
            const col4 = answers.slice(quarterCount * 3);

            html += `<div class="exam-page"><div style="padding:6mm;">
                <h2 style="text-align:center; margin-bottom:12px; border-bottom:2px solid #333; padding-bottom:6px; font-size:14pt;">ğŸ“‹ ì •ë‹µí‘œ â€” ${setLabel}</h2>
                <table style="width:100%; border-collapse:collapse; font-size:10pt; table-layout:fixed;">
                    <thead><tr style="background:#f0f0f0;">
                        <th style="border:1px solid #333; padding:4px; width:8%;">ë²ˆí˜¸</th>
                        <th style="border:1px solid #333; padding:4px; width:17%;">ì •ë‹µ</th>
                        <th style="border:1px solid #333; padding:4px; width:8%;">ë²ˆí˜¸</th>
                        <th style="border:1px solid #333; padding:4px; width:17%;">ì •ë‹µ</th>
                        <th style="border:1px solid #333; padding:4px; width:8%;">ë²ˆí˜¸</th>
                        <th style="border:1px solid #333; padding:4px; width:17%;">ì •ë‹µ</th>
                        <th style="border:1px solid #333; padding:4px; width:8%;">ë²ˆí˜¸</th>
                        <th style="border:1px solid #333; padding:4px; width:17%;">ì •ë‹µ</th>
                    </tr></thead><tbody>`;

            for (let i = 0; i < quarterCount; i++) {
                html += `<tr>`;
                [col1, col2, col3, col4].forEach(col => {
                    if (col[i]) {
                        html += `<td style="border:1px solid #333; padding:3px; text-align:center; font-weight:bold; font-size:9pt;">${col[i].num}</td>
                                 <td style="border:1px solid #333; padding:3px; text-align:center; font-size:10pt;">${col[i].answer}</td>`;
                    } else {
                        html += `<td style="border:1px solid #333; padding:3px;"></td><td style="border:1px solid #333; padding:3px;"></td>`;
                    }
                });
                html += `</tr>`;
            }
            html += `</tbody></table></div></div>`;
        }

        // íšŒì°¨ êµ¬ë¶„ì„  (ë§ˆì§€ë§‰ íšŒì°¨ ì œì™¸)
        if (s < setCount - 1) {
            html += `<div style="page-break-after:always;"></div>`;
        }

        fullHTML += html;

        // QRìš© ë¬¸ì œ ë°ì´í„° ì €ì¥
        allSetData.push({
            setIndex: s,
            setLabel,
            setTitle,
            qrContainerId,
            problems: setImages.map((img, idx) => ({
                number: idx + 1,
                filename: img.name,
                correctAnswer: findAnswer(img)
            }))
        });
    }

    // DOMì— ì „ì²´ HTML ì‚½ì…
    document.getElementById('quizSheet').innerHTML = fullHTML;
    updateAnswerButtons();

    // ê° íšŒì°¨ë³„ QR ìƒì„± â€” ê¸°ì¡´ generateAndInsertQR ì¬ì‚¬ìš© (containerId ì§€ì •)
    if (includeQR && typeof QRCode !== 'undefined') {
        setTimeout(async () => {
            for (const setData of allSetData) {
                await generateAndInsertQR(setData.problems, setData.setTitle, currentStudent, setData.qrContainerId, setData.setIndex);
            }
        }, 300);
    }

    // ì„¸íŠ¸ ì „ì²´ ì €ì¥ (ê° íšŒì°¨ë¥¼ ê°œë³„ testPaperë¡œ ì €ì¥)
    const baseTime = Date.now();
    const examTitleVal = document.getElementById('examTitle').value || 'ì˜¤ë‹µ í•™ìŠµ ë¬¸ì œì§€';
    const testType = document.getElementById('testType').value;
    loadTestPapers();
    allSetData.forEach((setData, idx) => {
        const testId = `test_${baseTime + idx}`;
        testPapers[testId] = {
            id: testId,
            studentName: currentStudent,
            title: setData.setTitle,
            type: testType,
            date: new Date().toISOString().split('T')[0],
            problems: setData.problems.map(p => ({
                number: p.number,
                filename: p.filename,
                correctAnswer: p.correctAnswer,
                bookName: extractBookNameFromPath(allImages.find(img => img.name === p.filename)?.webkitRelativePath || p.filename),
                problemNum: extractProblemNumber(p.filename),
                difficulty: extractDifficulty(p.filename)
            })),
            status: 'ë¯¸ì±„ì ',
            createdAt: new Date(baseTime + idx * 1000).toISOString()
        };
    });
    localStorage.setItem('testPapers', JSON.stringify(testPapers));

    showStatus(`âœ… ${setCount}íšŒë¶„ ì„¸íŠ¸ ìƒì„± ì™„ë£Œ! ì¸ì‡„í•˜ë©´ ì „ì²´ ì¶œë ¥ë©ë‹ˆë‹¤.`, true);
}

// ===== ğŸ†• NíšŒë¶„ ì„¸íŠ¸ ìƒì„± ë =====

async function generateQuiz() {  // â­ async ì¶”ê°€!
    if (!currentStudent) {
        showStatus('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
        return;
    }
    if (allImages.length === 0) {
        showStatus('ë¨¼ì € ì´ë¯¸ì§€ í´ë”ë¥¼ ì„ íƒí•˜ì„¸ìš”.', false);
        return;
    }

    const filter = document.getElementById('filterInput').value.trim();
    const sortMode = document.querySelector('input[name="sortMode"]:checked').value;
    const weakOnly = document.getElementById('weakOnly').checked;
    const includeReview = document.getElementById('includeReview').checked;
    const includeMaster = document.getElementById('includeMaster').checked;
    const quizPerPage = parseInt(document.getElementById('quizPerPage').value);
    const totalPages = parseInt(document.getElementById('totalPages').value);
    const totalQuizCount = quizPerPage * totalPages;

    // í•„í„°ë§: ë¨¼ì € ê¸°ë³¸ filteredImages ì„¤ì •
    let filteredImages = allImages.slice();

   if (filter) {
    // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì—¬ëŸ¬ í‚¤ì›Œë“œ ì§€ì›
    const keywords = filter.split(',').map(k => k.trim().toLowerCase()).filter(k => k);
    
    filteredImages = filteredImages.filter(img => {
        const fileName = img.name.toLowerCase();
        // OR ì¡°ê±´: í‚¤ì›Œë“œ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ ì„ íƒ
        return keywords.some(keyword => fileName.includes(keyword));
    });
    
    if (filteredImages.length === 0) {
        showStatus(`í•„í„° "${filter}"ì— í•´ë‹¹í•˜ëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. (ì´ ${allImages.length}ê°œ ì¤‘)`, false);
        return;
    }
    
    showStatus(`í•„í„° ì ìš©: ${filteredImages.length}ê°œ ì´ë¯¸ì§€ ì„ íƒë¨`, true);
}

    // ë ˆë²¨ í•„í„° ì ìš© (í•™ìƒ ê¸°ë¡ ê¸°ë°˜)
    const data = JSON.parse(localStorage.getItem(`student_${currentStudent}`) || '{}');
    if (weakOnly || includeReview || includeMaster) {
        let allowed = [];
        if (weakOnly) allowed = ['ì·¨ì•½ë¬¸ì œ'];
        else {
            if (!includeReview && !includeMaster) allowed = ['ì·¨ì•½ë¬¸ì œ'];
            if (includeReview) allowed.push('ë³µìŠµí•„ìš”');
            if (includeMaster) allowed.push('ì™„ì „ì •ë³µ');
            if (!allowed.includes('ì·¨ì•½ë¬¸ì œ')) allowed.push('ì·¨ì•½ë¬¸ì œ');
        }
        filteredImages = filteredImages.filter(img => {
            const level = data[img.name]?.level || 'ì·¨ì•½ë¬¸ì œ';
            return allowed.includes(level);
        });
    }

    // ë¬¸ì œìš© ì´ë¯¸ì§€ëŠ” 'í•´ì„¤'ì´ë¦„ì„ ê°€ì§„ íŒŒì¼ ì œì™¸
    filteredImages = filteredImages.filter(img => !img.name.toLowerCase().includes('í•´ì„¤'));

    if (filteredImages.length === 0) {
        showStatus('ì¡°ê±´ì— ë§ëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤. (í•´ì„¤ ì´ë¯¸ì§€ëŠ” ë¬¸ì œë¡œ í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)', false);
        return;
    }

    // â”€â”€ ìµœê·¼ ì¶œì œ ë¬¸ì œ ì œì™¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const excludeRecent = document.getElementById('excludeRecent').checked;
    if (excludeRecent && currentStudent) {
        const days = parseInt(document.getElementById('excludeDays').value) || 7;
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);

        // testPapersì—ì„œ ìµœê·¼ ì¶œì œëœ íŒŒì¼ëª… ìˆ˜ì§‘
        loadTestPapers();
        const recentFilenames = new Set();
        Object.values(testPapers).forEach(test => {
            if (test.studentName !== currentStudent) return;
            const testDate = new Date(test.createdAt);
            if (testDate < cutoff) return;
            (test.problems || []).forEach(p => recentFilenames.add(p.filename));
        });

        if (recentFilenames.size > 0) {
            const beforeCount = filteredImages.length;
            filteredImages = filteredImages.filter(img => !recentFilenames.has(img.name));
            const excluded = beforeCount - filteredImages.length;
            const statusEl = document.getElementById('excludeRecentStatus');
            if (statusEl) statusEl.textContent = `(${excluded}ê°œ ìµœê·¼ ì¶œì œ ì œì™¸ë¨)`;
            if (filteredImages.length === 0) {
                showStatus(`âš ï¸ ìµœê·¼ ${days}ì¼ ì´ë‚´ ì¶œì œë˜ì§€ ì•Šì€ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ì œì™¸ ì˜µì…˜ì„ í•´ì œí•˜ê±°ë‚˜ ê¸°ê°„ì„ ì¤„ì—¬ë³´ì„¸ìš”.`, false);
                return;
            }
        }
    } else {
        const statusEl = document.getElementById('excludeRecentStatus');
        if (statusEl) statusEl.textContent = '';
    }
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const actualQuizCount = Math.min(totalQuizCount, filteredImages.length);
    if (actualQuizCount < totalQuizCount) {
        showStatus(`âš ï¸ ${filteredImages.length}ê°œë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (ìš”ì²­: ${totalQuizCount}ê°œ)`, true);
    }

const useDifficultyFilter = document.getElementById('useDifficultyFilter').checked;
let selectedImages;

if (useDifficultyFilter) {
    // ë‚œì´ë„ë³„ ë¬¸ì œ ìˆ˜ ì¶”ì¶œ
    const difficulties = ['ëŒ€í‘œë¬¸ì œ', 'í•˜', 'ì¤‘í•˜', 'ì¤‘', 'ì¤‘ìƒ', 'ìƒ', 'Cë‹¨ê³„', '3ì ', '4ì ', 'ë¯¸ë¶„ë¥˜'];
    selectedImages = [];
    
    difficulties.forEach(diff => {
        const count = parseInt(document.getElementById(`diff_${diff}`)?.value) || 0;
        if (count > 0) {
            // í•´ë‹¹ ë‚œì´ë„ ë¬¸ì œ í•„í„°ë§
            const diffImages = filteredImages.filter(img => {
                const fileName = img.name.toLowerCase();
                const d = diff.toLowerCase();
                // Cë‹¨ê³„ëŠ” '_cë‹¨ê³„' ë˜ëŠ” '-cë‹¨ê³„' ë˜ëŠ” '_c' '-c' íŒ¨í„´
                if (diff === 'Cë‹¨ê³„') {
                    return fileName.includes('_cë‹¨ê³„.png') || fileName.includes('-cë‹¨ê³„.png') ||
                           fileName.includes('_c.png')    || fileName.includes('-c.png');
                }
                // 3ì , 4ì 
                if (diff === '3ì ' || diff === '4ì ') {
                    return fileName.includes(`_${d}.png`) || fileName.includes(`-${d}.png`) ||
                           fileName.includes(`_${d}`);
                }
                return fileName.includes(`_${d}.png`) || fileName.includes(`-${d}.png`);
            });
            
            // ëœë¤ ë˜ëŠ” ì •ë ¬ ì„ íƒ
            let picked;
            if (sortMode === 'sorted') {
                picked = diffImages.sort((a,b) => a.name.localeCompare(b.name)).slice(0, count);
            } else {
                picked = diffImages.sort(() => Math.random() - 0.5).slice(0, count);
            }
            
            selectedImages.push(...picked);
        }
    });
    
    if (selectedImages.length === 0) {
        showStatus('âš ï¸ ì§€ì •í•œ ë‚œì´ë„ì˜ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.', false);
        return;
    }
    
} else {
    // ê¸°ì¡´ ë¡œì§ (í˜ì´ì§€ë‹¹ ë¬¸ì œ ìˆ˜ ë°©ì‹)
    if (sortMode === 'sorted') {
        selectedImages = filteredImages.sort((a,b)=> a.name.localeCompare(b.name)).slice(0, actualQuizCount);
    } else {
        selectedImages = filteredImages.sort(()=> Math.random()-0.5).slice(0, actualQuizCount);
    }
}



     currentQuizImages = selectedImages;
    
    // ğŸ†• ì´ë¯¸ì§€ ë¹„ìœ¨ ë¶„ì„ (ì´ ë¶€ë¶„ì„ ì¶”ê°€)
    const imageRatios = await Promise.all(
        selectedImages.map(img => analyzeImageRatio(img))
    );

    const today = new Date().toLocaleDateString('ko-KR', { year:'numeric', month:'long', day:'numeric' });
    const examTitle = document.getElementById('examTitle').value || 'ì˜¤ë‹µ í•™ìŠµ ë¬¸ì œì§€';

    // helper: í•´ì„¤ ì°¾ê¸° (ë¬¸ì œ íŒŒì¼ëª… ê¸°ë°˜)
    function findExplanationFor(originalName) {
        const base = originalName.replace(/\.png$/i,'').toLowerCase();
        // ìš°ì„  ë™ì¼íŒŒì¼ëª… í¬í•¨ + 'í•´ì„¤' í¬í•¨
        let cand = allImages.find(f => f.name.toLowerCase().includes('í•´ì„¤') && f.name.toLowerCase().includes(base));
        if (cand) return cand;
        // ë¶€ë¶„í‚¤ì›Œë“œ ë§¤ì¹­ (ì–¸ë”ìŠ¤ì½”ì–´/ëŒ€ì‹œ/ìŠ¤í˜ì´ìŠ¤ë¡œ ë¶„ë¦¬í•œ í† í°ë“¤ë¡œ ì‹œë„)
        const parts = base.split(/[_\- ]+/).filter(Boolean);
        for (let p of parts) {
            cand = allImages.find(f => f.name.toLowerCase().includes('í•´ì„¤') && f.name.toLowerCase().includes(p));
            if (cand) return cand;
        }
        return null;
    }

    // í™”ë©´ ê·¸ë¦¬ê¸° ì‹œì‘
    // Ã­â„¢"Ã«Â©Â´ ÃªÂ·Â¸Ã«Â¦Â¬ÃªÂ¸Â° Ã¬â€¹Å“Ã¬Å¾'
    let html = '';
    let problemNumber = 1;
    const showFilename = document.getElementById('showFilename').checked;
    const includeQR = document.getElementById('includeQR') ? document.getElementById('includeQR').checked : true;

   // ğŸ†• 2ë¬¸ì œ/4ë¬¸ì œ ë ˆì´ì•„ì›ƒ ë¶„ê¸° ì²˜ë¦¬
for (let page = 0; page < totalPages; page++) {
    const start = page * quizPerPage;
    const end = start + quizPerPage;
    const pageImages = selectedImages.slice(start, end);

    if (pageImages.length === 0) break;

    // í˜ì´ì§€ë‹¹ 2ë¬¸ì œì¸ ê²½ìš°: ì¢Œìš° 2ë‹¨ ë ˆì´ì•„ì›ƒ
    if (quizPerPage === 2) {
        // ì²«í˜ì´ì§€ì— ì œëª© ì¶”ê°€
        if (page === 0) {
            html += `
            <div class="first-page">
                <div class="exam-header" style="display:flex; align-items:center; justify-content:center; position:relative;">
                    <div class="exam-title" style="flex:1; text-align:center;">${examTitle}</div>
                    ${includeQR ? `<div id="qrCodeContainer" style="position:absolute; right:0; top:50%; transform:translateY(-50%); width:22mm; height:22mm;"></div>` : ''}
                </div>
                <div class="problem-grid two-column">
            `;
        } else {
            html += `<div class="exam-page"><div class="problem-grid two-column">`;
        }

        // 2ë¬¸ì œ ë°°ì¹˜
        for (let i = 0; i < pageImages.length; i++) {
            const imgFile = pageImages[i];
            const imgURL = URL.createObjectURL(imgFile);
            const filename = imgFile.name.replace(/\.png$/i, '');
            
            html += `
            <div class="problem-cell">
                <div class="answer-check">
                    <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', true)">âœ…</button>
                    <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', false)">âŒ</button>
                </div>
                <div class="problem-header">
                    <span class="number">ë¬¸ì œ ${problemNumber}</span>
                    ${showFilename ? `<span class="filename">${filename}</span>` : ''}
                </div>
                <div class="image-container">
                    <img src="${imgURL}" class="problem-image" alt="ë¬¸ì œ ${problemNumber}">
                </div>
                <div class="solution-area">
                    <div class="solution-label">&lt;í’€ì´&gt;</div>
                </div>
            </div>
            `;
            problemNumber++;
        }
        
        html += `</div></div>`;
    } 
    // í˜ì´ì§€ë‹¹ 4ë¬¸ì œì¸ ê²½ìš°: ê¸°ì¡´ 2x2 ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ
    else if (quizPerPage === 4) {
        const pageRatios = imageRatios.slice(start, end);
        console.log(`í˜ì´ì§€ ${page + 1} - ì´ë¯¸ì§€ ë¹„ìœ¨:`, pageRatios);

        // ì²«í˜ì´ì§€ì— ì œëª© ì¶”ê°€
        if (page === 0) {
            html += `
            <div class="first-page">
                <div class="exam-header" style="display:flex; align-items:center; justify-content:center; position:relative;">
                    <div class="exam-title" style="flex:1; text-align:center;">${examTitle}</div>
                    ${includeQR ? `<div id="qrCodeContainer" style="position:absolute; right:0; top:50%; transform:translateY(-50%); width:22mm; height:22mm;"></div>` : ''}
                </div>
                <div class="problem-grid">
            `;
        } else {
            html += `<div class="exam-page"><div class="problem-grid">`;
        }

        // ğŸ†• ë™ì  ë°°ì¹˜ ë¡œì§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    let i = 0;
    let gridPosition = 0;
    
    while (i < pageImages.length && gridPosition < 4) {
        const imgFile = pageImages[i];
        const ratio = pageRatios[i];
        const imgURL = URL.createObjectURL(imgFile);
        const filename = imgFile.name.replace(/\.png$/i, '');
        
        // ì„¸ë¡œë¡œ ê¸´ ì´ë¯¸ì§€ì¸ ê²½ìš° (ì™¼ìª½ ì—´ì—ë§Œ ë°°ì¹˜)
        if (ratio === 'tall' && gridPosition % 2 === 0) {
            html += `
            <div class="problem-cell tall-cell">
                <div class="answer-check">
                    <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', true)">âœ…</button>
                    <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', false)">âŒ</button>
                </div>
                <div class="problem-header">
                    <span class="number">ë¬¸ì œ ${problemNumber}</span>
                    ${showFilename ? `<span class="filename">${filename}</span>` : ''}
                </div>
                <div class="image-container">
                    <img src="${imgURL}" class="problem-image" alt="ë¬¸ì œ ${problemNumber}">
                </div>
                <div class="solution-area">
                    <div class="solution-label">&lt;í’€ì´&gt;</div>
                </div>
            </div>
            `;
            problemNumber++;
            i++;
            gridPosition += 2; // ì„¸ë¡œ 2ì¹¸ ì°¨ì§€
        } 
        // ì¼ë°˜ ì´ë¯¸ì§€
        else {
            html += `
            <div class="problem-cell">
                <div class="answer-check">
                    <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', true)">âœ…</button>
                    <button class="check-btn" onclick="markAnswer('${imgFile.name.replace(/'/g,"\\'")}', false)">âŒ</button>
                </div>
                <div class="problem-header">
                    <span class="number">ë¬¸ì œ ${problemNumber}</span>
                    ${showFilename ? `<span class="filename">${filename}</span>` : ''}
                </div>
                <div class="image-container">
                    <img src="${imgURL}" class="problem-image" alt="ë¬¸ì œ ${problemNumber}">
                </div>
                <div class="solution-area">
                    <div class="solution-label">&lt;í’€ì´&gt;</div>
                </div>
            </div>
            `;
            problemNumber++;
            i++;
            gridPosition++;
        }
    }
    
    // ë¹ˆ ì¹¸ ì±„ìš°ê¸°
    while (gridPosition < 4) {
        html += `<div class="problem-cell empty-cell"></div>`;
        gridPosition++;
    }

    html += `</div></div>`;
    } // 4ë¬¸ì œ ë ˆì´ì•„ì›ƒ ì¢…ë£Œ
}

    // í•´ì„¤ ë§¤í•‘ (ë¬¸ì œ ìˆœì„œëŒ€ë¡œ) â€” í•´ì„¤ì€ ë¬¸ì œ ë’¤(ë§ˆì§€ë§‰)ì— ë¶™ìŒ
    // í•´ì„¤ í˜ì´ì§€ ìƒì„± (2x2 ê·¸ë¦¬ë“œ)
    const explanations = selectedImages.map((imgFile, idx) => {
        return { problemNumber: idx + 1, explanationFile: findExplanationFor(imgFile.name) };
    }).filter(item => item.explanationFile);

    if (explanations.length > 0) {
        const explPages = Math.ceil(explanations.length / 4);
        
        for (let p = 0; p < explPages; p++) {
            const explStart = p * 4;
            const pageExpl = explanations.slice(explStart, explStart + 4);
            
            html += `<div class="exam-page"><div class="problem-grid">`;
            
            for (let i = 0; i < 4; i++) {
                if (i < pageExpl.length) {
                    const item = pageExpl[i];
                    const u = URL.createObjectURL(item.explanationFile);
                    html += `
                    <div class="problem-cell">
                        <div class="problem-header">
                            <span class="number">í•´ì„¤ ${item.problemNumber}</span>
                        </div>
                        <div class="image-container" style="max-height:none; flex:1;">
                            <img src="${u}" class="problem-image" style="max-height:none;">
                        </div>
                    </div>
                    `;
                } else {
                    html += `<div class="problem-cell" style="border:none;"></div>`;
                }
            }
            
            html += `</div></div>`;
        }
    }

// â­ ì—¬ê¸°ì— ìƒˆë¡œìš´ ì½”ë“œ ì¶”ê°€! â­
    
    // ì •ë‹µí‘œ ìƒì„± (4ë‹¨ ë¶„í• )
    const showAnswerSheet = document.getElementById('showAnswerSheet').checked;
    if (showAnswerSheet && selectedImages.length > 0) {
        // ì •ë‹µ ë°ì´í„° ì¤€ë¹„
        const answers = selectedImages.map((img, idx) => ({
            num: idx + 1,
            answer: findAnswer(img)
        }));
        
        // 4ë‹¨ìœ¼ë¡œ ë¶„í• 
        const quarterCount = Math.ceil(answers.length / 4);
        const col1 = answers.slice(0, quarterCount);
        const col2 = answers.slice(quarterCount, quarterCount * 2);
        const col3 = answers.slice(quarterCount * 2, quarterCount * 3);
        const col4 = answers.slice(quarterCount * 3);
        
        html += `
        <div class="exam-page">
            <div style="padding: 6mm;">
                <h2 style="text-align:center; margin-bottom:12px; border-bottom:2px solid #333; padding-bottom:6px; font-size:14pt;">ğŸ“‹ ì •ë‹µí‘œ</h2>
                
                <table style="width:100%; border-collapse:collapse; font-size:10pt; table-layout:fixed;">
                    <thead>
                        <tr style="background:#f0f0f0;">
                            <th style="border:1px solid #333; padding:4px; width:8%;">ë²ˆí˜¸</th>
                            <th style="border:1px solid #333; padding:4px; width:17%;">ì •ë‹µ</th>
                            <th style="border:1px solid #333; padding:4px; width:8%;">ë²ˆí˜¸</th>
                            <th style="border:1px solid #333; padding:4px; width:17%;">ì •ë‹µ</th>
                            <th style="border:1px solid #333; padding:4px; width:8%;">ë²ˆí˜¸</th>
                            <th style="border:1px solid #333; padding:4px; width:17%;">ì •ë‹µ</th>
                            <th style="border:1px solid #333; padding:4px; width:8%;">ë²ˆí˜¸</th>
                            <th style="border:1px solid #333; padding:4px; width:17%;">ì •ë‹µ</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        // í–‰ ë‹¨ìœ„ë¡œ ì¶œë ¥
        for (let i = 0; i < quarterCount; i++) {
            html += `<tr>`;
            
            // 1ì—´
            if (col1[i]) {
                html += `
                    <td style="border:1px solid #333; padding:3px; text-align:center; font-weight:bold; font-size:9pt;">${col1[i].num}</td>
                    <td style="border:1px solid #333; padding:3px; text-align:center; font-size:10pt; word-break:keep-all; overflow:hidden; text-overflow:ellipsis;">${col1[i].answer}</td>
                `;
            } else {
                html += `<td style="border:1px solid #333; padding:3px;"></td><td style="border:1px solid #333; padding:3px;"></td>`;
            }
            
            // 2ì—´
            if (col2[i]) {
                html += `
                    <td style="border:1px solid #333; padding:3px; text-align:center; font-weight:bold; font-size:9pt;">${col2[i].num}</td>
                    <td style="border:1px solid #333; padding:3px; text-align:center; font-size:10pt; word-break:keep-all; overflow:hidden; text-overflow:ellipsis;">${col2[i].answer}</td>
                `;
            } else {
                html += `<td style="border:1px solid #333; padding:3px;"></td><td style="border:1px solid #333; padding:3px;"></td>`;
            }
            
            // 3ì—´
            if (col3[i]) {
                html += `
                    <td style="border:1px solid #333; padding:3px; text-align:center; font-weight:bold; font-size:9pt;">${col3[i].num}</td>
                    <td style="border:1px solid #333; padding:3px; text-align:center; font-size:10pt; word-break:keep-all; overflow:hidden; text-overflow:ellipsis;">${col3[i].answer}</td>
                `;
            } else {
                html += `<td style="border:1px solid #333; padding:3px;"></td><td style="border:1px solid #333; padding:3px;"></td>`;
            }
            
            // 4ì—´
            if (col4[i]) {
                html += `
                    <td style="border:1px solid #333; padding:3px; text-align:center; font-weight:bold; font-size:8pt;">${col4[i].num}</td>
                    <td style="border:1px solid #333; padding:3px; text-align:center; font-size:10pt; word-break:keep-all; overflow:hidden; text-overflow:ellipsis;">${col4[i].answer}</td>
                `;
            } else {
                html += `<td style="border:1px solid #333; padding:3px;"></td><td style="border:1px solid #333; padding:3px;"></td>`;
            }
            
            html += `</tr>`;
        }
        
        html += `
                    </tbody>
                </table>
                
                <div style="margin-top:15px; padding:10px; background:#fff3e0; border-radius:5px; font-size:9pt; color:#666;">
                    ğŸ’¡ <strong>ì±„ì  íŒ:</strong> í•œ í˜ì´ì§€ë‹¹ 4ë¬¸ì œì”© ì¶œì œë˜ë¯€ë¡œ, ì •ë‹µí‘œë„ 4ì—´ë¡œ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                </div>
            </div>
        </div>
        `;
    }

              

// ê²°ê³¼ ë°˜ì˜ ë° UI ì—…ë°ì´íŠ¸
    document.getElementById('quizSheet').innerHTML = html;
    updateAnswerButtons();
    
    // QR ì½”ë“œ ìƒì„± (DOM ë Œë” í›„ ì‹¤í–‰)
    const includeQRCheck = document.getElementById('includeQR') ? document.getElementById('includeQR').checked : true;
    if (includeQRCheck && typeof QRCode !== 'undefined') {
        setTimeout(() => {
            generateAndInsertQR(
                selectedImages.map((img, idx) => ({
                    number: idx + 1,
                    correctAnswer: findAnswer(img)
                })),
                examTitle,
                currentStudent
            );
        }, 300);
    }
    
    // â­ ì—¬ê¸°ë¶€í„° ì¶”ê°€! â­
    // í˜„ì¬ ìƒì„±ëœ ì‹œí—˜ì§€ ì •ë³´ ì„ì‹œ ì €ì¥
    currentTestData = {
        studentName: currentStudent,
        problems: selectedImages.map((img, idx) => ({
            number: idx + 1,
            filename: img.name,
            bookName: extractBookNameFromPath(img.webkitRelativePath || img.name),
            problemNum: extractProblemNumber(img.name),
            difficulty: extractDifficulty(img.name),
            correctAnswer: findAnswer(img)
        })),
        createdAt: new Date().toISOString()
    };
    
    // ì €ì¥ ëª¨ë‹¬ í‘œì‹œ
    showSaveTestModal();
    // â­ ì—¬ê¸°ê¹Œì§€ ì¶”ê°€! â­
}

        
        // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
        function exportData() {
            if (!currentStudent) {
                showStatus('í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            const data = localStorage.getItem(`student_${currentStudent}`);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentStudent}_í•™ìŠµë°ì´í„°_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showStatus('ë°ì´í„°ë¥¼ ë‚´ë³´ëƒˆìŠµë‹ˆë‹¤.', true);
        }
        
        // ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const name = prompt('ë¶ˆëŸ¬ì˜¬ í•™ìƒ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
                    if (!name) return;
                    
                    localStorage.setItem(`student_${name}`, JSON.stringify(data));
                    const students = JSON.parse(localStorage.getItem('students') || '[]');
                    if (!students.includes(name)) {
                        students.push(name);
                        localStorage.setItem('students', JSON.stringify(students));
                    }
                    
                    loadStudents();
                    showStatus('ë°ì´í„°ë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤.', true);
                } catch (err) {
                    showStatus('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', false);
                }
            };
            reader.readAsText(file);
        }
        
        // ì „ì²´ ì´ˆê¸°í™”
        function resetAllData() {
            if (!confirm('ëª¨ë“  í•™ìƒì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            localStorage.clear();
            currentStudent = '';
            allImages = [];
            loadStudents();
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('quizSheet').innerHTML = '';
            showStatus('ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
        }
        
// â­ ì—¬ê¸°ë¶€í„° ì¶”ê°€! â­

// CSV íŒŒì¼ ë¡œë“œ
function loadCSVFiles(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    let loadedCount = 0;
    
    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const text = e.target.result;
            const bookName = file.name.replace('.csv', '');
            
            // â­ CSV íŒŒì‹± (ì‰¼í‘œê°€ í¬í•¨ëœ ì •ë‹µ ì²˜ë¦¬) â­
            const lines = text.split('\n').filter(line => line.trim());
            const data = {};
            
            for (let i = 1; i < lines.length; i++) { // ì²« ì¤„(í—¤ë”) ì œì™¸
                const line = lines[i].trim();
                if (!line) continue;
                
                // ì²« ë²ˆì§¸ ì‰¼í‘œ ìœ„ì¹˜ ì°¾ê¸°
                const firstCommaIndex = line.indexOf(',');
                if (firstCommaIndex === -1) continue;
                
                // ë²ˆí˜¸ì™€ ì •ë‹µ ë¶„ë¦¬
                const numStr = line.substring(0, firstCommaIndex).trim();
                let answer = line.substring(firstCommaIndex + 1).trim();
                
                // ë”°ì˜´í‘œ ì œê±°
                if (answer.startsWith('"') && answer.endsWith('"')) {
                    answer = answer.substring(1, answer.length - 1);
                }
                
                const num = parseInt(numStr);
if (!isNaN(num)) {
    // ì›ë³¸ ë²ˆí˜¸ì™€ 0 íŒ¨ë”©ëœ ë²ˆí˜¸ ë‘˜ ë‹¤ ì €ì¥
    data[num] = answer;  // 40, 41, 42 ë“±
    data[numStr] = answer;  // "0040", "0041" ë“± (ì›ë³¸ ë¬¸ìì—´)
}
            }
            
            csvDataMap[bookName] = data;
            loadedCount++;
            
            if (loadedCount === files.length) {
                updateCSVStatus();
                showStatus(`âœ… ${loadedCount}ê°œì˜ ì •ë‹µ íŒŒì¼ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, true);
            }
        };
        reader.readAsText(file, 'UTF-8');
    });
}

// CSV ìƒíƒœ ì—…ë°ì´íŠ¸
function updateCSVStatus() {
    const status = document.getElementById('csvStatus');
    const list = document.getElementById('csvList');
    
    if (Object.keys(csvDataMap).length === 0) {
        status.style.display = 'none';
        return;
    }
    
    status.style.display = 'block';
    let html = '';
    
    Object.keys(csvDataMap).forEach(bookName => {
        const count = Object.keys(csvDataMap[bookName]).length;
        html += `<div style="display:inline-block; margin:3px; padding:5px 10px; background:#e3f2fd; border-radius:15px;">
            ğŸ“š ${bookName} (${count}ê°œ)
        </div>`;
    });
    
    list.innerHTML = html;
}

// CSV ë°ì´í„° ì´ˆê¸°í™”
function clearCSVData() {
    if (confirm('ë¶ˆëŸ¬ì˜¨ ëª¨ë“  ì •ë‹µ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        csvDataMap = {};
        updateCSVStatus();
        showStatus('ì •ë‹µ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
    }
}

// íŒŒì¼ëª…ì—ì„œ ë¬¸ì œë²ˆí˜¸ ì¶”ì¶œ
function extractProblemNumber(filename) {
    // ë‹¤ì–‘í•œ íŒ¨í„´ ì‹œë„
    
    // íŒ¨í„´ 1: "RPM3-1_2.ê·¼í˜¸ë¥¼í¬í•¨í•œì‹ì˜ê³„ì‚°-05-ì¤‘.png" â†’ 5
    let match = filename.match(/-(\d+)-[^-]+\.png$/i);
    if (match) {
        return parseInt(match[1]); // ì•ì˜ 0 ì œê±°
    }
    
    // íŒ¨í„´ 2: "RPM_0038.jpg" ë˜ëŠ” "ìˆ_40.jpg" â†’ 38 ë˜ëŠ” 40
    match = filename.match(/_(\d+)\./i);
    if (match) {
        return parseInt(match[1]); // ì•ì˜ 0 ì œê±°
    }
    
    // íŒ¨í„´ 3: "RPM0038.jpg" (ì–¸ë”ìŠ¤ì½”ì–´ ì—†ì´)
    match = filename.match(/[A-Za-zê°€-í£]+(\d+)\./i);
    if (match) {
        return parseInt(match[1]);
    }
    
    return null;
}

// íŒŒì¼ëª…ì—ì„œ êµì¬ëª… ì¶”ì¶œ
function extractBookName(filename) {
    // "RPM3-1_2.ê·¼í˜¸ë¥¼í¬í•¨í•œì‹ì˜ê³„ì‚°-05-ì¤‘.png" â†’ "RPMì¤‘3-1"
    // ë˜ëŠ” webkitRelativePathì—ì„œ ì¶”ì¶œ
    const match = filename.match(/^([^_]+)/);
    if (match) {
        let bookName = match[1];
        // "RPM3-1" â†’ "RPMì¤‘3-1" ë³€í™˜ (ì¤‘í•™êµë§Œ í•´ë‹¹)
        bookName = bookName.replace(/^RPM(\d)-/, 'RPMì¤‘$1-');
        return bookName;
    }
    return null;
}

// ì •ë‹µ ì°¾ê¸°
function findAnswer(imgFile) {
    const problemNum = extractProblemNumber(imgFile.name);
    if (problemNum === null) return 'ì •ë‹µì—†ìŒ';
    
    // webkitRelativePathì—ì„œ êµì¬ í´ë”ëª… ì¶”ì¶œ
    const path = imgFile.webkitRelativePath || imgFile.name;
    const pathParts = path.split('/');
    
    // í´ë” êµ¬ì¡°: ë¬¸ì œì€í–‰/ì¤‘3/RPMì¤‘3-1/1.ì œê³±ê·¼/íŒŒì¼.png
    let bookName = null;
    for (let i = 0; i < pathParts.length; i++) {
    // CSV íŒŒì¼ëª…ê³¼ ë§¤ì¹­ë˜ëŠ” í´ë”ëª… ì°¾ê¸°
    if (csvDataMap[pathParts[i]]) {
        bookName = pathParts[i];
        break;
    }
}
    
    if (!bookName) {
        bookName = extractBookName(imgFile.name);
    }
    
    if (bookName && csvDataMap[bookName]) {
    return csvDataMap[bookName][problemNum] || csvDataMap[bookName][String(problemNum).padStart(4, '0')] || 'ì •ë‹µì—†ìŒ';
}
    
    return 'ì •ë‹µì—†ìŒ';
}


       

// â­ ì—¬ê¸°ë¶€í„° ì¶”ê°€! â­

// íŒŒì¼ ê²½ë¡œì—ì„œ êµì¬ëª… ì¶”ì¶œ
function extractBookNameFromPath(path) {
    const pathParts = path.split('/');
    for (let i = 0; i < pathParts.length; i++) {
        if (pathParts[i].includes('RPM') || pathParts[i].includes('ê°œë…ì›ë¦¬')) {
            return pathParts[i];
        }
    }
    return extractBookName(path);
}

// íŒŒì¼ëª…ì—ì„œ ë‚œì´ë„ ì¶”ì¶œ
function extractDifficulty(filename) {
    const diffPattern = /-(ëŒ€í‘œë¬¸ì œ|í•˜|ì¤‘í•˜|ì¤‘|ì¤‘ìƒ|ìƒ)\.png$/i;
    const match = filename.match(diffPattern);
    return match ? match[1] : 'ë¯¸ë¶„ë¥˜';
}

// ===== GitHub Pages + QR ê¸°ëŠ¥ =====

// GitHub ì„¤ì • í† ê¸€
function toggleGithubSettings() {
    const panel = document.getElementById('githubSettingsPanel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

// GitHub ì„¤ì • ì €ì¥
function saveGithubSettings() {
    const username = document.getElementById('githubUsername').value.trim();
    const repo = document.getElementById('githubRepo').value.trim();
    const token = document.getElementById('githubToken').value.trim();
    if (!username || !repo || !token) { alert('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
    localStorage.setItem('gh_username', username);
    localStorage.setItem('gh_repo', repo);
    localStorage.setItem('gh_token', token);
    updateGithubStatus();
    alert('âœ… GitHub ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
}

// GitHub ì„¤ì • ë¡œë“œ (ì•± ì‹œì‘ ì‹œ ìë™ ë³µì› â€” ì¬ì—°ë™ ë¶ˆí•„ìš”)
function loadGithubSettings() {
    const u = localStorage.getItem('gh_username') || '';
    const r = localStorage.getItem('gh_repo') || '';
    const t = localStorage.getItem('gh_token') || '';
    if (document.getElementById('githubUsername')) {
        document.getElementById('githubUsername').value = u;
        document.getElementById('githubRepo').value = r;
        document.getElementById('githubToken').value = t;
    }
    updateGithubStatus();

    // ì €ì¥ëœ ì„¤ì •ì´ ìˆìœ¼ë©´ ì¡°ìš©íˆ ë°±ê·¸ë¼ìš´ë“œ ê²€ì¦
    if (u && r && t) {
        silentGithubVerify(u, r, t);
    }
}

// ì•± ì‹œì‘ ì‹œ GitHub ì—°ê²° ìƒíƒœë¥¼ ì¡°ìš©íˆ ê²€ì¦ (íŒì—… ì—†ìŒ)
async function silentGithubVerify(username, repo, token) {
    try {
        const res = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
            headers: { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json' }
        });
        const el = document.getElementById('githubStatus');
        if (!el) return;
        if (res.ok) {
            el.textContent = 'âœ… ìë™ ì—°ê²°ë¨: ' + username + '/' + repo;
            el.style.color = '#4CAF50';
        } else {
            el.textContent = 'âš ï¸ ì—°ê²° ì˜¤ë¥˜ â€” ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”';
            el.style.color = '#e53935';
        }
    } catch(e) {
        // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œ ì¡°ìš©íˆ ë¬´ì‹œ (ì˜¤í”„ë¼ì¸ í™˜ê²½ ë“±)
    }
}

function updateGithubStatus() {
    const u = localStorage.getItem('gh_username');
    const r = localStorage.getItem('gh_repo');
    const el = document.getElementById('githubStatus');
    if (el) {
        if (u && r) {
            el.textContent = 'âœ… ' + u + '/' + r;
            el.style.color = '#4CAF50';
        } else {
            el.textContent = 'ë¯¸ì„¤ì •';
            el.style.color = '#888';
        }
    }
}

// GitHub ì—°ê²° í…ŒìŠ¤íŠ¸
async function testGithubConnection() {
    const username = localStorage.getItem('gh_username');
    const repo = localStorage.getItem('gh_repo');
    const token = localStorage.getItem('gh_token');
    if (!username || !repo || !token) { alert('ë¨¼ì € GitHub ì„¤ì •ì„ ì €ì¥í•´ì£¼ì„¸ìš”.'); return; }
    try {
        const res = await fetch(`https://api.github.com/repos/${username}/${repo}`, {
            headers: { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (res.ok) {
            const data = await res.json();
            alert('âœ… ì—°ê²° ì„±ê³µ!\nì €ì¥ì†Œ: ' + data.full_name + '\nPages: ' + (data.has_pages ? 'í™œì„±í™”ë¨' : 'âš ï¸ Pages ë¯¸í™œì„± â€” repo Settings > Pagesì—ì„œ í™œì„±í™” í•„ìš”'));
        } else {
            alert('âŒ ì—°ê²° ì‹¤íŒ¨ (' + res.status + ')\nToken ë˜ëŠ” ì €ì¥ì†Œëª…ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
    } catch(e) {
        alert('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ' + e.message);
    }
}

// ì •ë‹µ JSONì„ GitHubì— ì—…ë¡œë“œí•˜ê³  Pages URL ë°˜í™˜
// QR ìƒì„± ë©”ì¸ â€” GitHub ì—°ë™ ì‹œ URL QR, ë¯¸ì—°ë™ ì‹œ ì½”ë“œ í…ìŠ¤íŠ¸ QR
async function generateAndInsertQR(problems, examTitle, studentName, containerId, setIndex) {
    const id = containerId || 'qrCodeContainer';
    const container = document.getElementById(id);
    if (!container) { console.warn('QR ì»¨í…Œì´ë„ˆ ì—†ìŒ:', id); return; }
    container.innerHTML = '<div style="font-size:8px;color:#888;text-align:center;padding:4px;">QR ìƒì„± ì¤‘...</div>';

    const username = localStorage.getItem('gh_username');
    const repo = localStorage.getItem('gh_repo');
    const token = localStorage.getItem('gh_token');
    const hasGithub = username && repo && token;

    let qrText = '';

    if (hasGithub) {
        // fileId: íƒ€ì„ìŠ¤íƒ¬í”„ + íšŒì°¨ì¸ë±ìŠ¤ + ëœë¤ â†’ ì ˆëŒ€ ê²¹ì¹˜ì§€ ì•ŠìŒ
        const idxPart = (setIndex !== undefined) ? setIndex : Math.floor(Math.random()*999);
        const randPart = Math.random().toString(36).slice(2, 7);
        const fileId = Date.now().toString(36) + String(idxPart) + randPart;
        const filename = 'answers/' + fileId + '.json';

        const payload = {
            title: examTitle, student: studentName,
            date: new Date().toLocaleDateString('ko-KR'),
            problems: problems.map(p => ({
                number: p.number,
                answer: (p.correctAnswer && p.correctAnswer !== 'ì •ë‹µì—†ìŒ') ? p.correctAnswer : ''
            }))
        };
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));

        try {
            const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'token ' + token,
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: 'ì‹œí—˜ì§€ ì •ë‹µ ì—…ë¡œë“œ: ' + examTitle, content })
            });
            if (res.ok) {
                qrText = `https://${username}.github.io/${repo}/grading.html?id=${fileId}`;
                console.log('ì—…ë¡œë“œ ì„±ê³µ! QR URL:', qrText);
            } else {
                const err = await res.json();
                console.error('GitHub ì—…ë¡œë“œ ì‹¤íŒ¨:', err);
                qrText = buildAnswerCode(problems, examTitle, studentName);
            }
        } catch(e) {
            console.error('GitHub ì—…ë¡œë“œ ì˜¤ë¥˜:', e);
            qrText = buildAnswerCode(problems, examTitle, studentName);
        }
    } else {
        qrText = buildAnswerCode(problems, examTitle, studentName);
        console.log('QR ì½”ë“œ(GitHub ë¯¸ì—°ë™):', qrText);
    }

    // QR ë Œë”ë§ â€” ì™„ë£Œë  ë•Œê¹Œì§€ awaitìœ¼ë¡œ ëŒ€ê¸°
    container.innerHTML = '';
    await new Promise((resolve) => {
        try {
            const qr = new QRCode(container, {
                text: qrText,
                width: 84, height: 84,
                colorDark: '#000000', colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.L
            });
            // QRCode.jsëŠ” ë‚´ë¶€ì ìœ¼ë¡œ setTimeoutì„ ì¨ì„œ ë Œë”ë§í•˜ë¯€ë¡œ 100ms ëŒ€ê¸°
            setTimeout(resolve, 100);
        } catch(e) {
            console.error('QR ìƒì„± ì˜¤ë¥˜:', e);
            container.innerHTML = '<div style="font-size:7px;color:red;text-align:center">QRì˜¤ë¥˜</div>';
            resolve();
        }
    });
    console.log('QR ìƒì„± ì™„ë£Œ:', id);
}
    } catch(e) {
        console.error('QR ìƒì„± ì˜¤ë¥˜:', e);
        container.innerHTML = '<div style="font-size:7px;color:red;text-align:center">QRì˜¤ë¥˜</div>';
    }
}

// ì •ë‹µì½”ë“œ ìƒì„± (GitHub ë¯¸ì—°ë™ í´ë°±ìš©)
function buildAnswerCode(problems, examTitle, studentName) {
    const ansStr = problems.map(p => {
        const a = (p.correctAnswer && p.correctAnswer !== 'ì •ë‹µì—†ìŒ') ? p.correctAnswer : '?';
        return p.number + ':' + a;
    }).join(',');
    return 'A' + examTitle.substring(0,12) + '|B' + studentName.substring(0,5) + '|' + ansStr;
}

// ì •ë‹µì½”ë“œ íŒŒì‹± â€” GitHub URL ëª¨ë“œ + í…ìŠ¤íŠ¸ ì½”ë“œ í´ë°± ëª¨ë“œ ì§€ì›
function parseAnswerCode(code) {
    try {
        // GitHub Pages URL ëª¨ë“œ: https://username.github.io/repo/grading.html?id=fileId
        if (code.startsWith('http')) {
            const url = new URL(code);
            const fileId = url.searchParams.get('id');
            if (!fileId) return null;
            // URLì—ì„œ username/repo ì¶”ì¶œ: username.github.io/repo/...
            const hostParts = url.hostname.split('.');  // ['username','github','io']
            const pathParts = url.pathname.split('/').filter(Boolean); // ['repo','grading.html']
            const username = hostParts[0];
            const repo = pathParts[0];
            // fileIdì™€ username/repo ì €ì¥í•´ì„œ ë‚˜ì¤‘ì— fetchì— í™œìš©
            return { _mode: 'github', fileId, username, repo, title: '', student: '', problems: [] };
        }
        // í…ìŠ¤íŠ¸ ì½”ë“œ í´ë°± ëª¨ë“œ: Aì œëª©|Bí•™ìƒ|1:ë‹µ,2:ë‹µ,...
        const parts = code.split('|');
        if (parts.length < 3) return null;
        const title = parts[0].replace(/^A/, '');
        const student = parts[1].replace(/^B/, '');
        const answerStr = parts.slice(2).join('|');
        const problems = answerStr.split(',').map(p => {
            const idx = p.indexOf(':');
            if (idx < 0) return null;
            return { number: parseInt(p.substring(0, idx)), answer: p.substring(idx + 1) };
        }).filter(Boolean);
        return { _mode: 'text', title, student, problems };
    } catch(e) { return null; }
}

// initì—ì„œ GitHub ì„¤ì • ë¡œë“œ
const _origInit = window.onload;
window.onload = function() {
    if (typeof init === 'function') init();
    loadGithubSettings();
};

// ===== GitHub Pages + QR ê¸°ëŠ¥ ë =====

// ì €ì¥ ëª¨ë‹¬ í‘œì‹œ
function showSaveTestModal() {
    if (!currentTestData) return;
    
    const examTitle = document.getElementById('examTitle').value || 'ì˜¤ë‹µ í•™ìŠµ ë¬¸ì œì§€';
    const testType = document.getElementById('testType').value;
    const today = new Date().toLocaleDateString('ko-KR');
    
    document.getElementById('modalStudentName').textContent = currentTestData.studentName;
    document.getElementById('modalTestTitle').textContent = examTitle;
    document.getElementById('modalTestType').textContent = testType;
    document.getElementById('modalProblemCount').textContent = currentTestData.problems.length;
    document.getElementById('modalTestDate').textContent = today;
    
    document.getElementById('saveTestModal').style.display = 'flex';
}

// ì €ì¥ ëª¨ë‹¬ ë‹«ê¸°
function closeSaveModal() {
    document.getElementById('saveTestModal').style.display = 'none';
    currentTestData = null;
}

// ì €ì¥í•˜ê³  ì¸ì‡„
function saveAndPrint() {
    if (!currentTestData) return;
    
    // ì‹œí—˜ì§€ ì €ì¥
    const testId = 'test_' + Date.now();
    const examTitle = document.getElementById('examTitle').value || 'ì˜¤ë‹µ í•™ìŠµ ë¬¸ì œì§€';
    const testType = document.getElementById('testType').value;
    
    const testPaper = {
        id: testId,
        studentName: currentTestData.studentName,
        title: examTitle,
        type: testType,
        date: new Date().toISOString().split('T')[0],
        problems: currentTestData.problems,
        status: 'ë¯¸ì±„ì ',
        createdAt: currentTestData.createdAt
    };
    
    // localStorageì— ì €ì¥
    loadTestPapers();
    testPapers[testId] = testPaper;
    localStorage.setItem('testPapers', JSON.stringify(testPapers));
    
    showStatus(`âœ… ì‹œí—˜ì§€ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: ${testId})`, true);
    closeSaveModal();
    
    // ì¸ì‡„ ì°½ ì—´ê¸°
    setTimeout(() => window.print(), 500);
}

// ì €ì¥ ì•ˆ í•˜ê³  ì¸ì‡„ë§Œ
function printOnly() {
    closeSaveModal();
    showStatus('âš ï¸ ì‹œí—˜ì§€ë¥¼ ì €ì¥í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì±„ì  ê¸°ë¡ì„ ë‚¨ê¸°ë ¤ë©´ ì €ì¥ì´ í•„ìš”í•©ë‹ˆë‹¤.', false);
    setTimeout(() => window.print(), 500);
}

// ì‹œí—˜ì§€ ë°ì´í„° ë¡œë“œ
function loadTestPapers() {
    const saved = localStorage.getItem('testPapers');
    testPapers = saved ? JSON.parse(saved) : {};
}

// ì±„ì  ëŒ€ê¸° ëª©ë¡ í‘œì‹œ
function showGradingList() {
    loadTestPapers();
    
    // í•™ìƒ í•„í„° ì˜µì…˜ ì—…ë°ì´íŠ¸
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    const filterSelect = document.getElementById('filterStudent');
    filterSelect.innerHTML = '<option value="">ì „ì²´ í•™ìƒ</option>';
    students.forEach(name => {
        filterSelect.innerHTML += `<option value="${name}">${name}</option>`;
    });
    
    document.getElementById('gradingListPanel').style.display = 'block';
    document.getElementById('quizSheet').style.display = 'none';
    
    filterGradingList();
}

// ì±„ì  ëª©ë¡ í•„í„°ë§ ë° í‘œì‹œ
function filterGradingList() {
    const filterStudent = document.getElementById('filterStudent').value;
    const filterStatus = document.getElementById('filterStatus').value;
    const filterType = document.getElementById('filterType').value;
    
    let filteredTests = Object.values(testPapers);
    
    if (filterStudent) {
        filteredTests = filteredTests.filter(t => t.studentName === filterStudent);
    }
    if (filterStatus) {
        filteredTests = filteredTests.filter(t => t.status === filterStatus);
    }
    if (filterType) {
        filteredTests = filteredTests.filter(t => t.type === filterType);
    }
    
    // ë‚ ì§œ ìµœì‹ ìˆœ ì •ë ¬
    filteredTests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    
    displayGradingList(filteredTests);
}

// ì±„ì  ëª©ë¡ í™”ë©´ì— í‘œì‹œ
function displayGradingList(tests) {
    const container = document.getElementById('gradingListContent');
    
    if (tests.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#999; padding:40px;">ì±„ì  ëŒ€ê¸° ì¤‘ì¸ ì‹œí—˜ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    let html = '';
    
    tests.forEach(test => {
        const statusColor = test.status === 'ë¯¸ì±„ì ' ? '#FF9800' : '#4CAF50';
        const statusIcon = test.status === 'ë¯¸ì±„ì ' ? 'â³' : 'âœ…';
        const date = new Date(test.createdAt).toLocaleDateString('ko-KR');
        
        html += `
            <div style="border:1px solid #ddd; border-radius:8px; padding:15px; margin-bottom:15px; background:#f9f9f9;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="flex:1;">
                        <h3 style="margin:0 0 10px 0;">${test.studentName} - ${test.title}</h3>
                        <div style="font-size:13px; color:#666;">
                            <span>${test.problems.length}ë¬¸ì œ</span> | 
                            <span>ìœ í˜•: ${test.type}</span> | 
                            <span>ì¶œì œ: ${date}</span>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="display:inline-block; padding:5px 12px; background:${statusColor}; color:white; border-radius:15px; font-size:12px; margin-bottom:10px;">
                            ${statusIcon} ${test.status}
                        </div>
                        <div>
                            ${test.status === 'ë¯¸ì±„ì ' ? 
                                `<button class="btn" style="padding:8px 15px; margin:2px;" onclick="startGrading('${test.id}')">ğŸ“ ì±„ì  ì‹œì‘</button>` :
                                `<button class="btn btn-export" style="padding:8px 15px; margin:2px;" onclick="viewGrading('${test.id}')">ğŸ‘ï¸ ê²°ê³¼ ë³´ê¸°</button>
                                 <button class="btn" style="padding:8px 15px; margin:2px;" onclick="editGrading('${test.id}')">âœï¸ ìˆ˜ì •</button>`
                            }
                            <button class="btn btn-danger" style="padding:8px 15px; margin:2px;" onclick="deleteTest('${test.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ì±„ì  ëª©ë¡ ë‹«ê¸°
function closeGradingList() {
    document.getElementById('gradingListPanel').style.display = 'none';
    document.getElementById('quizSheet').style.display = 'block';
}

// ì‹œí—˜ì§€ ì‚­ì œ
function deleteTest(testId) {
    if (!confirm('ì´ ì‹œí—˜ì§€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    loadTestPapers();
    delete testPapers[testId];
    localStorage.setItem('testPapers', JSON.stringify(testPapers));
    
    showStatus('ì‹œí—˜ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', true);
    filterGradingList();
}

// ì±„ì  ì‹œì‘
function startGrading(testId) {
    loadTestPapers();
    currentGradingTest = testPapers[testId];
    
    if (!currentGradingTest) {
        showStatus('ì‹œí—˜ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', false);
        return;
    }
    
    // ê¸°ì¡´ ì±„ì  ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸° (ìˆìœ¼ë©´)
    loadGradingResults();
    const existingResult = gradingResultsDB[testId];
    
    if (existingResult) {
        if (!confirm('ì´ë¯¸ ì±„ì ëœ ì‹œí—˜ì§€ì…ë‹ˆë‹¤. ë‹¤ì‹œ ì±„ì í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê¸°ì¡´ ê²°ê³¼ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤)')) {
            return;
        }
        gradingResults = existingResult.results.map(r => ({...r})); // ë³µì‚¬
    } else {
        gradingResults = [];
    }
    
    currentProblemIndex = 0;
    
    // í™”ë©´ ì „í™˜
    document.getElementById('gradingListPanel').style.display = 'none';
    document.getElementById('gradingPanel').style.display = 'block';
    document.getElementById('quizSheet').style.display = 'none';
    
    // ì œëª© ì„¤ì •
    document.getElementById('gradingTitle').textContent = `${currentGradingTest.studentName} - ${currentGradingTest.title} ì±„ì `;
    document.getElementById('gradingSubtitle').textContent = `${currentGradingTest.problems.length}ë¬¸ì œ | ${currentGradingTest.type} | ${currentGradingTest.date}`;
    
    // ì²« ë¬¸ì œ í‘œì‹œ
    displayCurrentProblem();
    
    // ì…ë ¥ í¬ì»¤ìŠ¤
    document.getElementById('studentAnswer').focus();
}

// í˜„ì¬ ë¬¸ì œ í‘œì‹œ
function displayCurrentProblem() {
    if (currentProblemIndex >= currentGradingTest.problems.length) {
        completeGrading();
        return;
    }
    
    const problem = currentGradingTest.problems[currentProblemIndex];
    const existingGrade = gradingResults[currentProblemIndex];
    
    // ë¬¸ì œ ì •ë³´ í‘œì‹œ
    document.getElementById('currentProblemNum').textContent = problem.number;
    document.getElementById('currentFilename').textContent = problem.filename;
    document.getElementById('currentBookName').textContent = problem.bookName || 'ì•Œ ìˆ˜ ì—†ìŒ';
    document.getElementById('currentDifficulty').textContent = problem.difficulty || 'ë¯¸ë¶„ë¥˜';
    document.getElementById('currentCorrectAnswer').textContent = problem.correctAnswer;
    
    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    const progress = ((currentProblemIndex / currentGradingTest.problems.length) * 100).toFixed(0);
    document.getElementById('gradingProgress').style.width = progress + '%';
    document.getElementById('gradingProgressText').textContent = `${currentProblemIndex}/${currentGradingTest.problems.length}`;
    
    // ì´ì „ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    document.getElementById('prevBtn').disabled = currentProblemIndex === 0;
    
    // ê¸°ì¡´ ì±„ì  ê²°ê³¼ ë¶ˆëŸ¬ì˜¤ê¸°
    if (existingGrade) {
        document.getElementById('studentAnswer').value = existingGrade.studentAnswer || '';
        
        const resultRadio = document.querySelector(`input[name="resultType"][value="${existingGrade.result}"]`);
        if (resultRadio) {
            resultRadio.checked = true;
            updateResultOptions();
        }
        
        const categoryRadio = document.querySelector(`input[name="detailCategory"][value="${existingGrade.detailCategory}"]`);
        if (categoryRadio) {
            categoryRadio.checked = true;
        }
        
        document.getElementById('gradingMemo').value = existingGrade.memo || '';
    } else {
        // ì´ˆê¸°í™”
        document.getElementById('studentAnswer').value = '';
        document.querySelectorAll('input[name="resultType"]').forEach(r => r.checked = false);
        document.querySelectorAll('input[name="detailCategory"]').forEach(r => r.checked = false);
        document.getElementById('gradingMemo').value = '';
        document.getElementById('detailCategorySection').style.display = 'none';
    }
    
    document.getElementById('studentAnswer').focus();
}

// ì •ë‹µ/ì˜¤ë‹µ ì„ íƒ ì‹œ ì„¸ë¶€ ì¹´í…Œê³ ë¦¬ í‘œì‹œ
function updateResultOptions() {
    const result = document.querySelector('input[name="resultType"]:checked')?.value;
    
    if (!result) {
        document.getElementById('detailCategorySection').style.display = 'none';
        return;
    }
    
    document.getElementById('detailCategorySection').style.display = 'block';
    
    if (result === 'ì •ë‹µ') {
        document.getElementById('correctCategories').style.display = 'block';
        document.getElementById('wrongCategories').style.display = 'none';
        // ê¸°ë³¸ê°’ ì„ íƒ
        document.querySelector('input[name="detailCategory"][value="ì •í™•í•œí’€ì´"]').checked = true;
    } else {
        document.getElementById('correctCategories').style.display = 'none';
        document.getElementById('wrongCategories').style.display = 'block';
        // ë¼ë””ì˜¤ ì„ íƒ í•´ì œ
        document.querySelectorAll('#wrongCategories input[name="detailCategory"]').forEach(r => r.checked = false);
    }
}

// ë‹µì•ˆ ì œì¶œ (ë‹¤ìŒ ë¬¸ì œë¡œ)
function submitAnswer() {
    const studentAnswer = document.getElementById('studentAnswer').value.trim();
    const result = document.querySelector('input[name="resultType"]:checked')?.value;
    const detailCategory = document.querySelector('input[name="detailCategory"]:checked')?.value;
    const memo = document.getElementById('gradingMemo').value.trim();
    
    // ìœ íš¨ì„± ê²€ì‚¬
    if (!result) {
        alert('ì •ë‹µ/ì˜¤ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!detailCategory) {
        alert('ì„¸ë¶€ ë¶„ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ê²°ê³¼ ì €ì¥
    const problem = currentGradingTest.problems[currentProblemIndex];
    gradingResults[currentProblemIndex] = {
        problemNumber: problem.number,
        filename: problem.filename,
        correctAnswer: problem.correctAnswer,
        studentAnswer: studentAnswer,
        result: result,
        detailCategory: detailCategory,
        memo: memo
    };
    
    // ë‹¤ìŒ ë¬¸ì œë¡œ
    currentProblemIndex++;
    displayCurrentProblem();
}

// ì´ì „ ë¬¸ì œë¡œ
function previousProblem() {
    if (currentProblemIndex > 0) {
        currentProblemIndex--;
        displayCurrentProblem();
    }
}

// ì„ì‹œ ì €ì¥
function saveTempGrading() {
    const testId = currentGradingTest.id;
    
    loadGradingResults();
    gradingResultsDB[testId] = {
        testId: testId,
        studentName: currentGradingTest.studentName,
        gradedAt: new Date().toISOString(),
        results: gradingResults,
        status: 'ì„ì‹œì €ì¥',
        currentIndex: currentProblemIndex
    };
    
    localStorage.setItem('gradingResults', JSON.stringify(gradingResultsDB));
    showStatus('ğŸ’¾ ì„ì‹œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.', true);
}

// ì±„ì  ì™„ë£Œ
function completeGrading() {
    if (!confirm(`ì±„ì ì„ ì™„ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ${currentGradingTest.problems.length}ë¬¸ì œ ì¤‘ ${gradingResults.length}ë¬¸ì œ ì±„ì ë¨`)) {
        return;
    }
    
    // í†µê³„ ê³„ì‚°
    let correctCount = 0;
    let wrongCount = 0;
    
    gradingResults.forEach(r => {
        if (r.result === 'ì •ë‹µ') correctCount++;
        else wrongCount++;
    });
    
    const score = Math.round((correctCount / currentGradingTest.problems.length) * 100);
    
    // ì±„ì  ê²°ê³¼ ì €ì¥
    const testId = currentGradingTest.id;
    loadGradingResults();
    
    gradingResultsDB[testId] = {
        testId: testId,
        studentName: currentGradingTest.studentName,
        gradedAt: new Date().toISOString(),
        results: gradingResults,
        correctCount: correctCount,
        wrongCount: wrongCount,
        score: score,
        totalProblems: currentGradingTest.problems.length
    };
    
    localStorage.setItem('gradingResults', JSON.stringify(gradingResultsDB));
    
    // ì‹œí—˜ì§€ ìƒíƒœ ì—…ë°ì´íŠ¸
    loadTestPapers();
    testPapers[testId].status = 'ì±„ì ì™„ë£Œ';
    localStorage.setItem('testPapers', JSON.stringify(testPapers));
    
    // í•™ìƒ ë°ì´í„° ì—…ë°ì´íŠ¸
    updateStudentData(currentGradingTest.studentName, gradingResults, testId);
    
    showStatus(`âœ… ì±„ì  ì™„ë£Œ! ì ìˆ˜: ${score}ì  (${correctCount}/${currentGradingTest.problems.length})`, true);
    
    // ì±„ì  ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    exitGrading();
}

// í•™ìƒ ë°ì´í„° ì—…ë°ì´íŠ¸ (ëˆ„ì )
function updateStudentData(studentName, results, testId) {
    const key = `student_${studentName}`;
    let data = JSON.parse(localStorage.getItem(key) || '{}');
    
    results.forEach(result => {
        const filename = result.filename;
        
        if (!data[filename]) {
            data[filename] = {
                level: 'ì·¨ì•½ë¬¸ì œ',
                correctStreak: 0,
                totalCorrect: 0,
                totalWrong: 0,
                history: []
            };
        }
        
        const isCorrect = result.result === 'ì •ë‹µ';
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        if (isCorrect) {
            data[filename].correctStreak++;
            data[filename].totalCorrect++;
            
            // ë ˆë²¨ ì¡°ì •
            if (data[filename].correctStreak >= 3) {
                data[filename].level = 'ì™„ì „ì •ë³µ';
            } else if (data[filename].correctStreak >= 1) {
                data[filename].level = 'ë³µìŠµí•„ìš”';
            }
        } else {
            data[filename].correctStreak = 0;
            data[filename].totalWrong++;
            data[filename].level = 'ì·¨ì•½ë¬¸ì œ';
        }
        
        // íˆìŠ¤í† ë¦¬ ì¶”ê°€
        data[filename].history.push({
            date: new Date().toLocaleDateString('ko-KR'),
            testId: testId,
            result: isCorrect ? 'correct' : 'wrong',
            category: result.detailCategory,
            memo: result.memo || ''
        });
    });
    
    localStorage.setItem(key, JSON.stringify(data));
}

// ì±„ì  ê²°ê³¼ DB ë¡œë“œ
function loadGradingResults() {
    const saved = localStorage.getItem('gradingResults');
    gradingResultsDB = saved ? JSON.parse(saved) : {};
}

// ì±„ì  ì¢…ë£Œ
function exitGrading() {
    if (currentProblemIndex > 0 && currentProblemIndex < currentGradingTest.problems.length) {
        if (!confirm('ì±„ì ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì§„í–‰ ìƒí™©ì€ ì„ì‹œì €ì¥ë©ë‹ˆë‹¤)')) {
            return;
        }
        saveTempGrading();
    }
    
    currentGradingTest = null;
    currentProblemIndex = 0;
    gradingResults = [];
    
    document.getElementById('gradingPanel').style.display = 'none';
    showGradingList();
}

// â­ ì—¬ê¸°ë¶€í„° ì¶”ê°€! â­

// í•™ìŠµ ë¶„ì„ í™”ë©´ í‘œì‹œ
function showAnalysis() {
    if (!currentStudent) {
        alert('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    // í•™ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    const select = document.getElementById('analysisStudent');
    select.innerHTML = '<option value="">í•™ìƒ ì„ íƒ</option>';
    students.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (name === currentStudent) opt.selected = true;
        select.appendChild(opt);
    });
    
    // í™”ë©´ ì „í™˜
    document.getElementById('analysisPanel').style.display = 'block';
    document.getElementById('gradingListPanel').style.display = 'none';
    document.getElementById('gradingPanel').style.display = 'none';
    document.getElementById('quizSheet').style.display = 'none';
    
    loadAnalysisData();
}

// í•™ìŠµ ë¶„ì„ í™”ë©´ í‘œì‹œ
function showAnalysis() {
    if (!currentStudent) {
        alert('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    // í•™ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    const select = document.getElementById('analysisStudent');
    select.innerHTML = '<option value="">í•™ìƒ ì„ íƒ</option>';
    students.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        if (name === currentStudent) opt.selected = true;
        select.appendChild(opt);
    });
    
    // í™”ë©´ ì „í™˜
    document.getElementById('analysisPanel').style.display = 'block';
    document.getElementById('gradingListPanel').style.display = 'none';
    document.getElementById('gradingPanel').style.display = 'none';
    document.getElementById('quizSheet').style.display = 'none';
    
    loadAnalysisData();
}

// í•™ìŠµ ë¶„ì„ì„ ìƒˆ ì°½ìœ¼ë¡œ ì—´ê¸°
function openAnalysisWindow() {
    // í•™ìƒ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const students = JSON.parse(localStorage.getItem('students') || '[]');
    
    if (students.length === 0) {
        alert('ë“±ë¡ëœ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í•™ìƒì„ ì¶”ê°€í•˜ì„¸ìš”.');
        return;
    }
    
    // ëª¨ë‹¬ ì°½ ìƒì„±
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; display:flex; align-items:center; justify-content:center;';
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = 'background:white; padding:30px; border-radius:12px; max-width:400px; width:90%; box-shadow:0 4px 20px rgba(0,0,0,0.3);';
    
    modalContent.innerHTML = `
        <h2 style="margin-top:0; color:#333;">ğŸ“Š í•™ìŠµ ë¶„ì„</h2>
        <p style="color:#666; margin-bottom:20px;">ë¶„ì„í•  í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”</p>
        
        <div style="display:flex; flex-direction:column; gap:10px; margin-bottom:20px;">
            ${students.map(name => `
                <button class="student-select-btn" data-student="${name}" 
                    style="padding:15px; font-size:16px; background:#f0f7ff; border:2px solid #667eea; border-radius:8px; cursor:pointer; text-align:left; transition:all 0.2s;"
                    onmouseover="this.style.background='#667eea'; this.style.color='white';"
                    onmouseout="this.style.background='#f0f7ff'; this.style.color='black';">
                    ğŸ‘¤ ${name}
                </button>
            `).join('')}
        </div>
        
        <button onclick="this.closest('div[style*=fixed]').remove()" 
            style="width:100%; padding:10px; background:#f44336; color:white; border:none; border-radius:5px; cursor:pointer; font-size:14px;">
            âŒ ì·¨ì†Œ
        </button>
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    // í•™ìƒ ì„ íƒ ì´ë²¤íŠ¸
    modalContent.querySelectorAll('.student-select-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const selectedStudent = this.getAttribute('data-student');
            modal.remove();
            performAnalysis(selectedStudent);
        });
    });
}

// ë¶„ì„ ì‹¤í–‰
function performAnalysis(selectedStudent) {
    // í•™ìƒ ë°ì´í„° ì¤€ë¹„
    const studentData = JSON.parse(localStorage.getItem(`student_${selectedStudent}`) || '{}');
    loadGradingResults();
    loadTestPapers();
    const studentTests = Object.values(gradingResultsDB).filter(r => r.studentName === selectedStudent);
    
    if (studentTests.length === 0) {
        alert(`${selectedStudent} í•™ìƒì˜ ì‹œí—˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.`);
        return;
    }
    
    // ë¶„ì„ ë°ì´í„° ìƒì„±
    const analysis = analyzeStudentData(selectedStudent, studentData, studentTests, 'all');
    
    // ìƒˆ ì°½ ì—´ê¸°
    const newWindow = window.open('', '_blank', 'width=1200,height=800,scrollbars=yes');
    newWindow.document.write(generateAnalysisHTML(selectedStudent, analysis));
    newWindow.document.close();
}


// ë¶„ì„ HTML ìƒì„± (ìƒì„¸ ë²„ì „) - ì™„ì „í•œ ë²„ì „
// ì´ ì½”ë“œë¥¼ 2547ë²ˆ ë¼ì¸ë¶€í„° 2939ë²ˆ ë¼ì¸ê¹Œì§€ ì „ì²´ë¥¼ ì‚­ì œí•˜ê³  ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!

// ë¶„ì„ HTML ìƒì„± (ê°„ë‹¨ ë²„ì „ - ì˜¤ë¥˜ ì—†ìŒ)
function generateAnalysisHTML(studentName, analysis) {
    let contentHTML = '';
    
    // ì „ì²´ í†µê³„
    contentHTML += '<div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:25px;">';
    contentHTML += '<div style="background:#e3f2fd; padding:20px; border-radius:8px; text-align:center;">';
    contentHTML += '<div style="font-size:14px; color:#666; margin-bottom:8px;">ì´ ì‹œí—˜ íšŸìˆ˜</div>';
    contentHTML += '<div style="font-size:32px; font-weight:bold; color:#2196F3;">' + analysis.totalTests + 'íšŒ</div>';
    contentHTML += '</div>';
    contentHTML += '<div style="background:#e8f5e9; padding:20px; border-radius:8px; text-align:center;">';
    contentHTML += '<div style="font-size:14px; color:#666; margin-bottom:8px;">í‰ê·  ì ìˆ˜</div>';
    contentHTML += '<div style="font-size:32px; font-weight:bold; color:#4CAF50;">' + analysis.averageScore + 'ì </div>';
    contentHTML += '</div>';
    contentHTML += '<div style="background:#fff3e0; padding:20px; border-radius:8px; text-align:center;">';
    contentHTML += '<div style="font-size:14px; color:#666; margin-bottom:8px;">ì •ë‹µë¥ </div>';
    contentHTML += '<div style="font-size:32px; font-weight:bold; color:#FF9800;">' + Math.round((analysis.correctCount / analysis.totalProblems) * 100) + '%</div>';
    contentHTML += '</div>';
    contentHTML += '<div style="background:#fce4ec; padding:20px; border-radius:8px; text-align:center;">';
    contentHTML += '<div style="font-size:14px; color:#666; margin-bottom:8px;">ì°ì–´ì„œ ë§ì¶¤</div>';
    contentHTML += '<div style="font-size:32px; font-weight:bold; color:#E91E63;">' + analysis.luckyGuesses + 'íšŒ</div>';
    contentHTML += '</div>';
    contentHTML += '</div>';
    
    // ìµœê·¼ ì„±ì¥ ì¶”ì„¸
    if (analysis.recentImprovement) {
        const changeColor = analysis.recentImprovement.change >= 0 ? '#4CAF50' : '#f44336';
        const changeIcon = analysis.recentImprovement.change >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
        
        contentHTML += '<div style="background:#f0f7ff; padding:20px; border-radius:8px; margin-bottom:25px;">';
        contentHTML += '<h4 style="margin:0 0 15px 0;">ğŸ“Š ìµœê·¼ ì„±ì¥ ì¶”ì„¸</h4>';
        contentHTML += '<div style="display:flex; gap:20px; align-items:center;">';
        contentHTML += '<div><div style="font-size:13px; color:#666;">ì´ˆë°˜ í‰ê· </div>';
        contentHTML += '<div style="font-size:24px; font-weight:bold;">' + analysis.recentImprovement.oldAvg + 'ì </div></div>';
        contentHTML += '<div style="font-size:30px;">â†’</div>';
        contentHTML += '<div><div style="font-size:13px; color:#666;">ìµœê·¼ í‰ê· </div>';
        contentHTML += '<div style="font-size:24px; font-weight:bold;">' + analysis.recentImprovement.recentAvg + 'ì </div></div>';
        contentHTML += '<div style="margin-left:auto; text-align:center;"><div style="font-size:36px;">' + changeIcon + '</div>';
        contentHTML += '<div style="font-size:24px; font-weight:bold; color:' + changeColor + ';">';
        contentHTML += (analysis.recentImprovement.change >= 0 ? '+' : '') + analysis.recentImprovement.change + 'ì </div></div>';
        contentHTML += '</div></div>';
    }
    
    // ì£¼ìš” ì˜¤ë‹µ íŒ¨í„´
    contentHTML += '<div style="background:white; border:2px solid #f44336; border-radius:8px; padding:20px; margin-bottom:25px;">';
    contentHTML += '<h4 style="margin:0 0 15px 0; color:#f44336;">ğŸ”´ ì£¼ìš” ì˜¤ë‹µ íŒ¨í„´</h4>';
    
    const sortedErrors = Object.entries(analysis.errorPatterns).sort((a, b) => b[1] - a[1]);
    if (sortedErrors.length > 0) {
        sortedErrors.forEach(function(item, index) {
            const category = item[0];
            const count = item[1];
            const percent = Math.round((count / analysis.wrongCount) * 100);
            contentHTML += '<div style="margin-bottom:12px;">';
            contentHTML += '<div style="display:flex; justify-content:space-between; margin-bottom:5px;">';
            contentHTML += '<span style="font-weight:' + (index === 0 ? 'bold' : 'normal') + ';">' + (index + 1) + '. ' + category + '</span>';
            contentHTML += '<span style="color:#666;">' + count + 'íšŒ (' + percent + '%)</span></div>';
            contentHTML += '<div style="background:#f0f0f0; border-radius:10px; height:8px; overflow:hidden;">';
            contentHTML += '<div style="background:linear-gradient(90deg, #f44336, #e91e63); height:100%; width:' + percent + '%;"></div></div></div>';
        });
    } else {
        contentHTML += '<p style="color:#999; margin:0;">ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤! ğŸ‰</p>';
    }
    contentHTML += '</div>';
    
    // ë°˜ë³µ ì˜¤ë‹µ ë¬¸ì œ
    contentHTML += '<div style="background:#ffebee; border-radius:8px; padding:20px; margin-bottom:25px;">';
    contentHTML += '<h4 style="margin:0 0 15px 0; color:#d32f2f;">âš ï¸ ê¸´ê¸‰ ì ê²€ í•„ìš” (3íšŒ ì´ìƒ í‹€ë¦¼)</h4>';
    
    if (analysis.repeatErrors.length > 0) {
        analysis.repeatErrors.slice(0, 10).forEach(function(prob, index) {
            contentHTML += '<div style="background:white; padding:12px; border-radius:6px; margin-bottom:10px; border-left:4px solid #f44336;">';
            contentHTML += '<div style="display:flex; justify-content:space-between; align-items:center;">';
            contentHTML += '<div style="flex:1;"><div style="font-weight:bold; margin-bottom:4px;">' + (index + 1) + '. ' + prob.filename + '</div>';
            contentHTML += '<div style="font-size:12px; color:#666;">ì£¼ìš” ì˜¤ë‹µ: ' + prob.mainError + ' | ë§ˆì§€ë§‰: ' + prob.lastDate + '</div></div>';
            contentHTML += '<div style="text-align:right;"><div style="background:#f44336; color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:bold;">';
            contentHTML += prob.wrongCount + 'íšŒ í‹€ë¦¼</div></div></div></div>';
        });
    } else {
        contentHTML += '<p style="color:#999; margin:0;">ë°˜ë³µ ì˜¤ë‹µ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‘</p>';
    }
    contentHTML += '</div>';
    
    // ì¬í™•ì¸ í•„ìš”
    contentHTML += '<div style="background:#fff8e1; border-radius:8px; padding:20px; margin-bottom:25px;">';
    contentHTML += '<h4 style="margin:0 0 15px 0; color:#f57c00;">ğŸŸ¡ ì¬í™•ì¸ í•„ìš” (ì°ì–´ì„œ ë§ì¶¤ 2íšŒ ì´ìƒ)</h4>';
    
    if (analysis.needsReview.length > 0) {
        analysis.needsReview.slice(0, 10).forEach(function(prob, index) {
            contentHTML += '<div style="background:white; padding:12px; border-radius:6px; margin-bottom:10px; border-left:4px solid #FF9800;">';
            contentHTML += '<div style="font-weight:bold; margin-bottom:4px;">' + (index + 1) + '. ' + prob.filename + '</div>';
            contentHTML += '<div style="font-size:12px; color:#666;">ìµœê·¼ ' + prob.luckyCount + 'íšŒ ì°ì–´ì„œ ë§ì¶¤ | ë§ˆì§€ë§‰: ' + prob.lastDate + '</div></div>';
        });
    } else {
        contentHTML += '<p style="color:#999; margin:0;">ì¬í™•ì¸ í•„ìš”í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‘</p>';
    }
    contentHTML += '</div>';
    
    // ì˜¤ë˜ëœ ë¬¸ì œ
    contentHTML += '<div style="background:#e8f5e9; border-radius:8px; padding:20px; margin-bottom:25px;">';
    contentHTML += '<h4 style="margin:0 0 15px 0; color:#388e3c;">ğŸŸ¢ ì¥ê¸° ê¸°ì–µ ì ê²€ (10ì¼ ì´ìƒ ì•ˆ í’€ì–´ë´„)</h4>';
    
    if (analysis.oldProblems.length > 0) {
        analysis.oldProblems.slice(0, 10).forEach(function(prob, index) {
            contentHTML += '<div style="background:white; padding:12px; border-radius:6px; margin-bottom:10px; border-left:4px solid #4CAF50;">';
            contentHTML += '<div style="font-weight:bold; margin-bottom:4px;">' + (index + 1) + '. ' + prob.filename + '</div>';
            contentHTML += '<div style="font-size:12px; color:#666;">ë§ˆì§€ë§‰ í’€ì´: ' + prob.lastDate + ' (' + prob.daysSince + 'ì¼ ì „)</div></div>';
        });
    } else {
        contentHTML += '<p style="color:#999; margin:0;">ì˜¤ë˜ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!</p>';
    }
    contentHTML += '</div>';
    
    // HTML ë¬¸ì„œ ìƒì„±
    let html = '<!DOCTYPE html><html lang="ko"><head><meta charset="UTF-8">';
    html += '<title>' + studentName + ' í•™ìŠµ ë¶„ì„ ë³´ê³ ì„œ</title>';
    html += '<style>body { font-family: "Malgun Gothic", sans-serif; padding: 30px; background: #f5f5f5; margin: 0; }';
    html += '.container { max-width: 1000px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }';
    html += 'h1 { color: #333; border-bottom: 3px solid #667eea; padding-bottom: 15px; margin-top: 0; }';
    html += '@media print { body { background: white; padding: 0; } .container { box-shadow: none; margin: 0; } .no-print { display: none; } }</style>';
    html += '</head><body><div class="container">';
    html += '<h1>ğŸ“Š ' + studentName + ' í•™ìŠµ ë¶„ì„ ë³´ê³ ì„œ</h1>';
    html += '<p style="color:#666; text-align:right;">ìƒì„±ì¼: ' + new Date().toLocaleDateString('ko-KR') + ' ' + new Date().toLocaleTimeString('ko-KR') + '</p>';
    html += contentHTML;
    html += '<div style="margin-top:30px; text-align:center;" class="no-print">';
    html += '<button onclick="window.print()" style="padding:12px 30px; font-size:16px; background:#667eea; color:white; border:none; border-radius:5px; cursor:pointer; margin-right:10px;">ğŸ–¨ï¸ ì¸ì‡„í•˜ê¸°</button>';
    html += '<button onclick="window.close()" style="padding:12px 30px; font-size:16px; background:#f44336; color:white; border:none; border-radius:5px; cursor:pointer;">âŒ ë‹«ê¸°</button>';
    html += '</div></div></body></html>';
    
    return html;
}

// í•™ìŠµ ë¶„ì„ ë°ì´í„° ë¡œë“œ
function loadAnalysisData() {
    const studentName = document.getElementById('analysisStudent').value;
    const period = document.getElementById('analysisPeriod').value;
    
    if (!studentName) {
        document.getElementById('analysisContent').innerHTML = '<p style="text-align:center; color:#999; padding:40px;">í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.</p>';
        return;
    }
    
    // í•™ìƒ ë°ì´í„° ë¡œë“œ
    const studentData = JSON.parse(localStorage.getItem(`student_${studentName}`) || '{}');
    
    // ì±„ì  ê²°ê³¼ ë¡œë“œ
    loadGradingResults();
    loadTestPapers();
    
    // í•´ë‹¹ í•™ìƒì˜ ì‹œí—˜ ê²°ê³¼ë§Œ í•„í„°ë§
    const studentTests = Object.values(gradingResultsDB).filter(r => r.studentName === studentName);
    
    // ê¸°ê°„ í•„í„°ë§
    let cutoffDate = new Date();
    if (period !== 'all') {
        cutoffDate.setDate(cutoffDate.getDate() - parseInt(period));
    }
    
    const filteredTests = studentTests.filter(test => {
        if (period === 'all') return true;
        return new Date(test.gradedAt) >= cutoffDate;
    });
    
    // ë¶„ì„ ìƒì„±
    const analysis = analyzeStudentData(studentName, studentData, filteredTests, period);
    displayAnalysis(analysis, studentName);
}

// í•™ìƒ ë°ì´í„° ë¶„ì„
function analyzeStudentData(studentName, studentData, tests, period) {
    const analysis = {
        totalTests: tests.length,
        totalProblems: 0,
        correctCount: 0,
        wrongCount: 0,
        averageScore: 0,
        luckyGuesses: 0,
        errorPatterns: {},
        repeatErrors: [],
        needsReview: [],
        oldProblems: [],
        recentImprovement: null
    };
    
    if (tests.length === 0) {
        return analysis;
    }
    
    // ì „ì²´ í†µê³„
    let totalScore = 0;
    tests.forEach(test => {
        analysis.totalProblems += test.totalProblems;
        analysis.correctCount += test.correctCount;
        analysis.wrongCount += test.wrongCount;
        totalScore += test.score;
        
        // ê° ë¬¸ì œ ë¶„ì„
        test.results.forEach(result => {
            // ì°ì–´ì„œ ë§ì¶¤ ì¹´ìš´íŠ¸
            if (result.detailCategory === 'ì°ì–´ì„œë§ì¶¤') {
                analysis.luckyGuesses++;
            }
            
            // ì˜¤ë‹µ íŒ¨í„´
            if (result.result === 'ì˜¤ë‹µ') {
                if (!analysis.errorPatterns[result.detailCategory]) {
                    analysis.errorPatterns[result.detailCategory] = 0;
                }
                analysis.errorPatterns[result.detailCategory]++;
            }
        });
    });
    
    analysis.averageScore = Math.round(totalScore / tests.length);
    
    // ë¬¸ì œë³„ ìƒì„¸ ë¶„ì„
    Object.keys(studentData).forEach(filename => {
        const problemData = studentData[filename];
        const stats = problemData.history || [];
        
        // ë°˜ë³µ ì˜¤ë‹µ (3íšŒ ì´ìƒ í‹€ë¦¼)
        const wrongCount = stats.filter(h => h.result === 'wrong').length;
        if (wrongCount >= 3) {
            analysis.repeatErrors.push({
                filename: filename,
                wrongCount: wrongCount,
                lastDate: stats[stats.length - 1]?.date,
                mainError: getMostFrequentError(stats)
            });
        }
        
        // ì¬í™•ì¸ í•„ìš” (ìµœê·¼ 2íšŒ ì´ìƒ ì°ì–´ì„œ ë§ì¶¤)
        const recentLucky = stats.slice(-3).filter(h => h.category === 'ì°ì–´ì„œë§ì¶¤').length;
        if (recentLucky >= 2) {
            analysis.needsReview.push({
                filename: filename,
                luckyCount: recentLucky,
                lastDate: stats[stats.length - 1]?.date
            });
        }
        
        // ì˜¤ë˜ëœ ë¬¸ì œ (10ì¼ ì´ìƒ ì•ˆ í’€ì–´ë´„)
        if (stats.length > 0) {
            const lastDate = new Date(stats[stats.length - 1].date);
            const daysSince = Math.floor((new Date() - lastDate) / (1000 * 60 * 60 * 24));
            
            if (daysSince >= 10) {
                analysis.oldProblems.push({
                    filename: filename,
                    daysSince: daysSince,
                    lastDate: stats[stats.length - 1].date
                });
            }
        }
    });
    
    // ì •ë ¬
    analysis.repeatErrors.sort((a, b) => b.wrongCount - a.wrongCount);
    analysis.oldProblems.sort((a, b) => b.daysSince - a.daysSince);
    
    // ìµœê·¼ ì„±ì¥ ì¶”ì„¸ (2ì£¼ ì „ vs ìµœê·¼ 1ì£¼)
    if (tests.length >= 2) {
        const sortedTests = tests.sort((a, b) => new Date(a.gradedAt) - new Date(b.gradedAt));
        const midPoint = Math.floor(sortedTests.length / 2);
        const oldTests = sortedTests.slice(0, midPoint);
        const recentTests = sortedTests.slice(midPoint);
        
        const oldAvg = oldTests.reduce((sum, t) => sum + t.score, 0) / oldTests.length;
        const recentAvg = recentTests.reduce((sum, t) => sum + t.score, 0) / recentTests.length;
        
        analysis.recentImprovement = {
            oldAvg: Math.round(oldAvg),
            recentAvg: Math.round(recentAvg),
            change: Math.round(recentAvg - oldAvg)
        };
    }
    
    return analysis;
}

// ê°€ì¥ ë¹ˆë²ˆí•œ ì˜¤ë‹µ íŒ¨í„´ ì°¾ê¸°
function getMostFrequentError(history) {
    const errors = {};
    history.filter(h => h.result === 'wrong').forEach(h => {
        if (h.category) {
            errors[h.category] = (errors[h.category] || 0) + 1;
        }
    });
    
    let maxError = null;
    let maxCount = 0;
    Object.keys(errors).forEach(err => {
        if (errors[err] > maxCount) {
            maxCount = errors[err];
            maxError = err;
        }
    });
    
    return maxError || 'ê¸°íƒ€';
}

// ë¶„ì„ ê²°ê³¼ í‘œì‹œ
function displayAnalysis(analysis, studentName) {
    const periodText = document.getElementById('analysisPeriod').selectedOptions[0].text;
    
    let html = `
        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px; border-radius:12px; margin-bottom:20px;">
            <h3 style="margin:0 0 15px 0;">${studentName} ë‹˜ì˜ í•™ìŠµ ë¶„ì„</h3>
            <p style="margin:0; opacity:0.9;">ë¶„ì„ ê¸°ê°„: ${periodText}</p>
        </div>
    `;
    
    if (analysis.totalTests === 0) {
        html += '<p style="text-align:center; color:#999; padding:40px;">í•´ë‹¹ ê¸°ê°„ì— ì±„ì ëœ ì‹œí—˜ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        document.getElementById('analysisContent').innerHTML = html;
        return;
    }
    
    // ì „ì²´ í†µê³„
    html += `
        <div style="display:grid; grid-template-columns: repeat(4, 1fr); gap:15px; margin-bottom:25px;">
            <div style="background:#e3f2fd; padding:20px; border-radius:8px; text-align:center;">
                <div style="font-size:14px; color:#666; margin-bottom:8px;">ì´ ì‹œí—˜ íšŸìˆ˜</div>
                <div style="font-size:32px; font-weight:bold; color:#2196F3;">${analysis.totalTests}íšŒ</div>
            </div>
            <div style="background:#e8f5e9; padding:20px; border-radius:8px; text-align:center;">
                <div style="font-size:14px; color:#666; margin-bottom:8px;">í‰ê·  ì ìˆ˜</div>
                <div style="font-size:32px; font-weight:bold; color:#4CAF50;">${analysis.averageScore}ì </div>
            </div>
            <div style="background:#fff3e0; padding:20px; border-radius:8px; text-align:center;">
                <div style="font-size:14px; color:#666; margin-bottom:8px;">ì •ë‹µë¥ </div>
                <div style="font-size:32px; font-weight:bold; color:#FF9800;">${Math.round((analysis.correctCount / analysis.totalProblems) * 100)}%</div>
            </div>
            <div style="background:#fce4ec; padding:20px; border-radius:8px; text-align:center;">
                <div style="font-size:14px; color:#666; margin-bottom:8px;">ì°ì–´ì„œ ë§ì¶¤</div>
                <div style="font-size:32px; font-weight:bold; color:#E91E63;">${analysis.luckyGuesses}íšŒ</div>
            </div>
        </div>
    `;
    
    // ìµœê·¼ ì„±ì¥ ì¶”ì„¸
    if (analysis.recentImprovement) {
        const changeColor = analysis.recentImprovement.change >= 0 ? '#4CAF50' : '#f44336';
        const changeIcon = analysis.recentImprovement.change >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
        
        html += `
            <div style="background:#f0f7ff; padding:20px; border-radius:8px; margin-bottom:25px;">
                <h4 style="margin:0 0 15px 0;">ğŸ“Š ìµœê·¼ ì„±ì¥ ì¶”ì„¸</h4>
                <div style="display:flex; gap:20px; align-items:center;">
                    <div>
                        <div style="font-size:13px; color:#666;">ì´ˆë°˜ í‰ê· </div>
                        <div style="font-size:24px; font-weight:bold;">${analysis.recentImprovement.oldAvg}ì </div>
                    </div>
                    <div style="font-size:30px;">â†’</div>
                    <div>
                        <div style="font-size:13px; color:#666;">ìµœê·¼ í‰ê· </div>
                        <div style="font-size:24px; font-weight:bold;">${analysis.recentImprovement.recentAvg}ì </div>
                    </div>
                    <div style="margin-left:auto; text-align:center;">
                        <div style="font-size:36px;">${changeIcon}</div>
                        <div style="font-size:24px; font-weight:bold; color:${changeColor};">
                            ${analysis.recentImprovement.change >= 0 ? '+' : ''}${analysis.recentImprovement.change}ì 
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // ì£¼ìš” ì˜¤ë‹µ íŒ¨í„´
    html += `
        <div style="background:white; border:2px solid #f44336; border-radius:8px; padding:20px; margin-bottom:25px;">
            <h4 style="margin:0 0 15px 0; color:#f44336;">ğŸ”´ ì£¼ìš” ì˜¤ë‹µ íŒ¨í„´</h4>
    `;
    
    const sortedErrors = Object.entries(analysis.errorPatterns).sort((a, b) => b[1] - a[1]);
    if (sortedErrors.length > 0) {
        sortedErrors.forEach(([category, count], index) => {
            const percent = Math.round((count / analysis.wrongCount) * 100);
            html += `
                <div style="margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                        <span style="font-weight:${index === 0 ? 'bold' : 'normal'};">${index + 1}. ${category}</span>
                        <span style="color:#666;">${count}íšŒ (${percent}%)</span>
                    </div>
                    <div style="background:#f0f0f0; border-radius:10px; height:8px; overflow:hidden;">
                        <div style="background:linear-gradient(90deg, #f44336, #e91e63); height:100%; width:${percent}%;"></div>
                    </div>
                </div>
            `;
        });
    } else {
        html += '<p style="color:#999; margin:0;">ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤! ğŸ‰</p>';
    }
    html += '</div>';
    
    // ë°˜ë³µ ì˜¤ë‹µ ë¬¸ì œ
    html += `
        <div style="background:#ffebee; border-radius:8px; padding:20px; margin-bottom:25px;">
            <h4 style="margin:0 0 15px 0; color:#d32f2f;">âš ï¸ ê¸´ê¸‰ ì ê²€ í•„ìš” (3íšŒ ì´ìƒ í‹€ë¦¼)</h4>
    `;
    
    if (analysis.repeatErrors.length > 0) {
        analysis.repeatErrors.slice(0, 5).forEach((prob, index) => {
            html += `
                <div style="background:white; padding:12px; border-radius:6px; margin-bottom:10px; border-left:4px solid #f44336;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="flex:1;">
                            <div style="font-weight:bold; margin-bottom:4px;">${index + 1}. ${prob.filename}</div>
                            <div style="font-size:12px; color:#666;">
                                ì£¼ìš” ì˜¤ë‹µ: ${prob.mainError} | ë§ˆì§€ë§‰: ${prob.lastDate}
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="background:#f44336; color:white; padding:4px 12px; border-radius:12px; font-size:12px; font-weight:bold;">
                                ${prob.wrongCount}íšŒ í‹€ë¦¼
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
            <button class="btn" onclick="createReviewTest('repeatErrors')" style="margin-top:10px; width:100%;">
                ğŸ“ ì´ ë¬¸ì œë“¤ë¡œ ë³µìŠµ ì‹œí—˜ì§€ ìƒì„±
            </button>
        `;
    } else {
        html += '<p style="color:#999; margin:0;">ë°˜ë³µ ì˜¤ë‹µ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‘</p>';
    }
    html += '</div>';
    
    // ì¬í™•ì¸ í•„ìš” (ì°ì–´ì„œ ë§ì¶¤)
    html += `
        <div style="background:#fff8e1; border-radius:8px; padding:20px; margin-bottom:25px;">
            <h4 style="margin:0 0 15px 0; color:#f57c00;">ğŸŸ¡ ì¬í™•ì¸ í•„ìš” (ì°ì–´ì„œ ë§ì¶¤ 2íšŒ ì´ìƒ)</h4>
    `;
    
    if (analysis.needsReview.length > 0) {
        analysis.needsReview.slice(0, 5).forEach((prob, index) => {
            html += `
                <div style="background:white; padding:12px; border-radius:6px; margin-bottom:10px; border-left:4px solid #FF9800;">
                    <div style="font-weight:bold; margin-bottom:4px;">${index + 1}. ${prob.filename}</div>
                    <div style="font-size:12px; color:#666;">
                        ìµœê·¼ ${prob.luckyCount}íšŒ ì°ì–´ì„œ ë§ì¶¤ | ë§ˆì§€ë§‰: ${prob.lastDate}
                    </div>
                </div>
            `;
        });
        
        html += `
            <button class="btn" onclick="createReviewTest('needsReview')" style="margin-top:10px; width:100%; background:#FF9800;">
                ğŸ“ ì´ ë¬¸ì œë“¤ë¡œ ì¬í™•ì¸ ì‹œí—˜ì§€ ìƒì„±
            </button>
        `;
    } else {
        html += '<p style="color:#999; margin:0;">ì¬í™•ì¸ í•„ìš”í•œ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤! ğŸ‘</p>';
    }
    html += '</div>';
    
    // ì˜¤ë˜ëœ ë¬¸ì œ
    html += `
        <div style="background:#e8f5e9; border-radius:8px; padding:20px;">
            <h4 style="margin:0 0 15px 0; color:#388e3c;">ğŸŸ¢ ì¥ê¸° ê¸°ì–µ ì ê²€ (10ì¼ ì´ìƒ ì•ˆ í’€ì–´ë´„)</h4>
    `;
    
    if (analysis.oldProblems.length > 0) {
        analysis.oldProblems.slice(0, 5).forEach((prob, index) => {
            html += `
                <div style="background:white; padding:12px; border-radius:6px; margin-bottom:10px; border-left:4px solid #4CAF50;">
                    <div style="font-weight:bold; margin-bottom:4px;">${index + 1}. ${prob.filename}</div>
                    <div style="font-size:12px; color:#666;">
                        ë§ˆì§€ë§‰ í’€ì´: ${prob.lastDate} (${prob.daysSince}ì¼ ì „)
                    </div>
                </div>
            `;
        });
        
        html += `
            <button class="btn" onclick="createReviewTest('oldProblems')" style="margin-top:10px; width:100%; background:#4CAF50;">
                ğŸ“ ì´ ë¬¸ì œë“¤ë¡œ ê¸°ì–µ ì ê²€ ì‹œí—˜ì§€ ìƒì„±
            </button>
        `;
    } else {
        html += '<p style="color:#999; margin:0;">ì˜¤ë˜ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤!</p>';
    }
    html += '</div>';
    
    // ì „ì²´ ë¦¬í¬íŠ¸ ì¸ì‡„ ë²„íŠ¼
    html += `
        <div style="margin-top:25px; text-align:center;">
            <button class="btn btn-export" onclick="printAnalysisReport()" style="padding:12px 30px; font-size:16px;">
                ğŸ–¨ï¸ ì „ì²´ ë¦¬í¬íŠ¸ ì¸ì‡„
            </button>
        </div>
    `;
    
    document.getElementById('analysisContent').innerHTML = html;
}

// ë³µìŠµ ì‹œí—˜ì§€ ìƒì„±
function createReviewTest(category) {
    const studentName = document.getElementById('analysisStudent').value;
    if (!studentName) return;
    
    alert('ë³µìŠµ ì‹œí—˜ì§€ ìƒì„± ê¸°ëŠ¥ì€ ê³§ ì¶”ê°€ë©ë‹ˆë‹¤!\n\nì„ íƒëœ ë¬¸ì œë“¤ì„ ìë™ìœ¼ë¡œ ì‹œí—˜ì§€ì— í¬í•¨ì‹œí‚¬ ì˜ˆì •ì…ë‹ˆë‹¤.');
    
    // TODO: í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë¬¸ì œë“¤ì„ ìë™ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ì‹œí—˜ì§€ ìƒì„±
}

// ë¶„ì„ ë¦¬í¬íŠ¸ ì¸ì‡„
function printAnalysisReport() {
    window.print();
}

// ë¶„ì„ í™”ë©´ ë‹«ê¸°
function closeAnalysis() {
    document.getElementById('analysisPanel').style.display = 'none';
    document.getElementById('quizSheet').style.display = 'block';
}

// â­ ì—¬ê¸°ê¹Œì§€ ì¶”ê°€! â­

// í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
document.addEventListener('keydown', function(e) {
    // ì±„ì  í™”ë©´ì—ì„œë§Œ ì‘ë™
    if (document.getElementById('gradingPanel').style.display !== 'block') return;
    
    // Ctrl+S: ì„ì‹œì €ì¥
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveTempGrading();
    }
    
    // ESC: ì¢…ë£Œ
    if (e.key === 'Escape') {
        exitGrading();
    }
});

// ì±„ì  ê²°ê³¼ ë³´ê¸°
function viewGrading(testId) {
    loadGradingResults();
    const result = gradingResultsDB[testId];
    
    if (!result) {
        alert('ì±„ì  ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    loadTestPapers();
    const test = testPapers[testId];
    
    let html = `
        <h3>${result.studentName} - ${test.title} ì±„ì  ê²°ê³¼</h3>
        <p>ì ìˆ˜: ${result.score}ì  (${result.correctCount}/${result.totalProblems})</p>
        <p>ì±„ì  ì¼ì‹œ: ${new Date(result.gradedAt).toLocaleString('ko-KR')}</p>
        <hr>
        <table style="width:100%; border-collapse:collapse; font-size:13px;">
            <tr style="background:#f0f0f0;">
                <th style="border:1px solid #ddd; padding:8px;">ë²ˆí˜¸</th>
                <th style="border:1px solid #ddd; padding:8px;">íŒŒì¼ëª…</th>
                <th style="border:1px solid #ddd; padding:8px;">ì •ë‹µ</th>
                <th style="border:1px solid #ddd; padding:8px;">í•™ìƒë‹µ</th>
                <th style="border:1px solid #ddd; padding:8px;">ê²°ê³¼</th>
                <th style="border:1px solid #ddd; padding:8px;">ë¶„ë¥˜</th>
                <th style="border:1px solid #ddd; padding:8px;">ë©”ëª¨</th>
            </tr>
    `;
    
    result.results.forEach(r => {
        const resultColor = r.result === 'ì •ë‹µ' ? '#4CAF50' : '#f44336';
        html += `
            <tr>
                <td style="border:1px solid #ddd; padding:8px; text-align:center;">${r.problemNumber}</td>
                <td style="border:1px solid #ddd; padding:8px; font-size:11px;">${r.filename}</td>
                <td style="border:1px solid #ddd; padding:8px; text-align:center; font-weight:bold;">${r.correctAnswer}</td>
                <td style="border:1px solid #ddd; padding:8px; text-align:center;">${r.studentAnswer || '-'}</td>
                <td style="border:1px solid #ddd; padding:8px; text-align:center; color:${resultColor}; font-weight:bold;">${r.result}</td>
                <td style="border:1px solid #ddd; padding:8px; font-size:11px;">${r.detailCategory}</td>
                <td style="border:1px solid #ddd; padding:8px; font-size:11px;">${r.memo || '-'}</td>
            </tr>
        `;
    });
    
    html += '</table>';
    
    const popup = window.open('', 'ì±„ì ê²°ê³¼', 'width=1000,height=700');
    popup.document.write(`
        <html>
        <head>
            <meta charset="UTF-8">
            <title>ì±„ì  ê²°ê³¼</title>
            <style>
                body { font-family: 'Malgun Gothic', sans-serif; padding: 20px; }
                table { margin-top: 20px; }
            </style>
        </head>
        <body>
            ${html}
            <div style="margin-top:20px;">
                <button onclick="window.print()" style="padding:10px 20px; background:#4CAF50; color:white; border:none; border-radius:4px; cursor:pointer;">ğŸ–¨ï¸ ì¸ì‡„</button>
                <button onclick="window.close()" style="padding:10px 20px; background:#666; color:white; border:none; border-radius:4px; cursor:pointer; margin-left:10px;">ë‹«ê¸°</button>
            </div>
        </body>
        </html>
    `);
}

// ì±„ì  ìˆ˜ì •
function editGrading(testId) {
    // ì±„ì  ì‹œì‘ê³¼ ë™ì¼í•˜ê²Œ ì²˜ë¦¬ (ê¸°ì¡´ ê²°ê³¼ ë¶ˆëŸ¬ì˜´)
    startGrading(testId);
}

// ì±„ì  ìˆ˜ì • (Phase 2ì—ì„œ êµ¬í˜„ ì˜ˆì •)
function editGrading(testId) {
    alert('ìˆ˜ì • ê¸°ëŠ¥ì€ Phase 2ì—ì„œ êµ¬í˜„ë©ë‹ˆë‹¤!');
}

// â­ ì—¬ê¸°ê¹Œì§€ ì¶”ê°€! â­

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, isSuccess) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.style.display = 'block';
            status.style.borderLeftColor = isSuccess ? '#4CAF50' : '#f44336';
            status.style.background = isSuccess ? '#e8f5e9' : '#ffebee';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

// ì¹´ë©”ë¼ ê´€ë ¨ ë³€ìˆ˜
        // IndexedDB ì´ˆê¸°í™”
        let db = null;
        
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('RoutineMathDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('photos')) {
                        const store = db.createObjectStore('photos', { keyPath: 'filename' });
                        store.createIndex('student', 'student', { unique: false });
                        store.createIndex('date', 'date', { unique: false });
                    }
                };
            });
        }
        
        // ì¹´ë©”ë¼ ê´€ë ¨ ë³€ìˆ˜
        let cameraStream = null;
        let capturedImageData = null;
        
        // ì¹´ë©”ë¼ ì‹œì‘
        async function startCamera() {
            if (!currentStudent) {
                showStatus('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // í›„ë©´ ì¹´ë©”ë¼ ìš°ì„ 
                });
                cameraStream = stream;
                document.getElementById('cameraVideo').srcObject = stream;
                document.getElementById('cameraContainer').style.display = 'block';
                document.getElementById('capturedPhotoContainer').style.display = 'none';
            } catch (err) {
                showStatus('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: ' + err.message, false);
            }
        }
        
        // ì¹´ë©”ë¼ ì •ì§€
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraContainer').style.display = 'none';
        }
        
        // ì‚¬ì§„ ì´¬ì˜
        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const ctx = canvas.getContext('2d');
            
            // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì • (ë¦¬ì‚¬ì´ì¦ˆ)
            const maxSize = 1920;
            let width = video.videoWidth;
            let height = video.videoHeight;
            
            if (width > maxSize || height > maxSize) {
                if (width > height) {
                    height = (height / width) * maxSize;
                    width = maxSize;
                } else {
                    width = (width / height) * maxSize;
                    height = maxSize;
                }
            }
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(video, 0, 0, width, height);
            
            // ì´ë¯¸ì§€ ë°ì´í„° ì €ì¥ (ì••ì¶•)
            capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
            
            // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
            document.getElementById('capturedPhoto').src = capturedImageData;
            document.getElementById('cameraContainer').style.display = 'none';
            document.getElementById('capturedPhotoContainer').style.display = 'block';
            
            stopCamera();
            
            // íŒŒì¼ëª… ìë™ ìƒì„±
            const now = new Date();
            const dateStr = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
            document.getElementById('photoFilename').value = `ë¬¸ì œ_${dateStr}`;
        }
        
        // ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒ
        function handlePhotoSelect(event) {
            if (!currentStudent) {
                showStatus('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.', false);
                return;
            }
            
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById('photoCanvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ë¦¬ì‚¬ì´ì¦ˆ
                    let width = img.width;
                    let height = img.height;
                    const maxSize = 1920;
                    
                    if (width > maxSize || height > maxSize) {
                        if (width > height) {
                            height = (height / width) * maxSize;
                            width = maxSize;
                        } else {
                            width = (width / height) * maxSize;
                            height = maxSize;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    capturedImageData = canvas.toDataURL('image/jpeg', 0.8);
                    document.getElementById('capturedPhoto').src = capturedImageData;
                    document.getElementById('capturedPhotoContainer').style.display = 'block';
                    
                    const originalName = file.name.replace(/\.(jpg|jpeg|png)$/i, '');
                    document.getElementById('photoFilename').value = originalName;
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }
        
        // IndexedDBì— ì‚¬ì§„ ì €ì¥
        async function savePhoto() {
            const filename = document.getElementById('photoFilename').value.trim();
            if (!filename) {
                showStatus('íŒŒì¼ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.', false);
                return;
            }
            
            if (!db) {
                await initDB();
            }
            
            try {
                const transaction = db.transaction(['photos'], 'readwrite');
                const store = transaction.objectStore('photos');
                
                const photoData = {
                    filename: `${filename}.png`,
                    student: currentStudent,
                    imageData: capturedImageData,
                    date: new Date().toISOString()
                };
                
                const request = store.put(photoData);
                
                request.onsuccess = () => {
                    // File ê°ì²´ ìƒì„±í•˜ì—¬ allImagesì— ì¶”ê°€
                    fetch(capturedImageData)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], `${filename}.png`, { type: 'image/png' });
                            allImages.push(file);
                            
                            // í•™ìƒ ë°ì´í„°ì— ì¶”ê°€
                            const key = `student_${currentStudent}`;
                            let data = JSON.parse(localStorage.getItem(key) || '{}');
                            data[file.name] = {
                                level: 'ì·¨ì•½ë¬¸ì œ',
                                correctStreak: 0,
                                totalCorrect: 0,
                                totalWrong: 0,
                                history: [],
                                capturedDate: new Date().toISOString()
                            };
                            localStorage.setItem(key, JSON.stringify(data));
                            
                            showStatus(`âœ… "${filename}.png" IndexedDBì— ì €ì¥ ì™„ë£Œ! (ì´ ${allImages.length}ê°œ)`, true);
                            cancelPhoto();
                            updateDashboard();
                            showProblemList();
                        });
                };
                
                request.onerror = () => {
                    showStatus('ì €ì¥ ì‹¤íŒ¨: ' + request.error, false);
                };
                
            } catch (err) {
                showStatus('ì €ì¥ ì‹¤íŒ¨: ' + err.message, false);
            }
        }
        
        // IndexedDBì—ì„œ ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadPhotosFromDB() {
            if (!currentStudent) return;
            if (!db) await initDB();
            
            try {
                const transaction = db.transaction(['photos'], 'readonly');
                const store = transaction.objectStore('photos');
                const index = store.index('student');
                const request = index.getAll(currentStudent);
                
                request.onsuccess = () => {
                    const photos = request.result;
                    
                    photos.forEach(photo => {
                        fetch(photo.imageData)
                            .then(res => res.blob())
                            .then(blob => {
                                const file = new File([blob], photo.filename, { type: 'image/png' });
                                // ì¤‘ë³µ ì²´í¬
                                if (!allImages.find(f => f.name === file.name)) {
                                    allImages.push(file);
                                }
                            });
                    });
                    
                    if (photos.length > 0) {
                        setTimeout(() => {
                            showStatus(`ğŸ“¸ ì´¬ì˜í•œ ì‚¬ì§„ ${photos.length}ê°œë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`, true);
                            showProblemList();
                        }, 500);
                    }
                };
                
            } catch (err) {
                console.error('ì‚¬ì§„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', err);
            }
        }
        
        // ì´¬ì˜ ì·¨ì†Œ
        function cancelPhoto() {
            capturedImageData = null;
            document.getElementById('capturedPhotoContainer').style.display = 'none';
            document.getElementById('photoFilename').value = '';
            document.getElementById('photoInput').value = '';
        }
        

// í•™ìŠµ ë°ì´í„° ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
function downloadStudentData() {
    if (!currentStudent) {
        alert('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    // í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const studentKey = 'student_' + currentStudent;
    const studentData = JSON.parse(localStorage.getItem(studentKey) || '{}');
    
    // ì±„ì  ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
    loadGradingResults();
    const allTests = Object.values(gradingResultsDB).filter(function(test) {
        return test.studentName === currentStudent;
    });
    
    if (Object.keys(studentData).length === 0 && allTests.length === 0) {
        alert(currentStudent + ' í•™ìƒì˜ í•™ìŠµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ì¤€ë¹„
    const exportData = {
        studentName: currentStudent,
        exportDate: new Date().toISOString(),
        exportDateKR: new Date().toLocaleString('ko-KR'),
        problemData: studentData,
        testResults: allTests,
        summary: {
            totalProblems: Object.keys(studentData).length,
            totalTests: allTests.length,
            totalCorrect: 0,
            totalWrong: 0
        }
    };
    
    // ì •ë‹µ/ì˜¤ë‹µ ì§‘ê³„
    allTests.forEach(function(test) {
        exportData.summary.totalCorrect += test.correctCount || 0;
        exportData.summary.totalWrong += test.wrongCount || 0;
    });
    
    // JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    const jsonStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = currentStudent + '_í•™ìŠµë°ì´í„°_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
    
    alert('âœ… ' + currentStudent + ' í•™ìƒì˜ í•™ìŠµ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤!\n\níŒŒì¼ëª…: ' + a.download);
}

// í•™ìŠµ ë°ì´í„° ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜ (ê¸°ê°„ ì„ íƒ ê°€ëŠ¥)
function downloadStudentData() {
    if (!currentStudent) {
        alert('ë¨¼ì € í•™ìƒì„ ì„ íƒí•˜ì„¸ìš”.');
        return;
    }
    
    // ì„ íƒëœ ê¸°ê°„ ê°€ì ¸ì˜¤ê¸°
    const period = document.getElementById('downloadPeriod').value;
    const periodText = document.getElementById('downloadPeriod').selectedOptions[0].text;
    
    // ê¸°ê°„ ê³„ì‚°
    let cutoffDate = null;
    if (period !== 'all') {
        cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - parseInt(period));
    }
    
    // í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const studentKey = 'student_' + currentStudent;
    const allStudentData = JSON.parse(localStorage.getItem(studentKey) || '{}');
    
    // ì±„ì  ê²°ê³¼ ê°€ì ¸ì˜¤ê¸°
    loadGradingResults();
    const allTests = Object.values(gradingResultsDB).filter(function(test) {
        return test.studentName === currentStudent;
    });
    
    // ê¸°ê°„ìœ¼ë¡œ í•„í„°ë§
    const filteredTests = allTests.filter(function(test) {
        if (period === 'all') return true;
        const testDate = new Date(test.gradedAt);
        return testDate >= cutoffDate;
    });
    
    // ê¸°ê°„ ë‚´ ë¬¸ì œë§Œ í•„í„°ë§
    const filteredProblems = {};
    Object.keys(allStudentData).forEach(function(filename) {
        const problemData = allStudentData[filename];
        const history = problemData.history || [];
        
        // ê¸°ê°„ ë‚´ ì´ë ¥ë§Œ í•„í„°ë§
        const filteredHistory = history.filter(function(record) {
            if (period === 'all') return true;
            const recordDate = new Date(record.date);
            return recordDate >= cutoffDate;
        });
        
        // ê¸°ê°„ ë‚´ ê¸°ë¡ì´ ìˆëŠ” ë¬¸ì œë§Œ í¬í•¨
        if (filteredHistory.length > 0) {
            filteredProblems[filename] = {
                level: problemData.level,
                correctStreak: problemData.correctStreak,
                totalCorrect: problemData.totalCorrect,
                totalWrong: problemData.totalWrong,
                history: filteredHistory,
                capturedDate: problemData.capturedDate
            };
        }
    });
    
    if (Object.keys(filteredProblems).length === 0 && filteredTests.length === 0) {
        alert(currentStudent + ' í•™ìƒì˜ ' + periodText + ' í•™ìŠµ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // JSON í˜•ì‹ìœ¼ë¡œ ë°ì´í„° ì¤€ë¹„
    const exportData = {
        studentName: currentStudent,
        period: periodText,
        exportDate: new Date().toISOString(),
        exportDateKR: new Date().toLocaleString('ko-KR'),
        problemData: filteredProblems,
        testResults: filteredTests,
        summary: {
            totalProblems: Object.keys(filteredProblems).length,
            totalTests: filteredTests.length,
            totalCorrect: 0,
            totalWrong: 0,
            averageScore: 0
        }
    };
    
    // ì •ë‹µ/ì˜¤ë‹µ ì§‘ê³„
    filteredTests.forEach(function(test) {
        exportData.summary.totalCorrect += test.correctCount || 0;
        exportData.summary.totalWrong += test.wrongCount || 0;
    });
    
    // í‰ê·  ì ìˆ˜ ê³„ì‚°
    if (filteredTests.length > 0) {
        const totalScore = filteredTests.reduce(function(sum, test) {
            return sum + (test.score || 0);
        }, 0);
        exportData.summary.averageScore = Math.round(totalScore / filteredTests.length);
    }
    
    // JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    const jsonStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([jsonStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    const periodSuffix = period === 'all' ? 'ì „ì²´' : period + 'ì¼';
    a.download = currentStudent + '_í•™ìŠµë°ì´í„°_' + periodSuffix + '_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
    
    // ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ë©”ì‹œì§€
    let message = 'âœ… ' + currentStudent + ' í•™ìƒì˜ í•™ìŠµ ë°ì´í„°ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤!\n\n';
    message += 'ğŸ“Š ë‹¤ìš´ë¡œë“œ ë‚´ìš©:\n';
    message += '- ê¸°ê°„: ' + periodText + '\n';
    message += '- ë¬¸ì œ ìˆ˜: ' + exportData.summary.totalProblems + 'ê°œ\n';
    message += '- ì‹œí—˜ íšŸìˆ˜: ' + exportData.summary.totalTests + 'íšŒ\n';
    message += '- í‰ê·  ì ìˆ˜: ' + exportData.summary.averageScore + 'ì \n\n';
    message += 'ğŸ“ íŒŒì¼ëª…: ' + a.download;
    
    alert(message);
}

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.onload = init;
    </script>
    
    <script>
        // PWA ì§€ì›
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./service-worker.js')
                .then(() => console.log('PWA ì¤€ë¹„ ì™„ë£Œ!'))
                .catch(() => console.log('PWA ë¯¸ì§€ì›'));
        }
    </script>

<!-- ì‹œí—˜ì§€ ì €ì¥ ëª¨ë‹¬ -->
<div id="saveTestModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:30px; border-radius:12px; max-width:500px; width:90%; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
        <h2 style="margin-top:0; color:#333;">âœ… ì‹œí—˜ì§€ ìƒì„± ì™„ë£Œ!</h2>
        
        <div style="background:#f0f7ff; padding:15px; border-radius:8px; margin:20px 0;">
            <p style="margin:5px 0;"><strong>í•™ìƒ:</strong> <span id="modalStudentName"></span></p>
            <p style="margin:5px 0;"><strong>ì œëª©:</strong> <span id="modalTestTitle"></span></p>
            <p style="margin:5px 0;"><strong>ìœ í˜•:</strong> <span id="modalTestType"></span></p>
            <p style="margin:5px 0;"><strong>ë¬¸ì œ ìˆ˜:</strong> <span id="modalProblemCount"></span>ê°œ</p>
            <p style="margin:5px 0;"><strong>ìƒì„± ë‚ ì§œ:</strong> <span id="modalTestDate"></span></p>
        </div>
        
        <div style="margin:20px 0;">
            <p style="color:#666; font-size:14px;">ğŸ’¡ ì´ ì‹œí—˜ì§€ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br>ì €ì¥í•˜ë©´ ë‚˜ì¤‘ì— ì±„ì ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
        
        <div style="display:flex; gap:10px; justify-content:flex-end;">
            <button class="btn" onclick="saveAndPrint()" style="background:#4CAF50;">ğŸ’¾ ì €ì¥í•˜ê³  ì¸ì‡„</button>
            <button class="btn btn-export" onclick="printOnly()">ğŸ–¨ï¸ ì €ì¥ ì•ˆ í•˜ê³  ì¸ì‡„ë§Œ</button>
            <button class="btn btn-danger" onclick="closeSaveModal()">âŒ ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<!-- QR ì±„ì  ëª¨ë‹¬ -->
<div id="qrGradingModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; overflow-y:auto;">
    <div style="background:white; padding:25px; border-radius:14px; max-width:480px; width:92%; margin:20px auto; box-shadow:0 6px 30px rgba(0,0,0,0.3);">
        <h2 style="margin:0 0 6px; color:#333; text-align:center;">ğŸ“± QR ìê°€ì±„ì </h2>
        <p style="text-align:center; color:#888; font-size:13px; margin:0 0 18px;">QR ìŠ¤ìº” í›„ ë‚˜íƒ€ë‚œ ì½”ë“œë¥¼ ì•„ë˜ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</p>
        <div id="qrStep1">
            <textarea id="qrCodeInput" placeholder="ì˜ˆ) Aì˜¤ë‹µí•™ìŠµë¬¸ì œì§€|Bí™ê¸¸ë™|1:3,2:â‘¡,3:12..." style="width:100%; height:80px; padding:10px; font-size:13px; border:2px solid #ddd; border-radius:8px; resize:none; font-family:monospace;"></textarea>
            <button onclick="startQRGrading()" style="width:100%; padding:13px; margin-top:10px; background:#667eea; color:white; border:none; border-radius:8px; font-size:15px; font-weight:bold; cursor:pointer;">âœ… ì±„ì  ì‹œì‘</button>
            <button onclick="closeQRModal()" style="width:100%; padding:10px; margin-top:8px; background:#eee; color:#555; border:none; border-radius:8px; font-size:14px; cursor:pointer;">âœ• ë‹«ê¸°</button>
        </div>
        <div id="qrStep2" style="display:none;">
            <h3 id="qrGradeTitle" style="text-align:center; margin:0 0 4px; font-size:15px;"></h3>
            <p id="qrGradeStudent" style="text-align:center; color:#888; font-size:12px; margin:0 0 12px;"></p>
            <div id="qrProblemList"></div>
            <button onclick="submitQRGrading()" style="width:100%; padding:13px; margin-top:10px; background:#4CAF50; color:white; border:none; border-radius:8px; font-size:15px; font-weight:bold; cursor:pointer;">âœ… ì±„ì í•˜ê¸°</button>
            <button onclick="resetQRModal()" style="width:100%; padding:10px; margin-top:8px; background:#eee; color:#555; border:none; border-radius:8px; font-size:13px; cursor:pointer;">â† ë‹¤ì‹œ ì…ë ¥</button>
        </div>
        <div id="qrStep3" style="display:none; text-align:center;">
            <div style="width:110px; height:110px; border-radius:50%; background:linear-gradient(135deg,#667eea,#764ba2); display:flex; flex-direction:column; align-items:center; justify-content:center; margin:0 auto 14px;">
                <div id="qrScore" style="font-size:34px; font-weight:bold; color:white; line-height:1;"></div>
                <div id="qrScoreTotal" style="font-size:12px; color:rgba(255,255,255,.8); margin-top:2px;"></div>
            </div>
            <h3 id="qrScoreMsg" style="margin:0 0 12px;"></h3>
            <div id="qrResultDetail" style="text-align:left;"></div>
            <button onclick="closeQRModal()" style="width:100%; padding:12px; margin-top:12px; background:#eee; color:#555; border:none; border-radius:8px; font-size:13px; cursor:pointer;">âœ• ë‹«ê¸°</button>
        </div>
    </div>
</div>

<script>
let qrParsedData = null;
function openQRModal() {
    document.getElementById('qrGradingModal').style.display = 'flex';
    resetQRModal();
}
function closeQRModal() {
    document.getElementById('qrGradingModal').style.display = 'none';
}
function resetQRModal() {
    document.getElementById('qrStep1').style.display = 'block';
    document.getElementById('qrStep2').style.display = 'none';
    document.getElementById('qrStep3').style.display = 'none';
    document.getElementById('qrCodeInput').value = '';
    qrParsedData = null;
}
async function startQRGrading() {
    const code = document.getElementById('qrCodeInput').value.trim();
    if (!code) { alert('ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

    qrParsedData = parseAnswerCode(code);
    if (!qrParsedData) {
        alert('ì½”ë“œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.\nQRì„ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.');
        return;
    }

    // GitHub URL ëª¨ë“œ: APIë¡œ ì •ë‹µ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    if (qrParsedData._mode === 'github') {
        const { fileId, username, repo } = qrParsedData;
        // GitHub raw APIë¡œ answers/fileId.json ì½ê¸° (token ë¶ˆí•„ìš” â€” public repo)
        const rawUrl = `https://raw.githubusercontent.com/${username}/${repo}/main/answers/${fileId}.json`;
        try {
            const res = await fetch(rawUrl);
            if (!res.ok) throw new Error('ì •ë‹µ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (' + res.status + ')');
            const data = await res.json();
            // data = { title, student, date, problems: [{number, answer}] }
            qrParsedData.title   = data.title   || '';
            qrParsedData.student = data.student || '';
            qrParsedData.problems = (data.problems || []).map(p => ({
                number: p.number,
                answer: p.answer || ''
            }));
        } catch(e) {
            alert('ì •ë‹µ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ' + e.message + '\nQRì„ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.');
            return;
        }
    }

    if (!qrParsedData.problems.length) {
        alert('ë¬¸ì œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\nQRì„ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.');
        return;
    }

    document.getElementById('qrGradeTitle').textContent = 'ğŸ“ ' + qrParsedData.title;
    document.getElementById('qrGradeStudent').textContent = 'í•™ìƒ: ' + qrParsedData.student;
    let html = '';
    qrParsedData.problems.forEach(p => {
        html += `<div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            <span style="font-weight:bold; min-width:40px; color:#555;">${p.number}ë²ˆ</span>
            <input id="qa_${p.number}" type="text" placeholder="ë‹µ ì…ë ¥" style="flex:1; padding:9px; font-size:15px; border:2px solid #ddd; border-radius:6px;">
            <span id="qr_${p.number}" style="font-size:18px; min-width:24px;"></span>
        </div>`;
    });
    document.getElementById('qrProblemList').innerHTML = html;
    document.getElementById('qrStep1').style.display = 'none';
    document.getElementById('qrStep2').style.display = 'block';
    const first = document.getElementById('qa_' + qrParsedData.problems[0].number);
    if (first) setTimeout(() => first.focus(), 100);
}
async function submitQRGrading() {
    if (!qrParsedData) return;
    let correct = 0, detailHTML = '';
    const results = [];

    qrParsedData.problems.forEach(p => {
        const inp = document.getElementById('qa_' + p.number);
        const userAns = inp ? inp.value.trim() : '';
        const correctAns = p.answer && p.answer !== '?' ? p.answer : '';
        const norm = s => s.toLowerCase().replace(/\s/g, '');
        const ok = correctAns && norm(userAns) === norm(correctAns);
        if (ok) correct++;
        const resEl = document.getElementById('qr_' + p.number);
        if (resEl) resEl.textContent = ok ? 'âœ…' : 'âŒ';
        if (inp) inp.disabled = true;
        results.push({ number: p.number, userAnswer: userAns, correctAnswer: correctAns, correct: ok });
        detailHTML += `<div style="display:flex; justify-content:space-between; padding:7px 0; border-bottom:1px solid #f0f0f0; font-size:13px;">
            <span>${p.number}ë²ˆ</span>
            <span style="font-weight:bold; color:${ok ? '#4CAF50' : '#f44336'}">${ok ? 'âœ… ì •ë‹µ' : 'âŒ ' + (correctAns || 'ì •ë‹µì—†ìŒ')}</span>
        </div>`;
    });

    const total = qrParsedData.problems.length;
    const pct = Math.round(correct / total * 100);
    document.getElementById('qrScore').textContent = correct;
    document.getElementById('qrScoreTotal').textContent = '/ ' + total + 'ë¬¸ì œ';
    document.getElementById('qrScoreMsg').textContent = pct >= 90 ? 'ğŸ‰ ì™„ë²½í•´ìš”!' : pct >= 70 ? 'ğŸ‘ ì˜í–ˆì–´ìš”!' : pct >= 50 ? 'ğŸ’ª ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë´ìš”!' : 'ğŸ˜Š ë‹¤ì‹œ ë„ì „í•´ë´ìš”!';
    document.getElementById('qrResultDetail').innerHTML = detailHTML;
    document.getElementById('qrStep2').style.display = 'none';
    document.getElementById('qrStep3').style.display = 'block';

    const studentName = qrParsedData.student;
    const gradedAt = new Date().toISOString();

    // â”€â”€ â‘  ë¡œì»¬ ê¸°ë¡ ì €ì¥ (í•™ìŠµ ë¶„ì„Â·ì±„ì  ëŒ€ê¸° ëª©ë¡ ë°˜ì˜) â”€â”€
    try {
        loadTestPapers();
        loadGradingResults();

        // ì œëª©+í•™ìƒëª…ìœ¼ë¡œ testPapersì—ì„œ ë§¤ì¹­
        const matchedPaper = Object.values(testPapers).find(t =>
            t.studentName === studentName &&
            t.title === qrParsedData.title &&
            t.status !== 'ì±„ì ì™„ë£Œ'
        );
        const resolvedTestId = matchedPaper ? matchedPaper.id : ('qr_' + Date.now().toString(36));

        gradingResultsDB[resolvedTestId] = {
            testId: resolvedTestId,
            studentName,
            gradedAt,
            results: results.map((r, idx) => ({
                ...r,
                filename: matchedPaper?.problems?.[idx]?.filename || '',
                result: r.correct ? 'ì •ë‹µ' : 'ì˜¤ë‹µ'
            })),
            correctCount: correct,
            wrongCount: total - correct,
            score: pct,
            totalProblems: total
        };
        localStorage.setItem('gradingResults', JSON.stringify(gradingResultsDB));

        // testPapers ìƒíƒœ ì—…ë°ì´íŠ¸
        if (matchedPaper) {
            testPapers[matchedPaper.id].status = 'ì±„ì ì™„ë£Œ';
            localStorage.setItem('testPapers', JSON.stringify(testPapers));
        }

        // í•™ìƒ ë¬¸ì œë³„ ë ˆë²¨ ì—…ë°ì´íŠ¸ (ì·¨ì•½â†’ë³µìŠµí•„ìš”â†’ì™„ì „ì •ë³µ)
        if (matchedPaper) {
            const studentResults = results.map((r, idx) => ({
                filename: matchedPaper.problems?.[idx]?.filename || '',
                result: r.correct ? 'ì •ë‹µ' : 'ì˜¤ë‹µ'
            })).filter(r => r.filename);
            if (studentResults.length > 0) updateStudentData(studentName, studentResults, resolvedTestId);
        }
    } catch(e) {
        console.warn('ë¡œì»¬ ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜:', e);
    }

    // â”€â”€ â‘¡ GitHub results/ ì—…ë¡œë“œ â”€â”€
    const username = localStorage.getItem('gh_username');
    const repo     = localStorage.getItem('gh_repo');
    const token    = localStorage.getItem('gh_token');
    if (username && repo && token) {
        try {
            const fileId = Date.now().toString(36) + Math.random().toString(36).slice(2, 6);
            const payload = {
                title: qrParsedData.title, student: studentName,
                score: pct, correct, total,
                gradedAt: new Date().toLocaleString('ko-KR'),
                results
            };
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2))));
            await fetch(`https://api.github.com/repos/${username}/${repo}/contents/results/${fileId}_result.json`, {
                method: 'PUT',
                headers: { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: 'ì±„ì  ê²°ê³¼: ' + studentName + ' â€” ' + qrParsedData.title, content })
            });
        } catch(e) {
            console.warn('GitHub ê²°ê³¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', e);
        }
    }
}
function retryQRGrading() {
    if (!qrParsedData) return;
    qrParsedData.problems.forEach(p => {
        const inp = document.getElementById('qa_' + p.number);
        const res = document.getElementById('qr_' + p.number);
        if (inp) { inp.value = ''; inp.disabled = false; }
        if (res) res.textContent = '';
    });
    document.getElementById('qrStep3').style.display = 'none';
    document.getElementById('qrStep2').style.display = 'block';
}
</script>

<!-- ===== ğŸ“Š ì±„ì  ê²°ê³¼ í™•ì¸ ëª¨ë‹¬ ===== -->
<div id="resultsViewerModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:3000; align-items:center; justify-content:center; overflow-y:auto;">
  <div style="background:white; padding:24px; border-radius:14px; max-width:600px; width:94%; margin:20px auto; box-shadow:0 6px 30px rgba(0,0,0,0.3);">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <h2 style="margin:0; font-size:18px;">ğŸ“Š í•™ìƒ ì±„ì  ê²°ê³¼</h2>
      <button onclick="closeResultsViewer()" style="padding:6px 12px; border:1px solid #ddd; border-radius:6px; background:#f5f5f5; cursor:pointer; font-size:13px;">âœ• ë‹«ê¸°</button>
    </div>
    <div style="display:flex; gap:8px; margin-bottom:14px; align-items:center; flex-wrap:wrap;">
      <button onclick="loadResults()" style="padding:8px 16px; background:#667eea; color:white; border:none; border-radius:6px; cursor:pointer; font-size:13px;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
      <select id="resultsFilterStudent" onchange="loadResults()" style="padding:7px; border:1px solid #ddd; border-radius:6px; font-size:13px;">
        <option value="">ì „ì²´ í•™ìƒ</option>
      </select>
      <span id="resultsLoadStatus" style="font-size:12px; color:#888;"></span>
    </div>
    <div id="resultsContainer" style="max-height:520px; overflow-y:auto;">
      <div style="text-align:center; color:#aaa; padding:40px;">ê²°ê³¼ í™•ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</div>
    </div>
  </div>
</div>

<script>
function openResultsViewer() {
    // í•™ìƒ í•„í„° ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸°
    const sel = document.getElementById('resultsFilterStudent');
    if (sel) {
        const students = JSON.parse(localStorage.getItem('students') || '[]');
        sel.innerHTML = '<option value="">ì „ì²´ í•™ìƒ</option>';
        students.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s; opt.textContent = s;
            sel.appendChild(opt);
        });
    }
    document.getElementById('resultsViewerModal').style.display = 'flex';
    loadResults();
}

function closeResultsViewer() {
    document.getElementById('resultsViewerModal').style.display = 'none';
}

async function loadResults() {
    const username = localStorage.getItem('gh_username');
    const repo     = localStorage.getItem('gh_repo');
    const token    = localStorage.getItem('gh_token');
    const status   = document.getElementById('resultsLoadStatus');
    const container = document.getElementById('resultsContainer');
    const filterStudent = document.getElementById('resultsFilterStudent')?.value || '';

    if (!username || !repo || !token) {
        container.innerHTML = '<div style="color:#e53935; padding:20px; text-align:center;">âš ï¸ GitHub ì„¤ì •ì„ ë¨¼ì € ì €ì¥í•´ì£¼ì„¸ìš”.</div>';
        return;
    }

    status.textContent = 'ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
    container.innerHTML = '<div style="text-align:center; color:#aaa; padding:30px;">â³ ë¡œë”© ì¤‘...</div>';

    try {
        const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/results`, {
            headers: { 'Authorization': 'token ' + token, 'Accept': 'application/vnd.github.v3+json' }
        });

        if (res.status === 404) {
            container.innerHTML = '<div style="text-align:center; color:#aaa; padding:30px;">ì•„ì§ ì €ì¥ëœ ì±„ì  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br><small>í•™ìƒì´ QR ì±„ì ì„ ì™„ë£Œí•˜ë©´ ì—¬ê¸°ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.</small></div>';
            status.textContent = '';
            return;
        }
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const files = await res.json();
        let resultFiles = files.filter(f => f.name.endsWith('_result.json')).reverse();

        if (resultFiles.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#aaa; padding:30px;">ì•„ì§ ì±„ì  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            status.textContent = '';
            return;
        }

        // ìµœëŒ€ 30ê°œ ë¡œë“œ
        const toLoad = resultFiles.slice(0, 30);
        const results = await Promise.all(toLoad.map(async f => {
            try { const r = await fetch(f.download_url); return await r.json(); }
            catch(e) { return null; }
        }));

        // í•™ìƒ í•„í„° ì ìš©
        const filtered = results.filter(Boolean).filter(r => !filterStudent || r.student === filterStudent);

        status.textContent = filtered.length + 'ê°œ ê²°ê³¼';

        if (filtered.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#aaa; padding:30px;">í•´ë‹¹ í•™ìƒì˜ ì±„ì  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        let html = '';
        filtered.forEach(r => {
            const pct = r.pct || 0;
            const color = pct >= 90 ? '#4CAF50' : pct >= 70 ? '#2196F3' : pct >= 50 ? '#FF9800' : '#f44336';
            const bg    = pct >= 90 ? '#f0fff4' : pct >= 70 ? '#e3f2fd' : pct >= 50 ? '#fff8e1' : '#fff5f5';
            const wrongNums = (r.results || []).filter(x => !x.correct).map(x => x.number + 'ë²ˆ').join(', ');
            const correctCount = (r.results || []).filter(x => x.correct).length;
            const totalCount = (r.results || []).length;

            html += `
            <div style="border:1px solid #eee; border-radius:10px; padding:14px; margin-bottom:10px; background:${bg};">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <div>
                        <strong style="font-size:15px;">ğŸ‘¤ ${r.student || '?'}</strong>
                        <span style="font-size:12px; color:#666; margin-left:8px;">${r.title || ''}</span>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-size:22px; font-weight:bold; color:${color};">${r.score !== undefined ? r.score + 'ì ' : '-'}</div>
                        <div style="font-size:11px; color:#888;">${correctCount}/${totalCount} ì •ë‹µ</div>
                    </div>
                </div>
                <div style="font-size:12px; color:#888; margin-bottom:6px;">ğŸ“… ${r.gradedAt || ''}</div>
                ${wrongNums
                    ? `<div style="font-size:12px; background:#fff0f0; padding:6px 10px; border-radius:6px; color:#e53935;">âŒ í‹€ë¦° ë¬¸ì œ: ${wrongNums}</div>`
                    : '<div style="font-size:12px; background:#f0fff4; padding:6px 10px; border-radius:6px; color:#4CAF50;">ğŸ‰ ì „ë¶€ ì •ë‹µ!</div>'
                }
            </div>`;
        });

        container.innerHTML = html;

    } catch(e) {
        container.innerHTML = `<div style="color:#e53935; padding:20px; text-align:center;">ì˜¤ë¥˜: ${e.message}</div>`;
        status.textContent = '';
    }
}
</script>
<!-- ===== ì±„ì  ê²°ê³¼ í™•ì¸ ë ===== -->

</body>
</html>