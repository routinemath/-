<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>ğŸ“ ìê°€ì±„ì </title>
<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
  background: #f0f2f5; min-height: 100vh;
}

/* â”€â”€ í—¤ë” â”€â”€ */
.header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; padding: 16px 16px 12px; text-align: center;
}
.header h1 { margin: 0 0 4px; font-size: 18px; }
.header p  { margin: 0; font-size: 12px; opacity: .8; }

/* â”€â”€ ë¬¸ì œ ì¹´ë“œ â”€â”€ */
.problem-wrap { padding: 12px 12px 120px; max-width: 480px; margin: 0 auto; }

.card {
  background: white; border-radius: 12px; padding: 14px 14px 10px;
  margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,.07);
  border-left: 4px solid #ddd; transition: border-color .3s, background .3s;
}
.card.correct { border-left-color: #4CAF50; background: #f0fff4; }
.card.wrong   { border-left-color: #f44336; background: #fff5f5; }
.card-num { font-weight: bold; font-size: 13px; color: #555; margin-bottom: 8px; }

/* â”€â”€ ìˆ˜ì‹ í€µë²„íŠ¼ ë°” â”€â”€ */
.quick-bar {
  display: flex; gap: 5px; overflow-x: auto; padding: 0 0 6px;
  scrollbar-width: none; margin-bottom: 6px;
}
.quick-bar::-webkit-scrollbar { display: none; }
.qb {
  flex-shrink: 0; padding: 5px 10px;
  background: #eef0fb; border: 1px solid #c5caf5;
  border-radius: 20px; font-size: 14px; cursor: pointer;
  color: #3949ab; font-weight: 500; white-space: nowrap;
  user-select: none; transition: background .1s;
}
.qb:active { background: #c5caf5; }

/* â”€â”€ ë‹µ ì…ë ¥ì°½ â”€â”€ */
.input-row { display: flex; gap: 8px; align-items: center; }
.ans-input {
  flex: 1; padding: 10px 12px; font-size: 16px;
  border: 2px solid #ddd; border-radius: 8px; outline: none;
  transition: border-color .2s; background: white;
  -webkit-user-select: text;
}
.ans-input:focus   { border-color: #667eea; }
.ans-input[disabled] { background: #fafafa; color: #333; }
.result-icon { font-size: 22px; min-width: 28px; text-align: center; }

/* â”€â”€ ì…ë ¥ ì˜ˆì‹œ â”€â”€ */
.input-hint {
  margin-top: 6px; padding: 6px 10px;
  background: #fffde7; border-radius: 6px;
  font-size: 11px; color: #888; line-height: 1.8;
  border-left: 3px solid #ffe082;
}
.input-hint strong { color: #f57f17; }

/* â”€â”€ ì±„ì  ë²„íŠ¼ â”€â”€ */
#submit-bar {
  position: fixed; bottom: 0; left: 0; width: 100%;
  padding: 10px 16px 16px; background: white;
  border-top: 1px solid #eee; z-index: 90;
}
#submit-bar button {
  width: 100%; padding: 14px; font-size: 16px; font-weight: bold;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; border: none; border-radius: 10px; cursor: pointer;
}

/* â”€â”€ ê²°ê³¼ í™”ë©´ â”€â”€ */
#result-screen {
  display: none; max-width: 480px; margin: 0 auto;
  padding: 20px 16px 40px; text-align: center;
}
.score-circle {
  width: 130px; height: 130px; border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  margin: 0 auto 16px; box-shadow: 0 6px 20px rgba(102,126,234,.4);
}
.score-num   { font-size: 42px; font-weight: bold; color: white; line-height: 1; }
.score-label { font-size: 13px; color: rgba(255,255,255,.8); margin-top: 3px; }
.score-msg   { font-size: 20px; font-weight: bold; margin: 0 0 16px; }
.result-list { text-align: left; background: white; border-radius: 12px; padding: 4px 16px; margin-bottom: 16px; }
.result-row  { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
.result-row:last-child { border-bottom: none; }
.tag-ok { color: #4CAF50; font-weight: bold; }
.tag-ng { color: #f44336; font-weight: bold; }
.btn-retry {
  width: 100%; padding: 14px; font-size: 15px; background: #FF9800;
  color: white; border: none; border-radius: 10px; cursor: pointer;
}
#save-notice { font-size: 12px; color: #888; margin-top: 12px; line-height: 1.6; }
</style>
</head>
<body>

<div class="header">
  <h1 id="hTitle">ğŸ“ ìê°€ì±„ì </h1>
  <p  id="hSub">ë¡œë”© ì¤‘...</p>
</div>

<div id="loading" style="padding:60px 20px;text-align:center;color:#888;">
  <div style="font-size:40px;margin-bottom:12px;">â³</div>
  <div>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>
<div id="error" style="display:none;padding:60px 20px;text-align:center;color:#e53935;">
  <div style="font-size:40px;margin-bottom:12px;">âš ï¸</div>
  <div id="errorMsg">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
  <div style="font-size:12px;color:#aaa;margin-top:8px;">URLì„ í™•ì¸í•˜ê±°ë‚˜ ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”.</div>
</div>

<div id="main" style="display:none;">
  <div class="problem-wrap" id="problemWrap"></div>
  <div id="submit-bar"><button onclick="submitAll()">âœ… ì±„ì í•˜ê¸°</button></div>
</div>

<div id="result-screen">
  <div class="score-circle">
    <div class="score-num"  id="rScore"></div>
    <div class="score-label" id="rTotal"></div>
  </div>
  <div class="score-msg" id="rMsg"></div>
  <div class="result-list" id="rList"></div>
  <button class="btn-retry" onclick="retryAll()">ğŸ”„ ë‹¤ì‹œ í’€ê¸°</button>
  <p id="save-notice"></p>
</div>

<script>
let examData = null;

// â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  const id = new URLSearchParams(location.search).get('id');
  if (!id) { showError('QR ì½”ë“œì— ë¬¸ì œ IDê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }
  const base = location.href.replace(/\/grading\.html.*$/, '');
  try {
    const res = await fetch(base + '/answers/' + id + '.json');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    examData = await res.json();
    examData._id   = id;
    examData._base = base;
    renderProblems();
  } catch(e) {
    showError('ë¬¸ì œ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><small>' + e.message + '</small>');
  }
})();

function showError(msg) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display   = 'block';
  document.getElementById('errorMsg').innerHTML    = msg;
}

// â”€â”€ í€µë²„íŠ¼ ì •ì˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// [í‘œì‹œ ë¼ë²¨, ì‚½ì… ë¬¸ìì—´]
const QUICK_BTNS = [
  ['â‘ ','â‘ '], ['â‘¡','â‘¡'], ['â‘¢','â‘¢'], ['â‘£','â‘£'], ['â‘¤','â‘¤'],
  ['âˆš ','âˆš'], ['^','^ '],  ['/','/ '],
  ['x','x'],  ['y','y'],  ['n','n'],  ['a','a'],
  ['Ï€','Ï€'],  ['Â²','Â²'],  ['Â³','Â³'],
  ['(','('],  [')',')'  ],
  ['+','+'],['-','-'],['Ã—','Ã—'],
  ['â‰¤','â‰¤'],['â‰¥','â‰¥'],['â‰ ','â‰ '],
];

// â”€â”€ ë¬¸ì œ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProblems() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('hTitle').textContent = 'ğŸ“ ' + examData.title;
  document.getElementById('hSub').textContent   = examData.student + ' | ' + (examData.date || '');

  const wrap = document.getElementById('problemWrap');
  wrap.innerHTML = '';

  examData.problems.forEach(p => {
    // í€µë²„íŠ¼ ë°” HTML
    const qbHTML = QUICK_BTNS.map(([label, val]) =>
      `<button class="qb" onclick="insertQuick('inp_${p.number}','${val.replace(/'/g,"\\'")}')">
        ${label}
      </button>`
    ).join('');

    const card = document.createElement('div');
    card.className = 'card';
    card.id = 'card_' + p.number;
    card.innerHTML = `
      <div class="card-num">ë¬¸ì œ ${p.number}ë²ˆ</div>
      <div class="quick-bar">${qbHTML}</div>
      <div class="input-row">
        <input class="ans-input" id="inp_${p.number}"
          type="text" inputmode="text"
          placeholder="ë‹µì„ ì…ë ¥í•˜ì„¸ìš”"
          autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
        <span class="result-icon" id="icon_${p.number}"></span>
      </div>
      <div class="input-hint">
        ğŸ’¡ <strong>ì…ë ¥ ì˜ˆì‹œ</strong> &nbsp;
        ë¶„ìˆ˜: <strong>3/4</strong> &nbsp;|&nbsp;
        ë£¨íŠ¸: <strong>âˆš3</strong> &nbsp;|&nbsp;
        ê±°ë“­ì œê³±: <strong>x^2</strong>, <strong>x^3</strong> &nbsp;|&nbsp;
        í˜¼í•©: <strong>2âˆš3</strong>, <strong>1/âˆš2</strong>, <strong>3x^2+1</strong>
      </div>`;
    wrap.appendChild(card);
  });

  document.getElementById('main').style.display = 'block';
}

// â”€â”€ í€µë²„íŠ¼ ì‚½ì… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function insertQuick(inputId, val) {
  const el = document.getElementById(inputId);
  if (!el || el.disabled) return;
  el.focus();
  // selectionStart/Endë¡œ ì»¤ì„œ ìœ„ì¹˜ì— ì‚½ì…
  const start = el.selectionStart ?? el.value.length;
  const end   = el.selectionEnd   ?? el.value.length;
  const v = el.value;
  el.value = v.slice(0, start) + val + v.slice(end);
  const pos = start + val.length;
  el.setSelectionRange(pos, pos);
  // í¬ì»¤ìŠ¤ ìœ ì§€ (ëª¨ë°”ì¼ í‚¤ë³´ë“œ ìœ ì§€)
  setTimeout(() => el.focus(), 0);
}

// â”€â”€ ì •ê·œí™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function norm(s) {
  if (!s && s !== 0) return '';
  return s.toString().trim().toLowerCase()
    .replace(/\s+/g, '')
    // ì§€ìˆ˜ í‘œê¸° í†µì¼: x^2 â†” xÂ², x^3 â†” xÂ³
    .replace(/\^2/g, 'Â²').replace(/\^3/g, 'Â³')
    .replace(/Ã—/g,'*').replace(/Ã·/g,'/')
    .replace(/[ï¼ˆ(]/g,'(').replace(/[ï¼‰)]/g,')')
    .replace(/[ï¼Œ,]/g,',').replace(/ï¼/g,'-').replace(/ï¼‹/g,'+')
    .replace(/â‘ /g,'1').replace(/â‘¡/g,'2').replace(/â‘¢/g,'3')
    .replace(/â‘£/g,'4').replace(/â‘¤/g,'5');
}

// â”€â”€ ì±„ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitAll() {
  if (!examData) return;

  let correct = 0;
  let listHTML = '';
  const resultData = [];

  examData.problems.forEach(p => {
    const inp  = document.getElementById('inp_'  + p.number);
    const card = document.getElementById('card_' + p.number);
    const icon = document.getElementById('icon_' + p.number);

    const userAns = inp ? inp.value.trim() : '';
    const corrAns = p.answer || '';
    const ok = corrAns && norm(userAns) === norm(corrAns);

    if (ok) correct++;
    card.className   = 'card ' + (ok ? 'correct' : 'wrong');
    icon.textContent = ok ? 'âœ…' : 'âŒ';
    if (inp) inp.disabled = true;

    // ì˜¤ë‹µ ì‹œ ì •ë‹µ í‘œì‹œ ì•ˆ í•¨ (ìŠ¤ìŠ¤ë¡œ ë‹¤ì‹œ í’€ê¸°)
    listHTML += `
      <div class="result-row">
        <span style="font-weight:bold;">${p.number}ë²ˆ</span>
        <span class="${ok ? 'tag-ok' : 'tag-ng'}">${ok ? 'âœ… ì •ë‹µ' : 'âŒ ì˜¤ë‹µ'}</span>
      </div>`;

    resultData.push({ number: p.number, userAnswer: userAns, correct: ok });
  });

  const total = examData.problems.length;
  const pct   = Math.round(correct / total * 100);
  document.getElementById('rScore').textContent = correct;
  document.getElementById('rTotal').textContent = '/ ' + total + 'ë¬¸ì œ';
  document.getElementById('rMsg').textContent   =
    pct >= 90 ? 'ğŸ‰ ì™„ë²½í•´ìš”!' :
    pct >= 70 ? 'ğŸ‘ ì˜í–ˆì–´ìš”!' :
    pct >= 50 ? 'ğŸ’ª ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë´ìš”!' : 'ğŸ˜Š ë‹¤ì‹œ ë„ì „í•´ë´ìš”!';
  document.getElementById('rList').innerHTML = listHTML;

  document.getElementById('main').style.display          = 'none';
  document.getElementById('submit-bar').style.display    = 'none';
  document.getElementById('result-screen').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});

  saveResult(resultData, correct, total);
}

// â”€â”€ ì±„ì  ê²°ê³¼ GitHub ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveResult(resultData, correct, total) {
  const notice   = document.getElementById('save-notice');
  const token    = examData._token;
  const username = examData._username;
  const repo     = examData._repo;

  if (!token || !username || !repo) {
    notice.textContent = 'ì ìˆ˜ë¥¼ ì„ ìƒë‹˜ê»˜ ì•Œë ¤ì£¼ì„¸ìš”: ' + correct + '/' + total + 'ì  (' + Math.round(correct/total*100) + '%)';
    return;
  }

  notice.textContent = 'ğŸ“¤ ê²°ê³¼ ì €ì¥ ì¤‘...';

  const payload = {
    examId:   examData._id,
    title:    examData.title,
    student:  examData.student,
    date:     examData.date,
    gradedAt: new Date().toLocaleString('ko-KR'),
    score:    correct + '/' + total,
    pct:      Math.round(correct / total * 100),
    results:  resultData
  };

  try {
    const filename = 'results/' + examData._id + '_result.json';
    const content  = btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2))));
    const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
      method: 'PUT',
      headers: {
        'Authorization': 'token ' + token,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        message: 'ì±„ì ê²°ê³¼|' + examData.student + '|' + correct + '/' + total,
        content
      })
    });

    if (res.ok) {
      notice.textContent = 'âœ… ì±„ì  ê²°ê³¼ê°€ ì„ ìƒë‹˜ê»˜ ìë™ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! (' + correct + '/' + total + 'ì )';
    } else {
      throw new Error('ì €ì¥ ì‹¤íŒ¨');
    }
  } catch(e) {
    notice.textContent = 'ì ìˆ˜ë¥¼ ì„ ìƒë‹˜ê»˜ ì•Œë ¤ì£¼ì„¸ìš”: ' + correct + '/' + total + 'ì ';
  }
}

// â”€â”€ ë‹¤ì‹œ í’€ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function retryAll() {
  if (!examData) return;
  examData.problems.forEach(p => {
    const inp  = document.getElementById('inp_'  + p.number);
    const card = document.getElementById('card_' + p.number);
    const icon = document.getElementById('icon_' + p.number);
    const hint = card ? card.querySelector('.input-hint') : null;
    if (inp)  { inp.value = ''; inp.disabled = false; }
    if (card) card.className = 'card';
    if (icon) icon.textContent = '';
    if (hint) hint.style.display = '';
  });
  document.getElementById('result-screen').style.display = 'none';
  document.getElementById('main').style.display          = 'block';
  document.getElementById('submit-bar').style.display    = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}
</script>
</body>
</html>
