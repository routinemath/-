<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ğŸ“ ìŠ¤ë§ˆíŠ¸ ìê°€ì±„ì </title>
<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
  background: #f4f6f9; min-height: 100vh;
}

/* â”€â”€ í—¤ë” â”€â”€ */
.header {
  background: linear-gradient(135deg, #4F46E5, #7C3AED);
  color: white; padding: 20px 16px 16px; text-align: center;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.header h1 { margin: 0 0 6px; font-size: 19px; font-weight: 700; }
.header p  { margin: 0; font-size: 13px; opacity: 0.9; }

/* â”€â”€ ë¬¸ì œ ì¹´ë“œ â”€â”€ */
.problem-wrap { padding: 16px 16px 100px; max-width: 500px; margin: 0 auto; }
.card {
  background: white; border-radius: 16px; padding: 20px;
  margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.04);
  border: 1px solid #edf2f7; transition: all 0.3s ease;
}
.card.correct { border: 2px solid #10B981; background: #F0FDF4; }
.card.wrong   { border: 2px solid #EF4444; background: #FEF2F2; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.card-num { font-weight: 700; font-size: 15px; color: #374151; background: #F3F4F6; padding: 4px 10px; border-radius: 8px; }
.result-icon { font-size: 20px; font-weight: bold; }

/* â”€â”€ ë©”íƒ€ì¸ì§€ ë±ƒì§€ â”€â”€ */
.meta-badge {
  display: inline-block; padding: 6px 10px; font-size: 13px; font-weight: bold;
  background: #FEE2E2; color: #EF4444; border-radius: 8px; margin-top: 10px;
}

/* â”€â”€ ë‹µ ì…ë ¥ì°½ â”€â”€ */
.ans-input {
  width: 100%; padding: 14px 16px; font-size: 18px; font-weight: bold;
  border: 2px solid #E5E7EB; border-radius: 12px; outline: none;
  transition: all 0.2s; background: #F9FAFB; text-align: center;
}
.ans-input:focus { border-color: #4F46E5; background: white; box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
.ans-input[disabled] { background: transparent; color: #111827; border-color: transparent; padding: 0; font-size: 24px; }

/* â”€â”€ ìˆ˜ì‹ í€µë²„íŠ¼ ë°” (2ë‹¨ ê³ ì •) â”€â”€ */
.quick-rows { display: flex; flex-direction: column; gap: 8px; margin-top: 12px; }
.quick-row { display: flex; gap: 8px; }
.qb {
  flex: 1; padding: 12px 0; text-align: center;
  background: #EEF2FF; border: 1px solid #C7D2FE;
  border-radius: 8px; font-size: 16px; cursor: pointer;
  color: #4F46E5; font-weight: 600; touch-action: manipulation;
}
.qb:active { background: #C7D2FE; }

/* â”€â”€ í•˜ë‹¨ ê³ ì • ë²„íŠ¼ â”€â”€ */
#submit-bar {
  position: fixed; bottom: 0; left: 0; width: 100%;
  padding: 12px 16px 24px; background: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px); border-top: 1px solid #E5E7EB; z-index: 90;
}
.btn-primary {
  width: 100%; max-width: 500px; margin: 0 auto; display: block;
  padding: 16px; font-size: 17px; font-weight: bold;
  background: linear-gradient(135deg, #4F46E5, #7C3AED);
  color: white; border: none; border-radius: 14px; cursor: pointer;
  box-shadow: 0 4px 12px rgba(79,70,229,0.3);
}

/* â”€â”€ ê²°ê³¼ í™”ë©´ â”€â”€ */
#result-screen { display: none; max-width: 500px; margin: 0 auto; padding: 40px 20px 80px; text-align: center; }
.score-circle {
  width: 140px; height: 140px; border-radius: 50%;
  background: linear-gradient(135deg, #10B981, #059669);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  margin: 0 auto 24px; box-shadow: 0 8px 24px rgba(16,185,129,0.3); color: white;
}
.score-num { font-size: 48px; font-weight: 800; line-height: 1; }
.score-label { font-size: 14px; opacity: 0.9; margin-top: 4px; }
.score-msg { font-size: 24px; font-weight: 800; margin-bottom: 30px; color: #111827; }
.btn-retry {
  width: 100%; padding: 18px; font-size: 17px; font-weight: bold;
  background: #F59E0B; color: white; border: none; border-radius: 14px; cursor: pointer;
  box-shadow: 0 4px 12px rgba(245,158,11,0.3);
}

/* â”€â”€ ë©”íƒ€ì¸ì§€ íŒì—… â”€â”€ */
#metaOverlay {
  display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 20px;
}
.meta-box { background: white; border-radius: 16px; padding: 24px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
.meta-btn {
  width: 100%; padding: 16px; font-size: 15px; font-weight: bold; color: #374151;
  background: #F3F4F6; border: 2px solid #E5E7EB; border-radius: 12px; cursor: pointer;
  margin-bottom: 10px; text-align: left; transition: all 0.2s;
}
.meta-btn:active { background: #E5E7EB; border-color: #D1D5DB; }
</style>
</head>
<body>

<div class="header">
  <h1 id="hTitle">ğŸ“ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
  <p id="hSub">QR ì½”ë“œë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
</div>

<div id="loading" style="padding:80px 20px;text-align:center;color:#6B7280;">
  <div style="font-size:48px;margin-bottom:16px;">â³</div>
  <div style="font-size: 16px; font-weight: bold;">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<div id="main" style="display:none;">
  <div class="problem-wrap" id="problemWrap"></div>
  <div id="submit-bar"><button class="btn-primary" onclick="submitAll()">âœ… ì±„ì  ì™„ë£Œí•˜ê¸°</button></div>
</div>

<div id="result-screen">
  <div class="score-circle">
    <div class="score-num" id="rScore"></div>
    <div class="score-label" id="rTotal"></div>
  </div>
  <div class="score-msg" id="rMsg"></div>
  <p style="color: #6B7280; margin-bottom: 20px; line-height: 1.6;">í‹€ë¦° ë¬¸ì œëŠ” ë‹¤ì‹œ í’€ì–´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤!</p>
  <button class="btn-retry" onclick="retryAll()">ğŸ”„ í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°</button>
</div>

<div id="metaOverlay">
  <div class="meta-box">
    <h2 style="margin:0 0 10px; color:#374151; font-size: 20px;">ì ê¹! ì˜¤ë‹µ ì›ì¸ ë¶„ì„ ğŸ§</h2>
    <p style="margin:0 0 20px; color:#6B7280; font-size:15px; line-height: 1.5;">
      ì•—, <strong id="metaProbNum" style="color:#EF4444; font-size:20px;"></strong>ë²ˆ ë¬¸ì œë¥¼ í‹€ë ¸ë„¤ìš”.<br>ìŠ¤ìŠ¤ë¡œ ìƒê°í•˜ê¸°ì— ì™œ í‹€ë¦° ê²ƒ ê°™ë‚˜ìš”?
    </p>
    <div style="display:flex; flex-direction:column;">
      <button class="meta-btn" onclick="selectMetaReason('ê³„ì‚°ì‹¤ìˆ˜')">ğŸ§® ì•„ì°¨! ë‹¨ìˆœ ê³„ì‚° ì‹¤ìˆ˜</button>
      <button class="meta-btn" onclick="selectMetaReason('ì§‘ì¤‘ë ¥ë¶€ì¡±')">ğŸ˜µ ì•„ë¿”ì‹¸! ë¬¸ì œë¥¼ ì˜ëª» ì½ìŒ</button>
      <button class="meta-btn" onclick="selectMetaReason('ì¡°ê±´í™œìš©ëª»í•¨')">âš™ï¸ ì£¼ì–´ì§„ ì¡°ê±´(íŒíŠ¸)ì„ ëª» ì”€</button>
      <button class="meta-btn" onclick="selectMetaReason('ì‹ì„¸ìš°ê¸°ì–´ë ¤ì›€')">ğŸ§© ì‹ ì„¸ìš°ê¸°ê°€ ì–´ë ¤ì›€</button>
      <button class="meta-btn" onclick="selectMetaReason('ê°œë…ì—°ê²°ëª»í•¨')">ğŸ“– ì–´ë–»ê²Œ í‘¸ëŠ”ì§€ ì•„ì˜ˆ ëª¨ë¥´ê² ìŒ</button>
    </div>
  </div>
</div>

<script>
let examData = null;
const ROW1 = [['â‘ ','â‘ '], ['â‘¡','â‘¡'], ['â‘¢','â‘¢'], ['â‘£','â‘£'], ['â‘¤','â‘¤']];
const ROW2 = [['âˆš','âˆš'], ['Â²','Â²'], ['Â³','Â³'], ['ë¶„ìˆ˜(/)','/'], ['Ï€','Ï€']];

// ë©”íƒ€ì¸ì§€ íŒì—…ìš© í
let wrongQueue = [];
let currentMetaIndex = 0;

(async function init() {
  const id = new URLSearchParams(location.search).get('id');
  const base = location.href.replace(/\/grading\.html.*$/, '');
  try {
    const res = await fetch(base + '/answers/' + id + '.json');
    examData = await res.json();
    renderProblems();
  } catch(e) {
    document.getElementById('loading').innerHTML = 'âš ï¸ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
  }
})();

function renderProblems() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('hTitle').textContent = examData.title;
  document.getElementById('hSub').textContent = 'ğŸ‘¤ ' + examData.student;

  const wrap = document.getElementById('problemWrap');
  let html = '';

  const genRow = (arr, pNum) => arr.map(([label, val]) =>
    `<button type="button" class="qb" onmousedown="event.preventDefault();" onclick="insertQuick('inp_${pNum}','${val}')">${label}</button>`
  ).join('');

  examData.problems.forEach(p => {
    html += `
      <div class="card" id="card_${p.number}">
        <div class="card-header">
          <div class="card-num">${p.number}ë²ˆ</div>
          <div class="result-icon" id="icon_${p.number}"></div>
        </div>
        <input class="ans-input" id="inp_${p.number}" type="text" placeholder="ì •ë‹µ ì…ë ¥" autocomplete="off" spellcheck="false">
        <div class="quick-rows" id="qb_${p.number}">
          <div class="quick-row">${genRow(ROW1, p.number)}</div>
          <div class="quick-row">${genRow(ROW2, p.number)}</div>
        </div>
        <div id="meta_badge_${p.number}" style="display:none;"></div>
      </div>`;
  });

  wrap.innerHTML = html;
  document.getElementById('main').style.display = 'block';
}

function insertQuick(inputId, val) {
  const el = document.getElementById(inputId);
  if (!el || el.disabled) return;
  const start = el.selectionStart || el.value.length;
  const end = el.selectionEnd || el.value.length;
  const v = el.value;
  el.value = v.slice(0, start) + val + v.slice(end);
  el.setSelectionRange(start + val.length, start + val.length);
  el.focus();
}

function norm(s) {
  if (!s && s !== 0) return '';
  return s.toString().trim().toLowerCase()
    .replace(/\s+/g, '')
    .replace(/\^2/g, 'Â²').replace(/\^3/g, 'Â³')
    .replace(/Ã—/g,'*').replace(/Ã·/g,'/')
    .replace(/[ï¼ˆ(]/g,'(').replace(/[ï¼‰)]/g,')')
    .replace(/[â‘ ]/g,'1').replace(/[â‘¡]/g,'2').replace(/[â‘¢]/g,'3').replace(/[â‘£]/g,'4').replace(/[â‘¤]/g,'5');
}

// ğŸ’¡ 1ë‹¨ê³„: ì±„ì  í›„ ì˜¤ë‹µ í•„í„°ë§
function submitAll() {
  if (!examData) return;
  wrongQueue = [];
  
  examData.problems.forEach(p => {
    const inp = document.getElementById('inp_' + p.number);
    const userAns = inp ? inp.value.trim() : '';
    const corrAns = p.answer || '';
    const ok = corrAns && norm(userAns) === norm(corrAns);
    
    p.userAns = userAns;
    p.ok = ok;
    
    if (!ok) {
      wrongQueue.push(p);
    }
  });

  if (wrongQueue.length > 0) {
    currentMetaIndex = 0;
    showMetaPopup(); // ì˜¤ë‹µì´ ìˆìœ¼ë©´ íŒì—… ë¨¼ì € ë„ì›€
  } else {
    finalizeSubmit(); // ë‹¤ ë§ì·„ìœ¼ë©´ ë°”ë¡œ ê²°ê³¼ í™”ë©´
  }
}

// ğŸ’¡ 2ë‹¨ê³„: ë©”íƒ€ì¸ì§€ íŒì—… í‘œì‹œ
function showMetaPopup() {
  const currentProblem = wrongQueue[currentMetaIndex];
  document.getElementById('metaProbNum').textContent = currentProblem.number;
  document.getElementById('metaOverlay').style.display = 'flex';
}

// ğŸ’¡ 3ë‹¨ê³„: ì›ì¸ ì„ íƒ ì‹œ í ì§„í–‰
function selectMetaReason(reason) {
  const currentProblem = wrongQueue[currentMetaIndex];
  
  // í…ìŠ¤íŠ¸ ë³€í™˜ (í™”ë©´ í‘œì‹œìš©)
  const reasonTextMap = {
    'ê³„ì‚°ì‹¤ìˆ˜': 'ğŸ§® ì•„ì°¨! ë‹¨ìˆœ ê³„ì‚° ì‹¤ìˆ˜',
    'ì§‘ì¤‘ë ¥ë¶€ì¡±': 'ğŸ˜µ ì•„ë¿”ì‹¸! ë¬¸ì œë¥¼ ì˜ëª» ì½ìŒ',
    'ì¡°ê±´í™œìš©ëª»í•¨': 'âš™ï¸ ì£¼ì–´ì§„ ì¡°ê±´(íŒíŠ¸)ì„ ëª» ì”€',
    'ì‹ì„¸ìš°ê¸°ì–´ë ¤ì›€': 'ğŸ§© ì‹ ì„¸ìš°ê¸°ê°€ ì–´ë ¤ì›€',
    'ê°œë…ì—°ê²°ëª»í•¨': 'ğŸ“– ì–´ë–»ê²Œ í‘¸ëŠ”ì§€ ì•„ì˜ˆ ëª¨ë¥´ê² ìŒ'
  };
  
  currentProblem.metaReasonText = reasonTextMap[reason];

  currentMetaIndex++;
  if (currentMetaIndex < wrongQueue.length) {
    showMetaPopup(); // ë‹¤ìŒ ì˜¤ë‹µ ë¬¸ì œë¡œ
  } else {
    document.getElementById('metaOverlay').style.display = 'none';
    finalizeSubmit(); // ëª¨ë‘ ëë‚¬ìœ¼ë©´ ìµœì¢… ê²°ê³¼ í‘œì‹œ
  }
}

// ğŸ’¡ 4ë‹¨ê³„: ìµœì¢… UI ì—…ë°ì´íŠ¸
function finalizeSubmit() {
  let correct = 0;

  examData.problems.forEach(p => {
    const card = document.getElementById('card_' + p.number);
    const icon = document.getElementById('icon_' + p.number);
    const qb = document.getElementById('qb_' + p.number);
    const inp = document.getElementById('inp_' + p.number);
    const badge = document.getElementById('meta_badge_' + p.number);

    if (p.ok) correct++;

    card.className = 'card ' + (p.ok ? 'correct' : 'wrong');
    icon.textContent = p.ok ? 'âœ…' : 'âŒ';
    icon.style.color = p.ok ? '#10B981' : '#EF4444';
    
    if (inp) inp.disabled = true;
    if (qb) qb.style.display = 'none';

    // í•™ìƒì´ ì„ íƒí•œ ì˜¤ë‹µ ì›ì¸ì„ ì¹´ë“œì— ë±ƒì§€ë¡œ í‘œì‹œ
    if (!p.ok && p.metaReasonText) {
      badge.innerHTML = `<div class="meta-badge">ë‚˜ì˜ ì§„ë‹¨: ${p.metaReasonText}</div>`;
      badge.style.display = 'block';
    }
  });

  const total = examData.problems.length;
  const pct = Math.round(correct / total * 100);
  
  document.getElementById('rScore').textContent = correct;
  document.getElementById('rTotal').textContent = '/ ' + total + 'ë¬¸ì œ ì •ë‹µ';
  document.getElementById('rMsg').textContent =
    pct >= 90 ? 'ğŸ‰ ì™„ë²½í•´ìš”!' : pct >= 70 ? 'ğŸ‘ ì˜í–ˆì–´ìš”!' : 'ğŸ’ª ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë´ìš”!';

  document.getElementById('main').style.display = 'none';
  document.getElementById('result-screen').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}

// ë‹¤ì‹œ í’€ê¸°
function retryAll() {
  examData.problems.forEach(p => {
    const card = document.getElementById('card_' + p.number);
    const inp = document.getElementById('inp_' + p.number);
    const icon = document.getElementById('icon_' + p.number);
    const qb = document.getElementById('qb_' + p.number);
    const badge = document.getElementById('meta_badge_' + p.number);
    
    if (card && card.classList.contains('wrong')) {
      if (inp) { inp.value = ''; inp.disabled = false; }
      card.className = 'card';
      if (icon) icon.textContent = '';
      if (qb) qb.style.display = 'flex';
      if (badge) badge.style.display = 'none'; // ë‹¤ì‹œ í’€ë•ŒëŠ” ë±ƒì§€ ìˆ¨ê¹€
    }
  });
  
  document.getElementById('result-screen').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}
</script>
</body>
</html>