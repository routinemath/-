<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ğŸ“ ìŠ¤ë§ˆíŠ¸ ìê°€ì±„ì </title>
<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body {
  margin: 0; padding: 0;
  font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
  background: #f4f6f9; min-height: 100vh;
}

/* â”€â”€ í—¤ë” & ì§„í–‰ë¥  â”€â”€ */
.header {
  background: linear-gradient(135deg, #4F46E5, #7C3AED);
  color: white; padding: 20px 16px 16px; text-align: center;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.header h1 { margin: 0 0 6px; font-size: 19px; font-weight: 700; }
.header p  { margin: 0; font-size: 13px; opacity: 0.9; }

/* â”€â”€ ë¬¸ì œ ì¹´ë“œ â”€â”€ */
.problem-wrap { padding: 16px 16px 100px; max-width: 500px; margin: 0 auto; }
.card {
  background: white; border-radius: 16px; padding: 20px;
  margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.04);
  border: 1px solid #edf2f7; transition: all 0.3s ease;
}
.card.correct { border: 2px solid #10B981; background: #F0FDF4; }
.card.wrong   { border: 2px solid #EF4444; background: #FEF2F2; }
.card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.card-num { font-weight: 700; font-size: 15px; color: #374151; background: #F3F4F6; padding: 4px 10px; border-radius: 8px; }
.result-icon { font-size: 20px; font-weight: bold; }

/* â”€â”€ ë‹µ ì…ë ¥ì°½ â”€â”€ */
.ans-input {
  width: 100%; padding: 14px 16px; font-size: 18px; font-weight: bold;
  border: 2px solid #E5E7EB; border-radius: 12px; outline: none;
  transition: all 0.2s; background: #F9FAFB; text-align: center;
}
.ans-input:focus { border-color: #4F46E5; background: white; box-shadow: 0 0 0 3px rgba(79,70,229,0.1); }
.ans-input[disabled] { background: transparent; color: #111827; border-color: transparent; padding: 0; font-size: 24px; }

/* â”€â”€ ìˆ˜ì‹ í€µë²„íŠ¼ ë°” (ì…ë ¥í•  ë•Œë§Œ ë³´ì´ê²Œ ê¹”ë”í•˜ê²Œ) â”€â”€ */
.quick-bar {
  display: flex; gap: 6px; overflow-x: auto; padding: 12px 0 4px;
  scrollbar-width: none;
}
.quick-bar::-webkit-scrollbar { display: none; }
.qb {
  flex-shrink: 0; padding: 8px 14px;
  background: #EEF2FF; border: 1px solid #C7D2FE;
  border-radius: 10px; font-size: 15px; cursor: pointer;
  color: #4F46E5; font-weight: 600; white-space: nowrap;
  transition: background 0.1s;
}
.qb:active { background: #C7D2FE; }

/* â”€â”€ í•˜ë‹¨ ê³ ì • ë²„íŠ¼ â”€â”€ */
#submit-bar {
  position: fixed; bottom: 0; left: 0; width: 100%;
  padding: 12px 16px 24px; background: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px); border-top: 1px solid #E5E7EB; z-index: 90;
}
.btn-primary {
  width: 100%; max-width: 500px; margin: 0 auto; display: block;
  padding: 16px; font-size: 17px; font-weight: bold;
  background: linear-gradient(135deg, #4F46E5, #7C3AED);
  color: white; border: none; border-radius: 14px; cursor: pointer;
  box-shadow: 0 4px 12px rgba(79,70,229,0.3); transition: transform 0.1s;
}
.btn-primary:active { transform: scale(0.98); }

/* â”€â”€ ê²°ê³¼ í™”ë©´ â”€â”€ */
#result-screen { display: none; max-width: 500px; margin: 0 auto; padding: 30px 20px 60px; text-align: center; }
.score-circle {
  width: 140px; height: 140px; border-radius: 50%;
  background: linear-gradient(135deg, #10B981, #059669);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  margin: 0 auto 20px; box-shadow: 0 8px 24px rgba(16,185,129,0.3); color: white;
}
.score-num { font-size: 48px; font-weight: 800; line-height: 1; }
.score-label { font-size: 14px; opacity: 0.9; margin-top: 4px; }
.score-msg { font-size: 22px; font-weight: 800; margin-bottom: 24px; color: #111827; }

/* â”€â”€ ê²°ê³¼ ë³µì‚¬ ì¹´ë“œ â”€â”€ */
.copy-card {
  background: white; border-radius: 16px; padding: 24px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.06); margin-bottom: 24px; border: 1px solid #E5E7EB;
}
.btn-copy {
  width: 100%; padding: 16px; font-size: 16px; font-weight: bold;
  background: #F59E0B; color: white; border: none; border-radius: 12px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  box-shadow: 0 4px 12px rgba(245,158,11,0.3);
}
.btn-retry {
  width: 100%; padding: 16px; font-size: 16px; font-weight: bold;
  background: #F3F4F6; color: #4B5563; border: none; border-radius: 12px; cursor: pointer; margin-top: 12px;
}
</style>
</head>
<body>

<div class="header">
  <h1 id="hTitle">ğŸ“ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</h1>
  <p id="hSub">QR ì½”ë“œë¥¼ í™•ì¸í•˜ê³  ìˆìŠµë‹ˆë‹¤</p>
</div>

<div id="loading" style="padding:80px 20px;text-align:center;color:#6B7280;">
  <div style="font-size:48px;margin-bottom:16px; animation: spin 2s linear infinite;">â³</div>
  <div style="font-size: 16px; font-weight: bold;">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>

<div id="error" style="display:none;padding:80px 20px;text-align:center;color:#EF4444;">
  <div style="font-size:48px;margin-bottom:16px;">âš ï¸</div>
  <div id="errorMsg" style="font-size: 16px; font-weight: bold;">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
</div>

<div id="main" style="display:none;">
  <div class="problem-wrap" id="problemWrap"></div>
  <div id="submit-bar"><button class="btn-primary" onclick="submitAll()">âœ… ì±„ì  ì™„ë£Œí•˜ê¸°</button></div>
</div>

<div id="result-screen">
  <div class="score-circle">
    <div class="score-num" id="rScore"></div>
    <div class="score-label" id="rTotal"></div>
  </div>
  <div class="score-msg" id="rMsg"></div>
  
  <div class="copy-card">
    <p style="margin: 0 0 16px; color: #4B5563; font-size: 14px; line-height: 1.5;">
      ì±„ì ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!<br>ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ <strong>ê²°ê³¼ë¥¼ ì„ ìƒë‹˜ê»˜ ì¹´í†¡ìœ¼ë¡œ</strong> ë³´ë‚´ì£¼ì„¸ìš”.
    </p>
    <button class="btn-copy" onclick="copyResultCode()">
      <span>ğŸ“‹</span> ê²°ê³¼ë¥¼ ë³µì‚¬í•´ì„œ ì¹´í†¡ ë³´ë‚´ê¸°
    </button>
  </div>
  
  <button class="btn-retry" onclick="retryAll()">ğŸ”„ í‹€ë¦° ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°</button>
</div>

<script>
let examData = null;

// â”€â”€ í€µë²„íŠ¼ ì •ì˜ â”€â”€
const QUICK_BTNS = [
  ['â‘ ','â‘ '], ['â‘¡','â‘¡'], ['â‘¢','â‘¢'], ['â‘£','â‘£'], ['â‘¤','â‘¤'],
  ['âˆš','âˆš'], ['^2','Â²'], ['^3','Â³'], ['ë¶„ìˆ˜(/)','/'], 
  ['x','x'], ['y','y'], ['a','a'], ['Ï€','Ï€'],
  ['(','('], [')',')'], ['+','+'], ['-','-'], ['Ã—','Ã—']
];

// â”€â”€ ì´ˆê¸°í™” â”€â”€
(async function init() {
  const id = new URLSearchParams(location.search).get('id');
  if (!id) { showError('QR ì½”ë“œ ì •ë³´ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.'); return; }
  const base = location.href.replace(/\/grading\.html.*$/, '');
  
  try {
    const res = await fetch(base + '/answers/' + id + '.json');
    if (!res.ok) throw new Error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    examData = await res.json();
    renderProblems();
  } catch(e) {
    showError('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
  }
})();

function showError(msg) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'block';
  document.getElementById('errorMsg').innerHTML = msg;
}

// â”€â”€ ë¬¸ì œ ë Œë”ë§ â”€â”€
function renderProblems() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('hTitle').textContent = examData.title;
  document.getElementById('hSub').textContent = 'ğŸ‘¤ ' + examData.student + ' | ğŸ“… ' + (examData.date || '');

  const wrap = document.getElementById('problemWrap');
  let html = '';

  const qbHTML = QUICK_BTNS.map(([label, val]) =>
    `<button class="qb" onclick="insertQuick('inp_#NUM#','${val}')">${label}</button>`
  ).join('');

  examData.problems.forEach(p => {
    html += `
      <div class="card" id="card_${p.number}">
        <div class="card-header">
          <div class="card-num">${p.number}ë²ˆ</div>
          <div class="result-icon" id="icon_${p.number}"></div>
        </div>
        <input class="ans-input" id="inp_${p.number}" type="text" placeholder="ì—¬ê¸°ë¥¼ í„°ì¹˜í•´ ë‹µ ì…ë ¥" autocomplete="off" autocorrect="off" spellcheck="false">
        <div class="quick-bar" id="qb_${p.number}" style="display:none;">
          ${qbHTML.replace(/#NUM#/g, p.number)}
        </div>
      </div>`;
  });

  wrap.innerHTML = html;
  document.getElementById('main').style.display = 'block';

  // ì…ë ¥ì°½ í„°ì¹˜ ì‹œ í€µë²„íŠ¼ í‘œì‹œ ë¡œì§
  examData.problems.forEach(p => {
    const inp = document.getElementById('inp_' + p.number);
    const qb = document.getElementById('qb_' + p.number);
    inp.addEventListener('focus', () => { qb.style.display = 'flex'; });
    inp.addEventListener('blur', () => { setTimeout(() => { qb.style.display = 'none'; }, 200); });
  });
}

// â”€â”€ í€µë²„íŠ¼ ì‚½ì… â”€â”€
function insertQuick(inputId, val) {
  const el = document.getElementById(inputId);
  if (!el || el.disabled) return;
  const start = el.selectionStart || el.value.length;
  const end = el.selectionEnd || el.value.length;
  const v = el.value;
  el.value = v.slice(0, start) + val + v.slice(end);
  el.setSelectionRange(start + val.length, start + val.length);
  el.focus();
}

// â”€â”€ ì •ê·œí™” (ì±„ì ìš©) â”€â”€
function norm(s) {
  if (!s && s !== 0) return '';
  return s.toString().trim().toLowerCase()
    .replace(/\s+/g, '')
    .replace(/\^2/g, 'Â²').replace(/\^3/g, 'Â³')
    .replace(/Ã—/g,'*').replace(/Ã·/g,'/')
    .replace(/[ï¼ˆ(]/g,'(').replace(/[ï¼‰)]/g,')')
    .replace(/[ï¼Œ,]/g,',').replace(/ï¼/g,'-').replace(/ï¼‹/g,'+')
    .replace(/â‘ /g,'1').replace(/â‘¡/g,'2').replace(/â‘¢/g,'3')
    .replace(/â‘£/g,'4').replace(/â‘¤/g,'5');
}

// â”€â”€ ì±„ì í•˜ê¸° â”€â”€
function submitAll() {
  if (!examData) return;
  let correct = 0;

  examData.problems.forEach(p => {
    const inp = document.getElementById('inp_' + p.number);
    const card = document.getElementById('card_' + p.number);
    const icon = document.getElementById('icon_' + p.number);
    const qb = document.getElementById('qb_' + p.number);

    const userAns = inp ? inp.value.trim() : '';
    const corrAns = p.answer || '';
    const ok = corrAns && norm(userAns) === norm(corrAns);

    if (ok) correct++;
    
    // UI ì—…ë°ì´íŠ¸
    card.className = 'card ' + (ok ? 'correct' : 'wrong');
    icon.textContent = ok ? 'âœ…' : 'âŒ';
    icon.style.color = ok ? '#10B981' : '#EF4444';
    if (inp) inp.disabled = true;
    if (qb) qb.style.display = 'none';
  });

  const total = examData.problems.length;
  const pct = Math.round(correct / total * 100);
  
  document.getElementById('rScore').textContent = correct;
  document.getElementById('rTotal').textContent = '/ ' + total + 'ë¬¸ì œ ì •ë‹µ';
  document.getElementById('rMsg').textContent =
    pct >= 90 ? 'ğŸ‰ ì™„ë²½í•´ìš”!' :
    pct >= 70 ? 'ğŸ‘ ì˜í–ˆì–´ìš”!' :
    pct >= 50 ? 'ğŸ’ª ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë´ìš”!' : 'ğŸ˜Š ë‹¤ì‹œ ë„ì „í•´ë´ìš”!';

  document.getElementById('main').style.display = 'none';
  document.getElementById('result-screen').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}

// â”€â”€ ê²°ê³¼ ë³µì‚¬í•˜ê¸° (ì¹´í†¡ ì—°ë™ í•µì‹¬ ë¡œì§) â”€â”€
function copyResultCode() {
  // Aì œëª©|Bí•™ìƒ|1:ë‹µ,2:ë‹µ... í˜•íƒœë¡œ ì•”í˜¸í™” ì½”ë“œ ìƒì„±
  let ansStr = examData.problems.map(p => {
    const inp = document.getElementById('inp_' + p.number);
    return p.number + ':' + (inp ? inp.value.trim() : '');
  }).join(',');
  
  const resultCode = 'A' + examData.title + '|B' + examData.student + '|' + ansStr;

  // í´ë¦½ë³´ë“œ ë³µì‚¬
  navigator.clipboard.writeText(resultCode).then(() => {
    alert('âœ… ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\nì¹´ì¹´ì˜¤í†¡ì„ ì—´ê³  ì„ ìƒë‹˜ê»˜ ë¶™ì—¬ë„£ê¸°ë¡œ ë³´ë‚´ì£¼ì„¸ìš”.');
  }).catch(() => {
    // ë³µì‚¬ ê¶Œí•œì´ ì—†ëŠ” êµ¬í˜• ë¸Œë¼ìš°ì € ëŒ€ë¹„
    prompt('ì•„ë˜ í…ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ë³µì‚¬í•´ì„œ ì„ ìƒë‹˜ê»˜ ë³´ë‚´ì£¼ì„¸ìš”.', resultCode);
  });
}

// â”€â”€ ë‹¤ì‹œ í’€ê¸° â”€â”€
function retryAll() {
  examData.problems.forEach(p => {
    const inp = document.getElementById('inp_' + p.number);
    const card = document.getElementById('card_' + p.number);
    const icon = document.getElementById('icon_' + p.number);
    
    // í‹€ë¦° ë¬¸ì œë§Œ ë‹¤ì‹œ í’€ ìˆ˜ ìˆë„ë¡ í™œì„±í™”
    if (card && card.classList.contains('wrong')) {
      if (inp) { inp.value = ''; inp.disabled = false; }
      card.className = 'card';
      if (icon) icon.textContent = '';
    }
  });
  
  document.getElementById('result-screen').style.display = 'none';
  document.getElementById('main').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}
</script>
</body>
</html>