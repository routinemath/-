<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>ğŸ“ ìê°€ì±„ì </title>
<style>
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; padding: 0; font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background: #f0f2f5; min-height: 100vh; }

.header {
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; padding: 16px 16px 12px; text-align: center;
}
.header h1 { margin: 0 0 4px; font-size: 18px; }
.header p  { margin: 0; font-size: 12px; opacity: .8; }

.problem-wrap { padding: 12px 12px 100px; max-width: 480px; margin: 0 auto; }

.card {
  background: white; border-radius: 12px; padding: 14px;
  margin-bottom: 10px; box-shadow: 0 2px 8px rgba(0,0,0,.07);
  border-left: 4px solid #ddd; transition: border-color .3s, background .3s;
}
.card.correct { border-left-color: #4CAF50; background: #f0fff4; }
.card.wrong   { border-left-color: #f44336; background: #fff5f5; }
.card-num { font-weight: bold; font-size: 13px; color: #555; margin-bottom: 8px; }

.input-row { display: flex; gap: 8px; align-items: center; }
.ans-input {
  flex: 1; padding: 10px 12px; font-size: 16px;
  border: 2px solid #ddd; border-radius: 8px; outline: none;
  transition: border-color .2s; background: white; cursor: pointer;
  caret-color: transparent; /* ì»¤ì„œ ìˆ¨ê¹€ - í‚¤íŒ¨ë“œë¡œë§Œ ì…ë ¥ */
}
.ans-input.active-input { border-color: #667eea; background: #f8f9ff; }
.ans-input[disabled] { background: #fafafa; color: #333; cursor: default; }
.result-icon { font-size: 22px; min-width: 28px; text-align: center; }

/* â”€â”€ í‚¤íŒ¨ë“œ â”€â”€ */
#keypad-overlay {
  position: fixed; bottom: 0; left: 0; width: 100%; z-index: 100;
  background: #f0f0f0; border-top: 2px solid #ddd;
  padding: 6px 6px 10px; display: none;
  box-shadow: 0 -4px 12px rgba(0,0,0,.1);
}
#keypad-overlay.visible { display: block; }

.kp-topbar {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 6px; padding: 0 2px;
}
.keypad-tabs { display: flex; gap: 4px; flex-wrap: wrap; }
.kp-tab {
  padding: 5px 12px; border: 1px solid #ccc; border-radius: 20px;
  background: white; font-size: 12px; cursor: pointer; white-space: nowrap;
}
.kp-tab.active { background: #667eea; color: white; border-color: #667eea; }
.kp-close {
  padding: 5px 12px; border: 1px solid #ccc; border-radius: 6px;
  background: white; font-size: 13px; cursor: pointer;
}

/* ë¶„ìˆ˜ ë¯¸ë¦¬ë³´ê¸° */
#frac-preview {
  display: none; padding: 5px 10px; background: #fff8e1;
  border-radius: 6px; font-size: 13px; text-align: center; margin-bottom: 5px;
  border: 1px solid #ffe082;
}

.keypad-grid { display: none; grid-template-columns: repeat(5, 1fr); gap: 4px; }
.keypad-grid.active { display: grid; }
.keypad-grid.cols6  { grid-template-columns: repeat(6, 1fr); }

.kp-btn {
  padding: 10px 4px; background: white; border: 1px solid #ccc;
  border-radius: 8px; font-size: 15px; cursor: pointer; text-align: center;
  user-select: none; box-shadow: 0 2px 0 #bbb; transition: all .08s;
  line-height: 1.2;
}
.kp-btn:active { transform: translateY(1px); box-shadow: 0 1px 0 #bbb; background: #e8e8e8; }
.kp-btn.del  { background: #ffebee; color: #e53935; border-color: #ef9a9a; box-shadow: 0 2px 0 #ef9a9a; }
.kp-btn.done { background: #667eea; color: white; border-color: #5568d5; box-shadow: 0 2px 0 #5568d5; }
.kp-btn.sp   { background: #e0e0e0; font-size: 12px; box-shadow: 0 2px 0 #aaa; }
.kp-btn.shift-on { background: #fff3e0; border-color: #FF9800; }
.kp-btn.frac-confirm { background: #e8f5e9; border-color: #81c784; box-shadow: 0 2px 0 #81c784; color: #2e7d32; font-size:12px; }

/* ì±„ì  ë²„íŠ¼ */
#submit-bar {
  position: fixed; bottom: 0; left: 0; width: 100%;
  padding: 10px 16px 16px; background: white;
  border-top: 1px solid #eee; z-index: 90;
}
#submit-bar button {
  width: 100%; padding: 14px; font-size: 16px; font-weight: bold;
  background: linear-gradient(135deg, #667eea, #764ba2);
  color: white; border: none; border-radius: 10px; cursor: pointer;
}

/* ê²°ê³¼ í™”ë©´ */
#result-screen {
  display: none; max-width: 480px; margin: 0 auto;
  padding: 20px 16px 40px; text-align: center;
}
.score-circle {
  width: 130px; height: 130px; border-radius: 50%;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  margin: 0 auto 16px; box-shadow: 0 6px 20px rgba(102,126,234,.4);
}
.score-num   { font-size: 42px; font-weight: bold; color: white; line-height: 1; }
.score-label { font-size: 13px; color: rgba(255,255,255,.8); margin-top: 3px; }
.score-msg   { font-size: 20px; font-weight: bold; margin: 0 0 16px; }
.result-list { text-align: left; background: white; border-radius: 12px; padding: 4px 16px; margin-bottom: 16px; }
.result-row  { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; font-size: 14px; }
.result-row:last-child { border-bottom: none; }
.tag-ok { color: #4CAF50; font-weight: bold; }
.tag-ng { color: #f44336; font-weight: bold; }
.btn-retry {
  width: 100%; padding: 14px; font-size: 15px; background: #FF9800;
  color: white; border: none; border-radius: 10px; cursor: pointer; display: block;
}
#save-notice { font-size: 12px; color: #888; margin-top: 12px; min-height: 18px; line-height: 1.5; }
</style>
</head>
<body>

<div class="header">
  <h1 id="hTitle">ğŸ“ ìê°€ì±„ì </h1>
  <p  id="hSub">ë¡œë”© ì¤‘...</p>
</div>

<div id="loading" style="padding:60px 20px;text-align:center;color:#888;">
  <div style="font-size:40px;margin-bottom:12px;">â³</div>
  <div>ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
</div>
<div id="error" style="display:none;padding:60px 20px;text-align:center;color:#e53935;">
  <div style="font-size:40px;margin-bottom:12px;">âš ï¸</div>
  <div id="errorMsg">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>
  <div style="font-size:12px;color:#aaa;margin-top:8px;">URLì„ í™•ì¸í•˜ê±°ë‚˜ ì„ ìƒë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”.</div>
</div>

<div id="main" style="display:none;">
  <div class="problem-wrap" id="problemWrap"></div>
  <div id="submit-bar"><button onclick="submitAll()">âœ… ì±„ì í•˜ê¸°</button></div>
</div>

<div id="result-screen">
  <div class="score-circle">
    <div class="score-num"  id="rScore"></div>
    <div class="score-label" id="rTotal"></div>
  </div>
  <div class="score-msg" id="rMsg"></div>
  <div class="result-list" id="rList"></div>
  <button class="btn-retry" onclick="retryAll()">ğŸ”„ ë‹¤ì‹œ í’€ê¸°</button>
  <p id="save-notice"></p>
</div>

<!-- â•â• í‚¤íŒ¨ë“œ â•â• -->
<div id="keypad-overlay">
  <div class="kp-topbar">
    <div class="keypad-tabs">
      <button class="kp-tab active" onclick="switchTab('num',this)">ìˆ«ì</button>
      <button class="kp-tab"       onclick="switchTab('frac',this)">ë¶„ìˆ˜Â·ë£¨íŠ¸</button>
      <button class="kp-tab"       onclick="switchTab('sym',this)">ê¸°í˜¸</button>
      <button class="kp-tab"       onclick="switchTab('alpha',this)">ì˜ì–´</button>
    </div>
    <button class="kp-close" onclick="hideKeypad()">ì™„ë£Œ âœ“</button>
  </div>

  <div id="frac-preview"></div>

  <!-- ìˆ«ì íƒ­ -->
  <div class="keypad-grid active" id="tab-num">
    <button class="kp-btn" onclick="ins('7')">7</button>
    <button class="kp-btn" onclick="ins('8')">8</button>
    <button class="kp-btn" onclick="ins('9')">9</button>
    <button class="kp-btn sp" onclick="ins('+')">+</button>
    <button class="kp-btn del" onclick="kpDel()">âŒ«</button>

    <button class="kp-btn" onclick="ins('4')">4</button>
    <button class="kp-btn" onclick="ins('5')">5</button>
    <button class="kp-btn" onclick="ins('6')">6</button>
    <button class="kp-btn sp" onclick="ins('-')">âˆ’</button>
    <button class="kp-btn sp" onclick="ins('.')">.</button>

    <button class="kp-btn" onclick="ins('1')">1</button>
    <button class="kp-btn" onclick="ins('2')">2</button>
    <button class="kp-btn" onclick="ins('3')">3</button>
    <button class="kp-btn sp" onclick="ins('Ã—')">Ã—</button>
    <button class="kp-btn sp" onclick="ins('Ã·')">Ã·</button>

    <button class="kp-btn" onclick="ins('0')" style="grid-column:span 2">0</button>
    <button class="kp-btn sp" onclick="ins('(')"> ( </button>
    <button class="kp-btn sp" onclick="ins(')')"> ) </button>
    <button class="kp-btn done" onclick="hideKeypad()">í™•ì¸</button>
  </div>

  <!-- ë¶„ìˆ˜Â·ë£¨íŠ¸ íƒ­ -->
  <div class="keypad-grid" id="tab-frac">
    <!-- ë¶„ì/ë¶„ëª¨ ìˆ«ì ì…ë ¥ -->
    <button class="kp-btn" onclick="fracDigit('7')">7</button>
    <button class="kp-btn" onclick="fracDigit('8')">8</button>
    <button class="kp-btn" onclick="fracDigit('9')">9</button>
    <button class="kp-btn sp" onclick="fracMinus()">âˆ’</button>
    <button class="kp-btn del" onclick="fracDel()">âŒ«</button>

    <button class="kp-btn" onclick="fracDigit('4')">4</button>
    <button class="kp-btn" onclick="fracDigit('5')">5</button>
    <button class="kp-btn" onclick="fracDigit('6')">6</button>
    <!-- ë¶„ìˆ˜ì„  ë²„íŠ¼ -->
    <button class="kp-btn sp" id="btnFracLine" onclick="fracLine()" style="font-size:20px; font-weight:bold; line-height:1;">â€”<br><span style="font-size:9px;">ë¶„ìˆ˜ì„ </span></button>
    <button class="kp-btn frac-confirm" onclick="fracConfirm()">ì…ë ¥<br>âœ“</button>

    <button class="kp-btn" onclick="fracDigit('1')">1</button>
    <button class="kp-btn" onclick="fracDigit('2')">2</button>
    <button class="kp-btn" onclick="fracDigit('3')">3</button>
    <button class="kp-btn" onclick="fracDigit('0')">0</button>
    <button class="kp-btn sp" onclick="fracReset()" style="font-size:11px;">ì´ˆê¸°í™”</button>

    <!-- ë£¨íŠ¸ / ì§€ìˆ˜ -->
    <button class="kp-btn sp" onclick="ins('âˆš')">âˆš</button>
    <button class="kp-btn sp" onclick="ins('Â²')">xÂ²</button>
    <button class="kp-btn sp" onclick="ins('Â³')">xÂ³</button>
    <button class="kp-btn sp" onclick="ins('Ï€')">Ï€</button>
    <button class="kp-btn done" onclick="hideKeypad()">í™•ì¸</button>
  </div>

  <!-- ê¸°í˜¸ íƒ­ -->
  <div class="keypad-grid" id="tab-sym">
    <button class="kp-btn" onclick="ins('â‘ ')">â‘ </button>
    <button class="kp-btn" onclick="ins('â‘¡')">â‘¡</button>
    <button class="kp-btn" onclick="ins('â‘¢')">â‘¢</button>
    <button class="kp-btn" onclick="ins('â‘£')">â‘£</button>
    <button class="kp-btn" onclick="ins('â‘¤')">â‘¤</button>

    <button class="kp-btn sp" onclick="ins('x')">x</button>
    <button class="kp-btn sp" onclick="ins('y')">y</button>
    <button class="kp-btn sp" onclick="ins('n')">n</button>
    <button class="kp-btn sp" onclick="ins('k')">k</button>
    <button class="kp-btn del" onclick="kpDel()">âŒ«</button>

    <button class="kp-btn sp" onclick="ins('â‰¤')">â‰¤</button>
    <button class="kp-btn sp" onclick="ins('â‰¥')">â‰¥</button>
    <button class="kp-btn sp" onclick="ins('â‰ ')">â‰ </button>
    <button class="kp-btn sp" onclick="ins('âˆˆ')">âˆˆ</button>
    <button class="kp-btn sp" onclick="ins('âˆ')">âˆ</button>

    <button class="kp-btn sp" onclick="ins('{')">ï½›</button>
    <button class="kp-btn sp" onclick="ins('}')">ï½</button>
    <button class="kp-btn sp" onclick="ins(',')">ï¼Œ</button>
    <button class="kp-btn sp" onclick="ins('|')">ï½œ</button>
    <button class="kp-btn done" onclick="hideKeypad()">í™•ì¸</button>
  </div>

  <!-- ì˜ì–´ íƒ­ (6ì—´) -->
  <div class="keypad-grid cols6" id="tab-alpha">
    <button class="kp-btn" id="ab_q" onclick="insA('q')">q</button>
    <button class="kp-btn" id="ab_w" onclick="insA('w')">w</button>
    <button class="kp-btn" id="ab_e" onclick="insA('e')">e</button>
    <button class="kp-btn" id="ab_r" onclick="insA('r')">r</button>
    <button class="kp-btn" id="ab_t" onclick="insA('t')">t</button>
    <button class="kp-btn" id="ab_y" onclick="insA('y')">y</button>

    <button class="kp-btn" id="ab_u" onclick="insA('u')">u</button>
    <button class="kp-btn" id="ab_i" onclick="insA('i')">i</button>
    <button class="kp-btn" id="ab_o" onclick="insA('o')">o</button>
    <button class="kp-btn" id="ab_p" onclick="insA('p')">p</button>
    <button class="kp-btn" id="ab_a" onclick="insA('a')">a</button>
    <button class="kp-btn" id="ab_s" onclick="insA('s')">s</button>

    <button class="kp-btn" id="ab_d" onclick="insA('d')">d</button>
    <button class="kp-btn" id="ab_f" onclick="insA('f')">f</button>
    <button class="kp-btn" id="ab_g" onclick="insA('g')">g</button>
    <button class="kp-btn" id="ab_h" onclick="insA('h')">h</button>
    <button class="kp-btn" id="ab_j" onclick="insA('j')">j</button>
    <button class="kp-btn" id="ab_k" onclick="insA('k')">k</button>

    <button class="kp-btn" id="ab_l" onclick="insA('l')">l</button>
    <button class="kp-btn" id="ab_z" onclick="insA('z')">z</button>
    <button class="kp-btn" id="ab_x" onclick="insA('x')">x</button>
    <button class="kp-btn" id="ab_c" onclick="insA('c')">c</button>
    <button class="kp-btn" id="ab_v" onclick="insA('v')">v</button>
    <button class="kp-btn" id="ab_b" onclick="insA('b')">b</button>

    <button class="kp-btn" id="ab_n" onclick="insA('n')">n</button>
    <button class="kp-btn" id="ab_m" onclick="insA('m')">m</button>
    <button class="kp-btn sp shift-btn" id="shiftBtn" onclick="toggleShift()">â‡§</button>
    <button class="kp-btn del" onclick="kpDel()">âŒ«</button>
    <button class="kp-btn done" onclick="hideKeypad()" style="grid-column:span 2">í™•ì¸</button>
  </div>
</div>

<script>
// â”€â”€ ìƒíƒœ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let examData    = null;
let activeInput = null;
let isShift     = false;

// ë¶„ìˆ˜ ì…ë ¥ ìƒíƒœ
let fNumer = '';   // ë¶„ì
let fDenom = '';   // ë¶„ëª¨
let fStage = 'N';  // 'N'=ë¶„ì ì…ë ¥ ì¤‘, 'D'=ë¶„ëª¨ ì…ë ¥ ì¤‘

// â”€â”€ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function init() {
  const id = new URLSearchParams(location.search).get('id');
  if (!id) { showError('QR ì½”ë“œì— ë¬¸ì œ IDê°€ ì—†ìŠµë‹ˆë‹¤.'); return; }

  const base = location.href.replace(/\/grading\.html.*$/, '');
  try {
    const res = await fetch(base + '/answers/' + id + '.json');
    if (!res.ok) throw new Error('HTTP ' + res.status);
    examData = await res.json();
    examData._id = id;
    examData._base = base;
    renderProblems();
  } catch(e) {
    showError('ë¬¸ì œ íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><small>' + e.message + '</small>');
  }
})();

function showError(msg) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'block';
  document.getElementById('errorMsg').innerHTML = msg;
}

// â”€â”€ ë¬¸ì œ ë Œë”ë§ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderProblems() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('hTitle').textContent = 'ğŸ“ ' + examData.title;
  document.getElementById('hSub').textContent   = examData.student + ' | ' + (examData.date || '');

  const wrap = document.getElementById('problemWrap');
  wrap.innerHTML = '';
  examData.problems.forEach(p => {
    const d = document.createElement('div');
    d.className = 'card'; d.id = 'card_' + p.number;
    d.innerHTML = `<div class="card-num">ë¬¸ì œ ${p.number}ë²ˆ</div>
      <div class="input-row">
        <input class="ans-input" id="inp_${p.number}" readonly placeholder="íƒ­í•˜ì—¬ ë‹µ ì…ë ¥" autocomplete="off">
        <span class="result-icon" id="icon_${p.number}"></span>
      </div>`;
    d.querySelector('.ans-input').addEventListener('click', function(){ openKeypad(this); });
    wrap.appendChild(d);
  });
  document.getElementById('main').style.display = 'block';
}

// â”€â”€ í‚¤íŒ¨ë“œ ì—´ê¸°/ë‹«ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openKeypad(el) {
  activeInput = el;
  document.querySelectorAll('.ans-input').forEach(i => i.classList.remove('active-input'));
  el.classList.add('active-input');
  document.getElementById('keypad-overlay').classList.add('visible');
  document.getElementById('submit-bar').style.display = 'none';
  fracReset();
  setTimeout(() => el.closest('.card').scrollIntoView({behavior:'smooth', block:'center'}), 150);
}
function hideKeypad() {
  document.getElementById('keypad-overlay').classList.remove('visible');
  document.getElementById('submit-bar').style.display = 'block';
  if (activeInput) activeInput.classList.remove('active-input');
  activeInput = null;
  fracReset();
}

// íƒ­ ì „í™˜
function switchTab(tab, btn) {
  document.querySelectorAll('.keypad-grid').forEach(g => g.classList.remove('active'));
  document.querySelectorAll('.kp-tab').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  btn.classList.add('active');
  const fp = document.getElementById('frac-preview');
  if (tab === 'frac') { fp.style.display = 'block'; updateFracPreview(); }
  else { fp.style.display = 'none'; fracReset(); }
}

// â”€â”€ ì¼ë°˜ ë¬¸ì ì‚½ì… / ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ins(ch) {
  if (!activeInput) return;
  const p = activeInput.selectionStart ?? activeInput.value.length;
  const v = activeInput.value;
  activeInput.value = v.slice(0,p) + ch + v.slice(p);
  activeInput.setSelectionRange(p+ch.length, p+ch.length);
}
function kpDel() {
  if (!activeInput) return;
  const p = activeInput.selectionStart ?? activeInput.value.length;
  if (p===0) return;
  const v = activeInput.value;
  activeInput.value = v.slice(0,p-1) + v.slice(p);
  activeInput.setSelectionRange(p-1, p-1);
}

// â”€â”€ ì˜ì–´ íƒ­ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function insA(ch) { ins(isShift ? ch.toUpperCase() : ch); }
function toggleShift() {
  isShift = !isShift;
  const btn = document.getElementById('shiftBtn');
  btn.classList.toggle('shift-on', isShift);
  btn.textContent = isShift ? 'â‡§â†‘' : 'â‡§';
  'qwertyuiopasdfghjklzxcvbnm'.split('').forEach(c => {
    const el = document.getElementById('ab_' + c);
    if (el) el.textContent = isShift ? c.toUpperCase() : c;
  });
}

// â”€â”€ ë¶„ìˆ˜ ì…ë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// íë¦„: ë¶„ì ìˆ«ì ì…ë ¥ â†’ [ë¶„ìˆ˜ì„ ] â†’ ë¶„ëª¨ ìˆ«ì ì…ë ¥ â†’ [ì…ë ¥âœ“]
function fracDigit(d) {
  if (fStage === 'N') fNumer += d;
  else                fDenom += d;
  updateFracPreview();
}
function fracMinus() {
  // ë¶„ìê°€ ë¹„ì–´ìˆì„ ë•Œë§Œ ìŒìˆ˜ ë¶€í˜¸
  if (fStage === 'N' && fNumer === '') fNumer = '-';
  updateFracPreview();
}
function fracLine() {
  if (!fNumer) return;  // ë¶„ì ì—†ìœ¼ë©´ ë¬´ì‹œ
  fStage = 'D'; fDenom = '';
  updateFracPreview();
}
function fracConfirm() {
  if (!fNumer) return;
  ins(fDenom ? fNumer + '/' + fDenom : fNumer);
  fracReset();
}
function fracDel() {
  if (fStage === 'D') {
    if (fDenom.length > 0) fDenom = fDenom.slice(0,-1);
    else { fStage = 'N'; }   // ë¶„ëª¨ ë‹¤ ì§€ìš°ë©´ ë¶„ìë¡œ ëŒì•„ì˜´
  } else {
    fNumer = fNumer.slice(0,-1);
  }
  updateFracPreview();
}
function fracReset() {
  fNumer = ''; fDenom = ''; fStage = 'N';
  updateFracPreview();
}
function updateFracPreview() {
  const fp = document.getElementById('frac-preview');
  if (!document.getElementById('tab-frac').classList.contains('active')) return;
  if (!fNumer && !fDenom) {
    fp.innerHTML = '<span style="color:#aaa;">ìˆ«ì ì…ë ¥ í›„ ë¶„ìˆ˜ì„ (â€”) ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”</span>';
  } else if (fStage === 'N') {
    fp.innerHTML = 'ë¶„ì: <strong>' + (fNumer||'?') + '</strong> / ?  &nbsp;â†’ ë¶„ìˆ˜ì„  ë²„íŠ¼ ëˆ„ë¥´ì„¸ìš”';
  } else {
    fp.innerHTML = '<strong style="font-size:15px;">' + fNumer + ' / ' + (fDenom||'?') + '</strong>'
      + ' &nbsp;<span style="color:#888;font-size:11px;">â† ì…ë ¥âœ“ ë²„íŠ¼ìœ¼ë¡œ í™•ì •</span>';
  }
}

// í‚¤íŒ¨ë“œ ì™¸ë¶€ íƒ­ ì‹œ ë‹«ê¸°
document.addEventListener('click', function(e) {
  const kp = document.getElementById('keypad-overlay');
  if (!kp.classList.contains('visible')) return;
  if (kp.contains(e.target) || e.target.classList.contains('ans-input')) return;
  hideKeypad();
});

// â”€â”€ ì •ê·œí™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function norm(s) {
  if (!s && s !== 0) return '';
  return s.toString().trim().toLowerCase()
    .replace(/\s+/g, '')
    .replace(/Ã—/g,'*').replace(/Ã·/g,'/')
    .replace(/[ï¼ˆ(]/g,'(').replace(/[ï¼‰)]/g,')')
    .replace(/[ï¼Œ,]/g,',').replace(/ï¼/g,'-').replace(/ï¼‹/g,'+')
    .replace(/â‘ /g,'1').replace(/â‘¡/g,'2').replace(/â‘¢/g,'3')
    .replace(/â‘£/g,'4').replace(/â‘¤/g,'5');
}

// â”€â”€ ì±„ì  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function submitAll() {
  if (!examData) return;
  hideKeypad();

  let correct = 0;
  let listHTML = '';
  const resultData = [];

  examData.problems.forEach(p => {
    const inp  = document.getElementById('inp_'  + p.number);
    const card = document.getElementById('card_' + p.number);
    const icon = document.getElementById('icon_' + p.number);

    const userAns = inp ? inp.value.trim() : '';
    const corrAns = p.answer || '';
    const ok = corrAns && norm(userAns) === norm(corrAns);

    if (ok) correct++;
    card.className   = 'card ' + (ok ? 'correct' : 'wrong');
    icon.textContent = ok ? 'âœ…' : 'âŒ';
    if (inp) inp.disabled = true;

    // ì˜¤ë‹µ ì‹œ ì •ë‹µ í‘œì‹œ ì•ˆ í•¨ (ìŠ¤ìŠ¤ë¡œ ë‹¤ì‹œ í’€ê¸°)
    listHTML += `
      <div class="result-row">
        <span style="font-weight:bold;">${p.number}ë²ˆ</span>
        <span class="${ok ? 'tag-ok' : 'tag-ng'}">${ok ? 'âœ… ì •ë‹µ' : 'âŒ ì˜¤ë‹µ'}</span>
      </div>`;

    resultData.push({ number: p.number, userAnswer: userAns, correct: ok });
  });

  const total = examData.problems.length;
  const pct   = Math.round(correct / total * 100);
  document.getElementById('rScore').textContent = correct;
  document.getElementById('rTotal').textContent = '/ ' + total + 'ë¬¸ì œ';
  document.getElementById('rMsg').textContent   =
    pct >= 90 ? 'ğŸ‰ ì™„ë²½í•´ìš”!' :
    pct >= 70 ? 'ğŸ‘ ì˜í–ˆì–´ìš”!' :
    pct >= 50 ? 'ğŸ’ª ì¡°ê¸ˆ ë” ë…¸ë ¥í•´ë´ìš”!' : 'ğŸ˜Š ë‹¤ì‹œ ë„ì „í•´ë´ìš”!';
  document.getElementById('rList').innerHTML = listHTML;

  document.getElementById('main').style.display          = 'none';
  document.getElementById('submit-bar').style.display    = 'none';
  document.getElementById('result-screen').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});

  // ì±„ì  ê²°ê³¼ GitHub ì €ì¥
  saveResult(resultData, correct, total);
}

// â”€â”€ ì±„ì  ê²°ê³¼ GitHub ì €ì¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveResult(resultData, correct, total) {
  const notice = document.getElementById('save-notice');
  const token    = examData._token;
  const username = examData._username;
  const repo     = examData._repo;

  if (!token || !username || !repo) {
    notice.textContent = 'ì ìˆ˜ë¥¼ ì„ ìƒë‹˜ê»˜ ì•Œë ¤ì£¼ì„¸ìš”: ' + correct + '/' + total + 'ì  (' + Math.round(correct/total*100) + '%)';
    return;
  }

  notice.textContent = 'ğŸ“¤ ê²°ê³¼ ì €ì¥ ì¤‘...';

  const payload = {
    examId:   examData._id,
    title:    examData.title,
    student:  examData.student,
    date:     examData.date,
    gradedAt: new Date().toLocaleString('ko-KR'),
    score:    correct + '/' + total,
    pct:      Math.round(correct / total * 100),
    results:  resultData
  };

  try {
    const filename = 'results/' + examData._id + '_result.json';
    const content  = btoa(unescape(encodeURIComponent(JSON.stringify(payload, null, 2))));

    const res = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${filename}`, {
      method:  'PUT',
      headers: {
        'Authorization': 'token ' + token,
        'Accept': 'application/vnd.github.v3+json',
        'Content-Type':  'application/json'
      },
      body: JSON.stringify({ message: 'ì±„ì ê²°ê³¼|' + examData.student + '|' + correct + '/' + total, content })
    });

    if (res.ok) {
      notice.textContent = 'âœ… ì±„ì  ê²°ê³¼ê°€ ì„ ìƒë‹˜ê»˜ ìë™ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! (' + correct + '/' + total + 'ì )';
    } else {
      const err = await res.json();
      throw new Error(err.message || 'ì €ì¥ ì‹¤íŒ¨');
    }
  } catch(e) {
    notice.textContent = 'âš ï¸ ìë™ ì „ì†¡ ì‹¤íŒ¨. ì ìˆ˜ë¥¼ ì„ ìƒë‹˜ê»˜ ì§ì ‘ ì•Œë ¤ì£¼ì„¸ìš”: ' + correct + '/' + total + 'ì ';
  }
}

// â”€â”€ ë‹¤ì‹œ í’€ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function retryAll() {
  if (!examData) return;
  examData.problems.forEach(p => {
    const inp  = document.getElementById('inp_'  + p.number);
    const card = document.getElementById('card_' + p.number);
    const icon = document.getElementById('icon_' + p.number);
    if (inp)  { inp.value = ''; inp.disabled = false; }
    if (card) card.className = 'card';
    if (icon) icon.textContent = '';
  });
  document.getElementById('result-screen').style.display = 'none';
  document.getElementById('main').style.display          = 'block';
  document.getElementById('submit-bar').style.display    = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}
</script>
</body>
</html>
